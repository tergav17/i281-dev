; AS4.S
; ASSEMBLER SYMBOL MANAGEMENT
; GAVIN TERSTEEG, 2024
; SDMAY24-14

BI	= BI+1
.TEXT
.BANK	BI
SYM0_B	= BI

	; DEFINES OR UPDATES A SYMBOL IN THE TABLE
	; [TBUF] = SYMBOL NAME
	; [VALUE] = SYMBOL VALUE
DEFINE:	STORE	[SPARK],D

	; START BY SEARCHING THE SYMBOL TABLE FOR EXISTING SYMBOLS
	LOADI	D,ST_NAME
	LOADI	B,STAB_B
	STORE	[TEMP],B
	
	; DO NAME CHECK
0:	LOADI	C,0-8

	; CHECK ALL 8 VALUE
1:	ADDI	C,8
	LOADF	A,[C+TBUF]
	LOAD	B,[TEMP]
	STORE	[DBANK],B
	LOADF	B,[D]
	CMP	A,B
	BRNZ	2F
	LOAD 	A,0
	STORE	[DBANK],A
	ADDI	D,1
	SUBI	C,7
	BRNZ	1B
	
	; FOUND THE SYMBOL
	SUBI	D,8

	; SYMBOL DOES NOT MATCH
2:	SUB	D,C
	LOADF	A,[D]
	ADDI	A,0
	BRNZ	0F
	
	; EXIT SYMBOL ENTRY
	ADDI	D,20
	BRN	3F
	SUBI	D,10
	LOADI	A,0
	STORE	[DBANK],A
	JUMP	0B

	; NEXT BANK
3:	LOAD	A,[ST_NEXT]
	ADDI	A,0
	BRZ	4F
	STORE	[TEMP],A
	JUMP	0B
	
	; ALLOCATE A NEW BANK
4:	
	
	
	; EMPTY SLOT, PUT THE SYMBOL HERE
0:	
	
	
	



	; START OF SYMBOL TABLE
.BANK	BD
.DATA
STAB_B	= BD

	; SYMBOL TABLE DEFINITION
	; 0X00: NEXT BANK
	; 0X01-0X08: SYMBOL 0 NAME
	; 0X09-0X0A: SYMBOL 1 VALUE
	; 0X0B-0X13: SYMBOL 2 NAME
	; 0X14-0X15: SYMBOL 2 VALUE
	
	; IF A SYMBOL NAME STARTS WITH 0X00, IT IS UNALLOCATED

.DEFL BYTE ST_NEXT	0
.DEFL BYTE ST_NAME	0,0,0,0,0,0,0,0
.DEFL BYTE ST_VAL	0,0

BD	= BD+1

	; SET START OF HEAP
HEAP	= BD