; AS6.S
; ASSEMBLY INSTRUCTION GENERATION
; GAVIN TERSTEEG, 2024
; SDMAY24-14

BI	= BI+1
.TEXT
.BANK	BI
ISR0_B	= BI

	; OUTPUTS AN INSTRUCTION
	; FIRST, WE MUST FIND WHAT INSTRUCTION HAS BEEN SPECIFIED
DOISR:	LOADI	A,ITAB0_B
	LOADI	C,@+3
0:	STOREF	[D],C
	JUMP	CHKTAB
	ADDI	A,0
	BRNZ	1F
	LOADI	A,ITAB1_B
	LOADI	C,@+2
	JUMP	0B
	ADDI	A,0
	BRNZ	1F
	LOADI	A,ITAB2_B
	LOADI	C,@+2
	JUMP	0B
	ADDI	A,0
	BRNZ	1F
	
	; DIDN'T WORK :(
	LOADI	A,E_UXTOK
	LOADI	B,CORE0_B
	LOADI	C,ERROR
	JUMP	INDIR

	; FOUND IT!!!
1:	STORE	[TEMP],B
	LOADI	B,ISR1_B
	LOADI	C,DOISRA
	JUMP	INDIR

	; CHECK TABLE
	; A = TABLE TO CHECK
CHKTAB:	STORE	[SPARK],D
	STORE	[DBANK],A
	LOADI	B,ISRTAB0
0:	LOADI	A,0
1:	LOADF	C,[A]
	LOADF	D,[B]
	CMP	C,D
	BRNZ	2F
	ADDI	A,1
	ADDI	B,1
	ADDI	D,0
	BRNZ	1B
	
	; WE MATCH
	LOADF	A,[B]
	LOADF	B,[B+1]
	JUMP	4F
	
	; NO MATCH
	; FIND END OF ENTRY
2:	ADDI	D,0
	BRZ	3F
	ADDI	B,1
	LOADF	D,[B]
	JUMP	2B

	; SKIP TO NEXT ENTRY
3:	ADDI	B,3
	LOADF	D,[B]
	ADDI	D,0
	BRNZ	0B
	
	; INSTRUCTION NOT FOUND
	LOADI	A,0
	LOADI	B,0
	
	; RETURN
4:	LOADI	C,0
	STORE	[DBANK],C
	LOAD	D,[SPARK]
	LOADF	C,[D]
	JUMPR	C
	
	
BI	= BI+1
.TEXT
.BANK	BI
ISR1_B	= BI

	; USING INSTRUCTION TYPE, PROCESS INSTRUCTION
DOISRA:	LOAD	B,[TEMP]
	LOADI	C,BI
	STOREF	[D+1],C
	SUBI	A,BASIC
	BRNZ	5F

	; BASIC INSTRUCTION
	; JUST EMIT THE OPCODE
	STORE	[VALUE],B
	LOADI	A,0
	STORE	[VALUE+1],A
	LOADI	C,7F
IEMITA:	STOREF	[D],C		; SHORTCUT TO EMIT HERE
	LOADI	B,EMIT0_B
	LOADI	C,EMIT
	JUMP	INDIR
	
5:	SUBI	A,ARITH-BASIC
	BRNZ	5F

	

5:	

	; CONSUME NEXT TOKEN
6:	LOADI	C,@+5
INEXTA:	STOREF	[D],C		; SHORTCUT TO NEXT TOKEN HERE
	LOADI	B,TOK0_B
	LOADI	C,NEXTTOK
	JUMP	INDIR

	; THIS BETTER BE A NEWLINE
7:	LOAD	A,[TOKEN]
	ADDI	A,0
	BRZ	8F
	SUBI	A,NEWLINE
	BRZ	8F
	
	; NOPE 
	LOADI	A,E_UXTOK
	JUMP	9F
	
	; DO ANOTHER LINE
8:	LOADI	B,MAIN0_B
	LOADI	C,ASMLINE
	JUMP	INDIR
	
	; ERROR STUB
9:	LOADI	B,CORE0_B
	LOADI	C,ERROR
	JUMP	INDIR