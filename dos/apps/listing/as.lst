00/00:          ; DOSDEF.S
01/80:          ; THIS FILE CONTAINS IMPORTANT DEFINES USED IN DOS/281
01/80:          ; GAVIN TERSTEEG, 2024
01/80:          ; SDMAY24-14
01/80:          
01/80:          ; BIOS CALLS
01/80:          BOOT	= 0
01/80:          ALTBOOT = 1
01/80:          INDIR	= 2
01/80:          IRET	= 3
01/80:          SYSCALL	= 4
01/80:          SYSJUMP	= 5
01/80:          PRGM	= 6
01/80:          IWRITE	= 7
01/80:          ZSTART	= 8
01/80:          
01/80:          HALT	= 0X7F
01/80:          
01/80:          ; SYSTEM CALLS
01/80:          S_EXIT	= 0
01/80:          S_PUTC	= 1
01/80:          S_GETC	= 2
01/80:          S_STAT	= 3
01/80:          S_PUTS	= 4
01/80:          S_INPUT	= 5
01/80:          S_OPEN	= 6
01/80:          S_CLOSE	= 7
01/80:          S_READ	= 8
01/80:          S_WRITE	= 9
01/80:          S_FSRCH	= 10
01/80:          S_NEXT	= 11
01/80:          S_DELET	= 12
01/80:          S_CREAT	= 13
01/80:          S_FREE	= 14
01/80:          S_EXEC	= 15
01/80:          
01/80:          ; MEMORY AREAS
01/80:          CF_NAME	= 0X60
01/80:          CF_SIZE	= 0X68
01/80:          CF_USR	= 0X6A
01/80:          DFT_USR	= 0X6B
01/80:          ARG_BNK	= 0X6C
01/80:          BD_FREE	= 0X6E
01/80:          MAX_IB	= 0X70
01/80:          MAX_DB	= 0X71
01/80:          CMDL_B	= 0X72
01/80:          AUTO_B	= 0X73
01/80:          KERNMEM	= 0X78
01/80:          BIOSMEM	= 0X7C
01/80:          AU_RUN	= 0X00
01/80:          AU_PNTR	= 0X01
01/80:          AU_BANK	= 0X02
01/80:          AU_BLK	= 0X03
01/80:          AU_UA	= 0X04
01/80:          AU_FILE	= 0X06
01/80:          AU_MISC	= 0X18
01/80:          
01/80:          ; DATA BANK ADDRESS
01/80:          DBANK	= 0X80		
01/80:          
01/80:          
01/80:          ; AS0.S
01/80:          ; ASSEMBLER CORE
01/80:          ; GAVIN TERSTEEG, 2024
01/80:          ; SDMAY24-14
01/80:          
01/80:          ; BANK ALLOCATION STUFF
01/80:          BI	= 1
01/80:          BD	= 1
01/80:          
01/80:          ; MAXIMUM ARGUMENTS
01/80:          MAXARGS	= 15
01/80:          
01/80:          .TEXT
01/80:          .BANK	BI
01/80:          CORE0_B	= BI
01/80:          
01/80:          	; START BY PROCESSING THE ARGUMENTS
01/80: 3000     START:	LOADI	A,0
01/81: A080     	STORE	[DBANK],A
01/83:          	
01/82:          	; RESET ARG STATE
01/82: A000     	STORE	[ARGC],A
01/83: A011     	STORE	[LFLAG],A
01/85:          	
01/84:          	; SET UP STACK
01/84: 3C5E     	LOADI	D,0X60-2
01/86:          	
01/85:          	; SYSCALL RETURN BANK
01/85: 3801     	LOADI	C,BI
01/86: BB01     	STOREF	[D+1],C
01/88:          	
01/87:          	; SET UP POINTER
01/87: 3800     	LOADI	C,0
01/89:          	
01/88:          	; GO TO ARGUMENT BANK
01/88: 8072     0:	LOAD	A,[CMDL_B]
01/89: A06C     	STORE	[ARG_BNK],A
01/8A: A080     	STORE	[DBANK],A
01/8C:          
01/8B:          	; SKIP THE CURRENT ARGUMENT
01/8B: 9200     1:	LOADF	A,[C]
01/8C: 3420     	LOADI	B,0X20
01/8D: D100     	CMP	A,B
01/8E: F902     	BRBE	2F
01/8F: 5801     	ADDI	C,1
01/90: FFFA     	JUMP	1B
01/92:          
01/91:          	; LOOK FOR AN ARGUMENT
01/91: 9200     2:	LOADF	A,[C]
01/92: 5000     	ADDI	A,0
01/93: F630     	BRZ	ARGDONE
01/94: D100     	CMP	A,B
01/95: F802     	BRA	3F
01/96: 5801     	ADDI	C,1
01/97: FFF9     	JUMP	2B
01/99:          
01/98:          	; IS IT A FLAG?
01/98: 342D     3:	LOADI	B,'-'
01/99: D100     	CMP	A,B
01/9A: F714     	BRNZ	5F
01/9C:          	
01/9B:          	; HANDLE FLAGS HERE	
01/9B: 5801     4:	ADDI	C,1
01/9C: 9200     	LOADF	A,[C]
01/9D: 5000     	ADDI	A,0
01/9E: F625     	BRZ	ARGDONE
01/9F: 3420     	LOADI	B,0X20
01/A0: D100     	CMP	A,B
01/A1: F9EF     	BRBE	2B
01/A3:          	
01/A2:          	; REGISTER THE FLAG
01/A2: 3400     	LOADI	B,0
01/A3: A480     	STORE	[DBANK],B
01/A5:          	
01/A4: 704C     	SUBI	A,'L'
01/A5: F701     	BRNZ	@+2
01/A6: 3411     	LOADI	B,LFLAG
01/A8:          	
01/A7:          	; IS IT A RECOGNIZED FLAG?
01/A7: 5400     	ADDI	B,0
01/A8: F60F     	BRZ	ARGBAD
01/A9: 3001     	LOADI	A,1
01/AA: B100     	STOREF	[B],A
01/AC:          
01/AB:          	; THERE MAY BE ANOTHER FLAG
01/AB: 8472     	LOAD	B,[CMDL_B]
01/AC: A46C     	STORE	[ARG_BNK],B
01/AD: A480     	STORE	[DBANK],B
01/AE: FFEC     	JUMP	4B
01/B0:          
01/AF:          	; SAVE THE ARGUMENT
01/AF: 3400     5:	LOADI	B,0
01/B0: A480     	STORE	[DBANK],B
01/B1: 8400     	LOAD	B,[ARGC]
01/B2: B901     	STOREF	[B+ARGV],C
01/B4:          	
01/B3:          	; DID WE EXCEED THE ALLOWED NUMBER OF ARGUMENTS
01/B3: 740F     	SUBI	B,MAXARGS
01/B4: F003     	BRC	ARGBAD
01/B5: 5410     	ADDI	B,MAXARGS+1
01/B6: A400     	STORE	[ARGC],B
01/B7: FFD0     	JUMP	0B
01/B9:          	
01/B8:          	; BAD ARGUMENT
01/B8: 3000     ARGBAD:	LOADI	A,0
01/B9: A080     	STORE	[DBANK],A
01/BB:          	
01/BA: 3001     	LOADI	A,ERR0_B
01/BB: A06C     	STORE	[ARG_BNK],A
01/BC: 3000     	LOADI	A,ERROR00
01/BE:          	
01/BD:          	; PRINT ERROR MESSAGE
01/BD: 3801     PRNTERR:LOADI	C,BI
01/BE: BB01     	STOREF	[D+1],C
01/BF: 3404     	LOADI	B,S_PUTS
01/C0: 38CE     	LOADI	C,EXIT
01/C1: FF42     	JUMP	SYSCALL	
01/C3:          
01/C2:          	; EXIT PROGRAM
01/C2: 3400     EXIT:	LOADI	B,0
01/C3: FF41     	JUMP	SYSJUMP
01/C5:          	
01/C4:          	; ARGUMENT PROCESSING DONE
01/C4: 3000     ARGDONE:LOADI	A,0
01/C5: A080     	STORE	[DBANK],A
01/C7:          	
01/C6:          	; CHECK ARG COUNT
01/C6: 8000     	LOAD	A,[ARGC]
01/C7: 5000     	ADDI	A,0
01/C8: F6EF     	BRZ	ARGBAD
01/CA:          	
01/C9:          	; RESET PASS TO FIRST
01/C9: 3000     	LOADI	A,0
01/CA: A045     	STORE	[PASS],A
01/CC:          	
01/CB:          	; BEGIN ASSEMBLY
01/CB: 3402     	LOADI	B,CORE1_B
01/CC: 3880     	LOADI	C,DOPASS
01/CD: FF34     	JUMP	INDIR
01/CF:          
01/CE:          	; EXIT PROGRAM
01/CE: 3400     EXIT:	LOADI	B,S_EXIT
01/CF: FF35     	JUMP	SYSJUMP
01/D1:          	
01/D0:          	; DO AN ERROR
01/D0:          	; A = ERROR #
01/D0:          ERRNO	= OPERAND
01/D0: 3400     ERROR:	LOADI	B,0
01/D1: A480     	STORE	[DBANK],B
01/D2: A016     	STORE	[ERRNO],A
01/D3: 3403     	LOADI	B,PRNT0_B
01/D4: 3880     	LOADI	C,PERHEAD
01/D5: FF2C     	JUMP	INDIR
01/D7:          	
01/D6:          BI	= BI+1
01/D6:          .TEXT
01/D6:          .BANK	BI
02/80:          CORE1_B	= BI
02/80:          
02/80:          	; START A PASS
02/80:          	; BEGIN BY REWINDING THE SOURCE STREAM
02/80: 3802     DOPASS:	LOADI	C,BI
02/81: BB01     	STOREF	[D+1],C
02/82: 3887     	LOADI	C,@+5
02/83: BB00     	STOREF	[D],C
02/84: 3404     	LOADI	B,TOK0_B
02/85: 388A     	LOADI	C,REWIND
02/86: FF7B     	JUMP	INDIR
02/88:          
02/87:          	; TAKE IN A NEW LINE OF SOURCE CODE
02/87: 3802     ASMLINE:LOADI	C,BI
02/88: BB01     	STOREF	[D+1],C
02/89: 388E     	LOADI	C,@+5
02/8A: BB00     	STOREF	[D],C
02/8B: 3404     	LOADI	B,TOK0_B
02/8C: 3880     	LOADI	C,NEXTTOK
02/8D: FF74     	JUMP	INDIR
02/8F:          	
02/8E:          	; ARE WE AT THE END?
02/8E: 8030     	LOAD	A,[TOKEN]
02/8F: 5000     	ADDI	A,0
02/90: F60A     	BRZ	ASMDONE
02/92:          	
02/91:          	; IS IT NUMERIC?
02/91: 7081     	SUBI	A,NUMERIC
02/92: F7F4     	BRNZ	ASMLINE
02/94:          	
02/93:          	; ATTEMPT TO PARSE NUMBER
02/93: 3898     	LOADI	C,@+5
02/94: BB00     	STOREF	[D],C
02/95: 3406     	LOADI	B,EXP0_B
02/96: 3880     	LOADI	C,PARSEX
02/97: FF6A     	JUMP	INDIR
02/99:          	
02/98: 8414     	LOAD	B,[VALUE]
02/99: 8815     	LOAD	C,[VALUE+1]
02/9B:          ;	JUMP	@
02/9A:          	
02/9A: FFEC     	JUMP	ASMLINE
02/9C:          
02/9B:          	; ALL DONE
02/9B: 3401     ASMDONE:LOADI	B,CORE0_B
02/9C: 38CE     	LOADI	C,EXIT
02/9D: FF64     	JUMP	INDIR
02/9F:          
02/9E:          BI	= BI+1
02/9E:          .TEXT
02/9E:          .BANK	BI
03/80:          PRNT0_B	= BI
03/80:          
03/80:          	; PRINTS THE ERROR HEADER
03/80:          	; THE CURRENTLY OPEN FILE AND LINE NUMBER WILL BE PRINTED
03/80:          	; FORMAT: '[FILE]:[LINE]: ERROR'
03/80: 3803     PERHEAD:LOADI	C,BI
03/81: BB01     	STOREF	[D+1],C
03/83:          	
03/82:          	; PRINT CURRENTLY OPEN FILE
03/82: 8048     	LOAD	A,[CURRFIL]
03/83: 9001     	LOADF	A,[A+ARGV]
03/85:          
03/84:          	; PRINT LOOP
03/84: A039     0:	STORE	[BUFPNTR],A
03/85: 8472     	LOAD	B,[CMDL_B]
03/86: A480     	STORE	[DBANK],B
03/87: 9000     	LOADF	A,[A]
03/88: 3400     	LOADI	B,0
03/89: A480     	STORE	[DBANK],B
03/8A: 3420     	LOADI	B,0X20
03/8B: D100     	CMP	A,B
03/8C: F906     	BRBE	1F
03/8D: 3401     	LOADI	B,S_PUTC
03/8E: 3890     	LOADI	C,@+2
03/8F: FF74     	JUMP	SYSCALL
03/90: 8039     	LOAD	A,[BUFPNTR]
03/91: 5001     	ADDI	A,1
03/92: FFF1     	JUMP	0B
03/94:          	
03/93:          	; PRINT ':'
03/93: 303A     1:	LOADI	A,':'
03/94: 3401     	LOADI	B,S_PUTC
03/95: 3897     	LOADI	C,@+2
03/96: FF6D     	JUMP	SYSCALL
03/98:          	
03/97:          	; PRINT LINE NUMBER
03/97: 8046     	LOAD	A,[LINENUM]
03/98: A014     	STORE	[VALUE],A
03/99: 8047     	LOAD	A,[LINENUM+1]
03/9A: A015     	STORE	[VALUE+1],A
03/9B: 389E     	LOADI	C,@+3
03/9C: BB00     	STOREF	[D],C
03/9D: FF16     	JUMP	PRINTD
03/9F:          	
03/9E:          	; PRINT ':' + SPACE
03/9E: 303A     	LOADI	A,':'
03/9F: 3401     	LOADI	B,S_PUTC
03/A0: 38A2     	LOADI	C,@+2
03/A1: FF62     	JUMP	SYSCALL
03/A2: 3020     	LOADI	A,0X20
03/A3: 3401     	LOADI	B,S_PUTC
03/A4: 38A6     	LOADI	C,@+2
03/A5: FF5E     	JUMP	SYSCALL
03/A7:          	
03/A6:          	; LOOKUP ERROR ON TABLE
03/A6: 8016     	LOAD	A,[ERRNO]
03/A7: 7080     	SUBI	A,0X80
03/A8: 4000     	SHIFTL	A
03/A9: 5034     	ADDI	A,ETABLE
03/AA: 3801     	LOADI	C,ERR0_B
03/AB: A880     	STORE	[DBANK],C
03/AC: 9400     	LOADF	B,[A]
03/AD: 9001     	LOADF	A,[A+1]
03/AE: 3800     	LOADI	C,0
03/AF: A880     	STORE	[DBANK],C
03/B0: A46C     	STORE	[ARG_BNK],B
03/B1: 3401     	LOADI	B,CORE0_B
03/B2: 38BD     	LOADI	C,PRNTERR
03/B3: FF4E     	JUMP	INDIR
03/B5:          	
03/B4:          
03/B4:          	; PRINTS VARIABLE [VALUE] AS A 16 BIT BASE-10 NUMBER
03/B4:          PADDING	= TEMP
03/B4:          LEAFRET	= TEMP+1
03/B4: 7C02     PRINTD: SUBI	D,2
03/B6:          	
03/B5:          	; SET PADDING TO NULL CHARACTER AT FIRST
03/B5: 3800     	LOADI	C,0
03/B6: A818     	STORE	[PADDING],C
03/B8:          	
03/B7:          V	= 10000
03/B7: 3027     	LOADI	A,V/256
03/B8: 3410     	LOADI	B,V%256
03/B9: 38BB     	LOADI	C,@+2
03/BA: FF14     	JUMP	DOCHAR
03/BC:          	
03/BB:          V	= 1000
03/BB: 3003     	LOADI	A,V/256
03/BC: 34E8     	LOADI	B,V%256
03/BD: 38BF     	LOADI	C,@+2
03/BE: FF10     	JUMP	DOCHAR
03/C0:          	
03/BF:          V	= 100
03/BF: 3000     	LOADI	A,V/256
03/C0: 3464     	LOADI	B,V%256
03/C1: 38C3     	LOADI	C,@+2
03/C2: FF0C     	JUMP	DOCHAR
03/C4:          	
03/C3:          V	= 10
03/C3: 3000     	LOADI	A,V/256
03/C4: 340A     	LOADI	B,V%256
03/C5: 38C7     	LOADI	C,@+2
03/C6: FF08     	JUMP	DOCHAR
03/C8:          	
03/C7: 3030     	LOADI	A,'0'
03/C8: A018     	STORE	[PADDING],A
03/CA:          	
03/C9:          V	= 1
03/C9: 3000     	LOADI	A,V/256
03/CA: 3401     	LOADI	B,V%256
03/CB: 38CD     	LOADI	C,@+2
03/CC: FF02     	JUMP	DOCHAR
03/CE:          	
03/CD: 5C02     	ADDI	D,2 
03/CE: FF34     	JUMP	IRET
03/D0:          	
03/CF:          	; A = UPPER SUB
03/CF:          	; B = LOWER SUB
03/CF: A819     DOCHAR:	STORE	[LEAFRET],C
03/D0: 8818     	LOAD	C,[PADDING]	
03/D1: A813     	STORE	[CHAR],C
03/D3:          	
03/D2:          	; PARK THE STACK
03/D2: AC12     	STORE	[SPARK],D
03/D4:          
03/D3:          	; GET THE SIZE
03/D3: 8814     0:	LOAD	C,[VALUE]
03/D4: 8C15     	LOAD	D,[VALUE+1]
03/D6:          	
03/D5:          	; DO 16 BIT SUBTRACTION
03/D5: 6D00     1:	SUB	D,B
03/D6: F002     	BRC	2F
03/D7: 7801     	SUBI	C,1
03/D8: F10D     	BRNC	4F
03/D9: 6800     2:	SUB	C,A
03/DA: F10B     	BRNC	4F
03/DC:          	
03/DB:          	; SAVE VALUE
03/DB: A814     	STORE	[VALUE],C
03/DC: AC15     	STORE	[VALUE+1],D
03/DE:          	
03/DD:          	; GET THE CHAR AND CHECK TO SEE IF IT IS A WHITESPACE
03/DD: 8813     	LOAD	C,[CHAR]
03/DE: 3C20     	LOADI	D,0X20
03/DF: DB00     	CMP	C,D
03/E0: F802     	BRA	3F
03/E2:          	
03/E1:          	; SET PADDING AND CHAR TO '0'
03/E1: 3830     	LOADI	C,'0'
03/E2: A818     	STORE	[PADDING],C
03/E4:          	
03/E3: 5801     3:	ADDI	C,1
03/E4: A813     	STORE	[CHAR],C
03/E5: FFED     	JUMP	0B
03/E7:          	
03/E6:          	; RESTORE THE STACK
03/E6: 8C12     4:	LOAD	D,[SPARK]
03/E8:          	
03/E7:          	; SEE IF IT IS ZERO
03/E7: 8013     	LOAD	A,[CHAR]
03/E8: 5000     	ADDI	A,0
03/E9: F702     	BRNZ	5F
03/EA: 8819     	LOAD	C,[LEAFRET]
03/EB: FE14     	JUMPR	C
03/ED:          	
03/EC:          	; PRINT THE CHARACTER
03/EC: 3401     5:	LOADI	B,S_PUTC
03/ED: 3803     	LOADI	C,BI
03/EE: BB01     	STOREF	[D+1],C
03/EF: 8819     	LOAD	C,[LEAFRET]
03/F0: FF13     	JUMP	SYSCALL
03/F2:          
03/F1:          
03/F1:          	; ZERO BANK VARIABLES
03/F1:          .BANK	0
00/80:          .BSS
00/80:          
00/00:          	; COMMAND LINE ARGUMENTS
00/00: 00       .DEFL BYTE ARGC		0
00/01: 00000000
       00000000 .DEFL BYTE ARGV		0,0,0,0,0,0,0,0,
00/09: 00000000
       00000000 			0,0,0,0,0,0,0,0
00/11:          
00/11:          	; COMMAND LINE FLAGS
00/11: 00       .DEFL BYTE LFLAG	0
00/12:          
00/12:          	; VARIOUS MISC VARIABLES
00/12:          	; TO BE USED IN LEAF-FUNCTIONS
00/12: 00       .DEFL BYTE SPARK	0
00/13: 00       .DEFL BYTE CHAR		0
00/14:          
00/14:          	; 16 BIT MATH STUFF
00/14: 0000     .DEFL WORD VALUE	0
00/16: 0000     .DEFL WORD OPERAND	0
00/18: 0000     .DEFL WORD TEMP		0
00/1A:          
00/1A:          	; EXPRESSION PARSING STUFF
00/1A: 00000000
       00000000
       0000     .DEFL WORD ESTACK	0,0,0,0,0
00/24: 00000000
       00000000
       0000     .DEFL WORD VSTACK	0,0,0,0,0
00/2E: 00       .DEFL BYTE EINDEX	0
00/2F: 00       .DEFL BYTE VINDEX	0
00/30:          STACKSZ	= 5
00/30:          
00/30:          	; LATEST TOKEN
00/30: 00       .DEFL BYTE TOKEN	0
00/31:          
00/31:          	; TOKEN STREAM STATE
00/31: 00       .DEFL BYTE SRCINDX	0
00/32: 00       .DEFL BYTE SRCBLK	0
00/33: 00       .DEFL BYTE SRCBANK	0
00/34: 00       .DEFL BYTE SRCPNTR	0
00/35: 00       .DEFL BYTE SRCSTAT	0
00/36: 00       .DEFL BYTE SRCCHAR	0
00/37: 0000     .DEFL WORD SRCLINE	0
00/39:          
00/39:          	; TOKEN BUFFER
00/39: 00       .DEFL BYTE BUFPNTR	0
00/3A: 00000000
       00000000
       0000     .DEFL BYTE TBUF		0,0,0,0,0,0,0,0,0,0
00/44: 00       .DEFL BYTE TBUFEND	0
00/45:          	
00/45:          	; ASSEMBLY STATE
00/45: 00       .DEFL BYTE PASS		0
00/46: 0000     .DEFL WORD LINENUM	0
00/48: 00       .DEFL BYTE CURRFIL	0
00/49:          
00/49:          	; ERROR BANK 0
00/49:          .BANK	BD
01/00:          .DATA
01/00:          ERR0_B	= BD
01/00:          
01/00:          	; INVALID ARGUMENTS
01/00: 494E5641
       4C494420
       41524755
       4D454E54
       530A0D   .DEFL BYTE ERROR00	"INVALID ARGUMENTS",0X0A,0X0D,
01/13: 55534147
       453A2041
       53205B2D
       4C5D2046
       494C4531
       2046494C
       4532202E
       2E2E0A0D
       00       			"USAGE: AS [-L] FILE1 FILE2 ...",0X0A,0X0D,0
01/34:          
01/34:          	; ERROR TABLE
01/34: 0200     .DEFL BYTE ETABLE	ERR1_B,ERROR10,	; ERROR 0X80: CANNOT OPEN FILE 
01/36: 0212     			ERR1_B,ERROR11,	; ERROR 0X81: UNEXPECTED CHAR IN NUMERIC
01/38: 022F     			ERR1_B,ERROR12,	; ERROR 0X82: UNDEFINED EXPRESSION
01/3A: 0246     			ERR1_B,ERROR13,	; ERROR 0X83: UNEXPECTED TOKEN
01/3C: 0259     			ERR1_B,ERROR14,	; ERROR 0X84: VALUE STACK OVERFLOW
01/3E: 0300     			ERR2_B,ERROR20,	; ERROR 0X85: EXPRESSION STACK OVERFLOW
01/40: 031C     			ERR2_B,ERROR21,	; ERROR 0X86: EXPRESSION STACK DEPLETION
01/42: 0334     			ERR2_B,ERROR22	; ERROR 0X87: VALUE STACK DEPLETION
01/44:          	; ERROR VALUES
01/44:          E_COPEN	= 0X80
01/44:          E_UXNUM	= 0X81
01/44:          E_UDEFX = 0X82
01/44:          E_UXTOK	= 0X83
01/44:          E_VSTKO = 0X84
01/44:          E_ESTKO = 0X85
01/44:          E_VSTKD	= 0X86
01/44:          E_ESTKD = 0X87
01/44:          
01/44:          BD	= BD+1	
01/44:          	
01/44:          	; ERROR BANK 1
01/44:          .BANK	BD
02/00:          .DATA
02/00:          ERR1_B	= BD
02/00:          
02/00: 43414E27
       54204F50
       454E2046
       494C450A
       0D00     .DEFL BYTE ERROR10	"CAN'T OPEN FILE",0X0A,0X0D,0
02/12: 554E4558
       50454354
       45442043
       48415220
       494E204E
       554D4552
       49430A0D
       00       .DEFL BYTE ERROR11	"UNEXPECTED CHAR IN NUMERIC",0X0A,0X0D,0
02/2F: 554E4445
       46494E45
       44204558
       50524553
       53494F4E
       0A0D00   .DEFL BYTE ERROR12	"UNDEFINED EXPRESSION",0X0A,0X0D,0
02/46: 554E4558
       50454354
       45442054
       4F4B454E
       0A0D00   .DEFL BYTE ERROR13	"UNEXPECTED TOKEN",0X0A,0X0D,0
02/59: 56414C55
       45205354
       41434B20
       4F564552
       464C4F57
       0A0D00   .DEFL BYTE ERROR14	"VALUE STACK OVERFLOW",0X0A,0X0D,0
02/70:          
02/70:          
02/70:          BD	= BD+1
02/70:          
02/70:          	; ERROR BANK 2
02/70:          .BANK	BD
03/00:          .DATA
03/00:          ERR2_B	= BD
03/00:          
03/00: 45585052
       45535349
       4F4E2053
       5441434B
       204F5645
       52464C4F
       570A0D00 .DEFL BYTE ERROR20	"EXPRESSION STACK OVERFLOW",0X0A,0X0D,0
03/1C: 56414C55
       45205354
       41434B20
       4445504C
       4554494F
       4E0A0D00 .DEFL BYTE ERROR21	"VALUE STACK DEPLETION",0X0A,0X0D,0
03/34: 45585052
       45535349
       4F4E2053
       5441434B
       20444550
       4C455449
       4F4E0A0D
       00       .DEFL BYTE ERROR22	"EXPRESSION STACK DEPLETION",0X0A,0X0D,0
03/51:          
03/51:          BD	= BD+1
03/51:          
03/51:          	; SOURCE READ BUFFER
03/51:          .BANK	BD
04/00:          .DATA
04/00:          SRC_B	= BD
04/00:          
04/00:          BD	= BD+4
04/00:          ; AS1.S
04/00:          ; SOURCE INPUT AND TOKENIZER
04/00:          ; GAVIN TERSTEEG, 2024
04/00:          ; SDMAY24-14
04/00:          
04/00:          ; NEW LINE CHARACTER
04/00:          NEWLINE	= 0X0A
04/00:          SEMICOL	= 0X3B
04/00:          SQUOTE	= 0X27
04/00:          DQUOTE	= 0X22
04/00:          SYMBOL	= 0X80
04/00:          NUMERIC	= 0X81
04/00:          
04/00:          
04/00:          BI	= BI+1
04/00:          .TEXT
04/80:          .BANK	BI
04/80:          TOK0_B	= BI
04/80:          
04/80:          	; GETS THE NEXT TOKEN
04/80:          	; TOKEN TYPE IS RETURNED IN [TOKEN]
04/80:          	; SPECIAL TYPES ARE:
04/80:          	; 'A' -> ALPHANUMERIC
04/80:          	; '0' -> NUMERIC
04/80:          	; NEWLINE -> NEW LINE
04/80:          	; ALL WHITESPACE IS IGNORED, UNLESS WE ARE INSIDE
04/80:          	; A STRING OR DEFINED CHAR
04/80:          	; 'A' AND '0' TOKENS WILL POPULATE THE TOKEN BUFFER
04/80:          	; AS WELL
04/80: 7C02     NEXTTOK:SUBI	D,2
04/82:          
04/81:          	; STORE RETURN ADDRESS
04/81: 3405     	LOADI	B,TOK1_B
04/82: B701     	STOREF	[D+1],B
04/84:          	
04/83:          	; CHECK SRCSTAT
04/83: 388B     	LOADI	C,NEXTTOB
04/84: 8035     	LOAD	A,[SRCSTAT]
04/85: 5001     	ADDI	A,1
04/86: F77B     	BRNZ	INDIR
04/87: A035     	STORE	[SRCSTAT],A
04/89:          	
04/88: 3880     	LOADI	C,NEXTTOA
04/89: FF78     	JUMP	INDIR
04/8B:          
04/8A:          	; RESETS THE STATE OF THE TOKEN STREAM BACK TO
04/8A:          	; BEGINNING OF SOURCE INPUT
04/8A: 30FF     REWIND:	LOADI	A,0-1
04/8B: A031     	STORE	[SRCINDX],A
04/8D:          	
04/8C:          	; SET FIRST CHAR AS INVALID
04/8C: 3080     	LOADI	A,0X80
04/8D: A036     	STORE	[SRCCHAR],A
04/8F:          	
04/8E:          	; RESET STAT
04/8E: 30FF     	LOADI	A,0XFF
04/8F: A035     	STORE	[SRCSTAT],A
04/91:          	
04/90:          	; GET THE NEXT FILE
04/90:          	; ALL POINTERS WILL BE RESET FOR FILE READ IN
04/90:          	; SRCINDX == ARGC IF WE ARE DONE READING IN BLOCK
04/90: 7C02     NEXTSRC:SUBI	D,2
04/92:          
04/91:          	; RESET POINTER, BLOCK, AND SRCLINE
04/91: 3000     	LOADI	A,0
04/92: A034     	STORE	[SRCPNTR],A
04/93: A032     	STORE	[SRCBLK],A
04/94: A037     	STORE	[SRCLINE],A
04/95: A038     	STORE	[SRCLINE+1],A
04/97:          	
04/96:          	; RESET BANK
04/96: 3004     	LOADI	A,SRC_B
04/97: A033     	STORE	[SRCBANK],A
04/99:          
04/98:          	; INCREMENT SOURCE INDEX
04/98: 8031     0:	LOAD	A,[SRCINDX]
04/99: 5001     	ADDI	A,1
04/9A: A031     	STORE	[SRCINDX],A
04/9C:          
04/9B:          	; CHECK BOUNDS OF INDEX
04/9B: 8400     	LOAD	B,[ARGC]
04/9C: D100     	CMP	A,B
04/9D: F01C     	BRAE	9F
04/9F:          	
04/9E:          	; ATTEMPT TO OPEN FILE
04/9E: 8472     	LOAD	B,[CMDL_B]
04/9F: A46C     	STORE	[ARG_BNK],B
04/A0: 9001     	LOADF	A,[A+ARGV]
04/A1: 3804     	LOADI	C,BI
04/A2: BB01     	STOREF	[D+1],C
04/A3: 38A5     	LOADI	C,@+2
04/A4: 3406     	LOADI	B,S_OPEN
04/A5: 38A7     	LOADI	C,@+2
04/A6: FF5D     	JUMP	SYSCALL
04/A7: 5000     	ADDI	A,0
04/A8: F609     	BRZ	1F
04/AA:          	
04/A9:          	; ERROR
04/A9:          	; ALSO SET LINENUM AND CURRFIL
04/A9: 8031     	LOAD	A,[SRCINDX]
04/AA: A048     	STORE	[CURRFIL],A
04/AB: 3000     	LOADI	A,0
04/AC: A046     	STORE	[LINENUM],A
04/AD: A047     	STORE	[LINENUM+1],A
04/AE: 3080     	LOADI	A,E_COPEN
04/AF: 3401     	LOADI	B,CORE0_B
04/B0: 38D0     	LOADI	C,ERROR
04/B1: FF50     	JUMP	INDIR
04/B3:          
04/B2:          	; ATTEMPT TO READ THE FIRST BLOCK
04/B2: 3404     1:	LOADI	B,SRC_B
04/B3: A46C     	STORE	[ARG_BNK],B
04/B4: 3000     	LOADI	A,0
04/B5: 3408     	LOADI	B,S_READ
04/B6: 38B8     	LOADI	C,@+2
04/B7: FF4C     	JUMP	SYSCALL
04/B9:          	
04/B8:          	; IF IT DIDN'T WORK, GET THE NEXT BLOCK
04/B8: 5000     	ADDI	A,0
04/B9: F7DE     	BRNZ	0B
04/BB:          
04/BA:          	; RETURN
04/BA: 5C02     9:	ADDI	D,2
04/BB: FF47     	JUMP	IRET
04/BD:          	
04/BC:          	; GET THE NEXT CHARACTER IN THE STREAM
04/BC:          	; RETURNS CHARACTER IN [SRCCHAR]
04/BC:          	; IF THERE ARE NO CHARACTER, 0 WILL BE RETURNED
04/BC: 7C02     NEXTCHR:SUBI	D,2
04/BE:          
04/BD:          	; CHECK SRCINDX != ARGC
04/BD: 8031     	LOAD	A,[SRCINDX]
04/BE: 8400     	LOAD	B,[ARGC]
04/BF: D100     	CMP	A,B
04/C0: F627     	BRZ	8F
04/C2:          
04/C1:          	; CHECK IF SRCPNTR IS VALID
04/C1: 8034     	LOAD	A,[SRCPNTR]
04/C2: 8433     	LOAD	B,[SRCBANK]
04/C3: 5000     	ADDI	A,0
04/C4: F40C     	BRN	3F
04/C6:          	
04/C5:          	; ALRIGHT, LETS JUST GRAB A CHARACTER FROM THE BANK
04/C5: A480     1:	STORE	[DBANK],B
04/C6: 9800     	LOADF	C,[A]
04/C7: 3400     	LOADI	B,0
04/C8: A480     	STORE	[DBANK],B
04/CA:          	
04/C9:          	; INCREMENT POINTER
04/C9: 5001     	ADDI	A,1
04/CA: A034     	STORE	[SRCPNTR],A
04/CC:          	
04/CB:          	; CAN WE RETURN?
04/CB: A836     2:	STORE	[SRCCHAR],C
04/CC: 5800     	ADDI	C,0
04/CD: F71C     	BRNZ	9F
04/CE: 380A     	LOADI	C,NEWLINE
04/CF: A836     	STORE	[SRCCHAR],C
04/D0: FF15     	JUMP	7F
04/D2:          	
04/D1:          	; INCREMENT BANK
04/D1: 3000     3:	LOADI	A,0
04/D2: 5401     	ADDI	B,1
04/D3: A433     	STORE	[SRCBANK],B
04/D4: 3808     	LOADI	C,SRC_B+4
04/D5: D600     	CMP	B,C
04/D6: F1EE     	BRB	1B
04/D8:          	
04/D7:          	; READ A NEW BLOCK
04/D7: 8032     	LOAD	A,[SRCBLK]
04/D8: 5001     	ADDI	A,1
04/D9: F00C     	BRC	7F
04/DA: A032     	STORE	[SRCBLK],A
04/DB: 3804     	LOADI	C,BI
04/DC: BB01     	STOREF	[D+1],C
04/DD: 3408     	LOADI	B,S_READ
04/DE: 38E0     	LOADI	C,@+2
04/DF: FF24     	JUMP	SYSCALL
04/E0: 5000     	ADDI	A,0
04/E1: F704     	BRNZ	7F
04/E3:          	
04/E2:          	; GO READ A CHARACTER NOW
04/E2: 3000     	LOADI	A,0
04/E3: 3404     	LOADI	B,SRC_B
04/E4: A433     	STORE	[SRCBANK],B
04/E5: FFDF     	JUMP	1B
04/E7:          
04/E6:          	; WE ARE DONE WITH THIS FILE
04/E6:          	; MOVE ON TO THE NEXT
04/E6: 5C02     7:	ADDI	D,2
04/E7: FFA8     	JUMP	NEXTSRC
04/E9:          	
04/E8:          	; STORE A ZERO IN SRCCHAR
04/E8: 3000     8:	LOADI	A,0
04/E9: A036     	STORE	[SRCCHAR],A
04/EB:          	
04/EA:          	; RETURN
04/EA: 5C02     9:	ADDI	D,2
04/EB: FF17     	JUMP	IRET
04/ED:          	
04/EC:          BI	= BI+1
04/EC:          .TEXT
04/EC:          .BANK	BI
05/80:          TOK1_B	= BI
05/80:          	
05/80:          	; SHADOW OF NEXTTOK
05/80:          	; DO WE NEED TO INCREMENT THE LINE?
05/80:          	; YES WE DO, UPDATE CURRENT FILE
05/80: 8031     NEXTTOA:LOAD	A,[SRCINDX]
05/81: A048     	STORE	[CURRFIL],A
05/83:          	
05/82:          	; INCRMENT SOURCE LINE
05/82: 8038     	LOAD	A,[SRCLINE+1]
05/83: 5001     	ADDI	A,1
05/84: A038     	STORE	[SRCLINE+1],A
05/85: 8437     	LOAD	B,[SRCLINE]
05/86: F102     	BRNC	1F
05/87: 5401     	ADDI	B,1
05/88: A437     	STORE	[SRCLINE],B
05/8A:          	
05/89:          	; REFLECT ON LINE NUMBER
05/89: A446     1:	STORE	[LINENUM],B
05/8A: A047     	STORE	[LINENUM+1],A
05/8C:          
05/8B:          
05/8B:          	; CHECK THE NEXT CHARACTER IN THE STREAM
05/8B: 8036     NEXTTOB:LOAD	A,[SRCCHAR]
05/8C: 5000     	ADDI	A,0
05/8D: F66C     	BRZ	8F
05/8E: F43D     	BRN	5F
05/90:          
05/8F:          	; IS IT A NEWLINE?
05/8F: 340A     	LOADI	B,NEWLINE
05/90: D100     	CMP	A,B
05/91: F703     	BRNZ	1F
05/93:          	
05/92:          	; NEW LINE
05/92: 34FF     	LOADI	B,0XFF
05/93: A435     	STORE	[SRCSTAT],B
05/94: FF65     	JUMP	8F
05/96:          
05/95:          	; CHECK STATE STUFF
05/95: 8835     1:	LOAD	C,[SRCSTAT]
05/96: 343B     	LOADI	B,SEMICOL
05/97: D600     	CMP	B,C
05/98: F633     	BRZ	5F
05/99: 5800     	ADDI	C,0
05/9A: F71B     	BRNZ	4F
05/9C:          
05/9B:          	; IS IT WHITESPACE?
05/9B: 3420     	LOADI	B,0X20
05/9C: D100     	CMP	A,B
05/9D: F92E     	BRBE	5F
05/9F:          	
05/9E:          	; IS IT A NUMBER?
05/9E: 3430     	LOADI	B,'0'
05/9F: D100     	CMP	A,B
05/A0: F104     	BRB	2F
05/A1: 3439     	LOADI	B,'9'
05/A2: D100     	CMP	A,B
05/A3: 3481     	LOADI	B,NUMERIC
05/A4: F92C     	BRBE	0F
05/A6:          	
05/A5:          	; NOPE, IS IT IS LETTER?
05/A5:          	; FIRST CONVERT FROM LOWERCASE TO UPPERCASE
05/A5: 3461     2:	LOADI	B,'A'+0X20
05/A6: D100     	CMP	A,B
05/A7: F104     	BRB	3F
05/A8: 347A     	LOADI	B,'Z'+0X20
05/A9: D100     	CMP	A,B
05/AA: F801     	BRA	3F
05/AB: 7020     	SUBI	A,0X20
05/AD:          	
05/AC:          	; CHECK FOR UPPER CASE LETTER
05/AC: 345F     3:	LOADI	B,'_'
05/AD: D100     	CMP	A,B
05/AE: F605     	BRZ	2F
05/AF: 3441     	LOADI	B,'A'
05/B0: D100     	CMP	A,B
05/B1: F104     	BRB	4F
05/B2: 345A     	LOADI	B,'Z'
05/B3: D100     	CMP	A,B
05/B4: 3480     2:	LOADI	B,SYMBOL
05/B5: F91B     	BRBE	0F
05/B7:          	
05/B6:          	; NOPE, PROCESS AS A LITERAL
05/B6: 8835     4:	LOAD	C,[SRCSTAT]
05/B7: D200     	CMP	A,C
05/B8: F703     	BRNZ	4F
05/BA:          	
05/B9:          	; END OF ENCLOSED SECTION
05/B9: 3800     	LOADI	C,0
05/BA: A835     	STORE	[SRCSTAT],C
05/BB: FF3E     	JUMP	8F
05/BD:          	
05/BC:          	; IF ENCLOSED, JUST SEND DIRECTLY TO OUTPUT
05/BC: 5800     4:	ADDI	C,0
05/BD: F73C     	BRNZ	8F
05/BF:          
05/BE:          	; IS IT A COMMENT?
05/BE: 343B     	LOADI	B,SEMICOL
05/BF: D100     	CMP	A,B
05/C0: F702     	BRNZ	4F
05/C2:          	
05/C1:          	; SET COMMENT MODE
05/C1: A035     	STORE	[SRCSTAT],A
05/C2: FF09     	JUMP	5F
05/C4:          
05/C3:          	; IS IT A SINGLE OR DOUBLE QUOTE?
05/C3: 3427     4:	LOADI	B,SQUOTE
05/C4: D100     	CMP	A,B
05/C5: F604     	BRZ	4F
05/C6: 3422     	LOADI	B,DQUOTE
05/C7: D100     	CMP	A,B
05/C8: F601     	BRZ	4F
05/C9: FF30     	JUMP	8F
05/CB:          
05/CA:          	; YES IT IS, SET THE STATE AND EXIT
05/CA: A035     4:	STORE	[SRCSTAT],A
05/CB: FF2E     	JUMP	8F
05/CD:          	
05/CC:          	; GRAB A NEW CHARACTER FROM THE STREAM
05/CC: 388B     5:	LOADI	C,NEXTTOB
05/CD: BB00     	STOREF	[D],C
05/CE: 3404     	LOADI	B,TOK0_B
05/CF: 38BC     	LOADI	C,NEXTCHR
05/D0: FF31     	JUMP	INDIR
05/D2:          
05/D1:          	; COPY THE SYMBOL OR NUMERIC INTO THE BUFFER
05/D1: A430     0:	STORE	[TOKEN],B
05/D3:          
05/D2:          	; PREPARE TO COPY
05/D2: 383A     	LOADI	C,TBUF
05/D4:          	
05/D3:          	; STORE CHARACTER
05/D3: B200     1:	STOREF	[C],A
05/D4: A839     	STORE	[BUFPNTR],C
05/D6:          
05/D5:          	; GET NEXT CHARACTER
05/D5: 38DA     2:	LOADI	C,@+5
05/D6: BB00     	STOREF	[D],C
05/D7: 3404     	LOADI	B,TOK0_B
05/D8: 38BC     	LOADI	C,NEXTCHR
05/D9: FF28     	JUMP	INDIR
05/DB:          	
05/DA:          	; CHECK CHARACTER TYPE
05/DA: 8839     	LOAD	C,[BUFPNTR]
05/DB: 8036     	LOAD	A,[SRCCHAR]
05/DD:          	
05/DC:          	; IS IT A NUMBER?
05/DC: 3430     	LOADI	B,'0'
05/DD: D100     	CMP	A,B
05/DE: F118     	BRB	7F
05/DF: 3439     	LOADI	B,'9'
05/E0: D100     	CMP	A,B
05/E1: F910     	BRBE	4F
05/E3:          	
05/E2:          	; NOPE, IS IT IS LETTER?
05/E2:          	; FIRST CONVERT FROM LOWERCASE TO UPPERCASE
05/E2: 3461     	LOADI	B,'A'+0X20
05/E3: D100     	CMP	A,B
05/E4: F104     	BRB	3F
05/E5: 347A     	LOADI	B,'Z'+0X20
05/E6: D100     	CMP	A,B
05/E7: F801     	BRA	3F
05/E8: 7020     	SUBI	A,0X20
05/EA:          	
05/E9:          	; CHECK FOR UPPER CASE LETTER
05/E9: 345F     3:	LOADI	B,'_'
05/EA: D100     	CMP	A,B
05/EB: F606     	BRZ	4F
05/EC: 3441     	LOADI	B,'A'
05/ED: D100     	CMP	A,B
05/EE: F108     	BRB	7F
05/EF: 345A     	LOADI	B,'Z'
05/F0: D100     	CMP	A,B
05/F1: F805     	BRA	7F
05/F3:          	
05/F2:          	; ADD TO THE STRING
05/F2: 5801     4:	ADDI	C,1
05/F3: 3444     	LOADI	B,TBUFEND
05/F4: D600     	CMP	B,C
05/F5: F6DF     	BRZ	2B
05/F6: FFDC     	JUMP	1B
05/F8:          	
05/F7:          	; TERMINATE
05/F7: 3000     7:	LOADI	A,0
05/F8: B201     	STOREF	[C+1],A
05/F9: FF03     	JUMP	9F
05/FB:          	
05/FA:          	; SAVE TOKEN TYPE AND CONSUME THE SRCCHAR
05/FA: 3480     8:	LOADI	B,0X80
05/FB: A436     	STORE	[SRCCHAR],B
05/FC: A030     	STORE	[TOKEN],A
05/FE:          	
05/FD:          	; RETURN
05/FD: 5C02     9:	ADDI	D,2
05/FE: FF04     	JUMP	IRET
05/100:          	
05/FF:          ; AS2.S
05/FF:          ; EXPRESSION HANDLING
05/FF:          ; GAVIN TERSTEEG, 2024
05/FF:          ; SDMAY24-14
05/FF:          
05/FF:          BI	= BI+1
05/FF:          .TEXT
05/FF:          .BANK	BI
06/80:          EXP0_B	= BI
06/80:          
06/80:          	; PARSE AN EXPRESSION
06/80:          	; THE FIRST PART OF THE EXPRESSION SHOULD BE IN THE TOKEN BUFFER
06/80:          	; IF PARSING IS SUCCESSFUL, THE RESULT WILL BE PLACED IN [VALUE]
06/80:          	; IF A SYMBOL IS UNDEFINED, AN ERROR CODE WILL BE RETURNED IN
06/80:          	; REGISTER A, OTHERWISE A = 0X00 WILL BE RETURNED.
06/80:          PRECED	= CHAR
06/80: 3407     PARSEX: LOADI	B,EXP1_B
06/81: 3880     	LOADI	C,PARSEXA
06/82: FF7F     	JUMP	INDIR
06/84:          
06/83:          	; PARSE A NUMERIC VALUE
06/83:          	; THE NUMERIC TO BE PARSED SHOULD BE IN THE TOKEN BUFFER
06/83:          	; IF THE PARSING IS SUCCESSFUL, THE RESULT WILL BE PLACED IN [VALUE]
06/83:          	; DEFAULT RADIX IS 10
06/83:          RADIX	= TEMP
06/83: 300A     PARSEN:	LOADI	A,10
06/84: A018     	STORE	[RADIX],A
06/86:          	
06/85:          	; RESET VALUE AS WELL
06/85: 3000     	LOADI	A,0
06/86: A014     	STORE	[VALUE],A
06/87: A015     	STORE	[VALUE+1],A
06/89:          	
06/88:          	; RESET BUFFER POINTER
06/88: 303A     	LOADI	A,TBUF
06/8A:          	
06/89:          	; DETECT LEADING ZERO
06/89: 9400     	LOADF	B,[A]
06/8A: 5400     	ADDI	B,0
06/8B: F677     	BRZ	IRET
06/8C: 7430     	SUBI	B,'0'
06/8D: F709     	BRNZ	1F
06/8F:          	
06/8E:          	; SET RADIX TO 8
06/8E: 3408     	LOADI	B,8
06/8F: A418     	STORE	[RADIX],B
06/91:          	
06/90:          	; GET NEXT CHARACTER, COMPARE WITH 9
06/90: 5001     	ADDI	A,1
06/91: 9400     	LOADF	B,[A]
06/92: 3839     	LOADI	C,'9'
06/93: D600     	CMP	B,C
06/94: F902     	BRBE	1F
06/96:          	
06/95:          	; RADIX FORMAT IS "0?..."
06/95: 5001     	ADDI	A,1
06/96: FF0E     	JUMP	4F
06/98:          	
06/97:          	; CHECK END OF NUMBER FOR RADIX
06/97: 2800     1:	MOV	C,A
06/98: 9600     2:	LOADF	B,[C]
06/99: 5400     	ADDI	B,0
06/9A: F602     	BRZ	3F
06/9B: 5801     	ADDI	C,1
06/9C: FFFB     	JUMP	2B
06/9E:          	
06/9D:          	; LOOK AT LAST CHARACTER
06/9D: 96FF     3:	LOADF	B,[C+0-1]
06/9E: 7439     	SUBI	B,'9'
06/9F: F915     	BRBE	0F
06/A0: 5439     	ADDI	B,'9'
06/A1: A039     	STORE	[BUFPNTR],A
06/A2: 3000     	LOADI	A,0
06/A3: B2FF     	STOREF	[C+0-1],A
06/A4: 8039     	LOAD	A,[BUFPNTR]
06/A6:          
06/A5:          	; B = POTENTIAL RADIX
06/A5: 3810     4:	LOADI	C,16
06/A6: 7458     	SUBI	B,'X'
06/A7: F60C     	BRZ	5F
06/A8: 74F0     	SUBI	B,'H'-'X'
06/A9: F60A     	BRZ	5F
06/AA: 3808     	LOADI	C,8
06/AB: 7407     	SUBI	B,'O'-'H'
06/AC: F607     	BRZ	5F
06/AD: 3802     	LOADI	C,2
06/AE: 74F3     	SUBI	B,'B'-'O'
06/AF: F604     	BRZ	5F
06/B1:          	
06/B0:          	; ISSUE WITH PARSING NUMERIC
06/B0: 3081     8:	LOADI	A,E_UXNUM
06/B1: 3401     	LOADI	B,CORE0_B
06/B2: 38D0     	LOADI	C,ERROR
06/B3: FF4E     	JUMP	INDIR
06/B5:          	
06/B4:          	; C = RADIX
06/B4: A818     5:	STORE	[RADIX],C
06/B6:          	
06/B5:          	; START PARSING THE NUMERIC
06/B5: A039     0:	STORE	[BUFPNTR],A
06/B7:          	
06/B6:          	; GRAB A CHARACTER
06/B6: 9000     	LOADF	A,[A]
06/B7: 5000     	ADDI	A,0
06/B8: F64A     	BRZ	IRET
06/BA:          	
06/B9:          	; MULTIPLY BY RADIX (SLOWISH)
06/B9: AC12     	STORE	[SPARK],D
06/BA: 8414     	LOAD	B,[VALUE]
06/BB: 8815     	LOAD	C,[VALUE+1]
06/BC: 8C18     	LOAD	D,[RADIX]
06/BE:          	
06/BD: 7C01     1:	SUBI	D,1
06/BE: F609     	BRZ	3F
06/BF: 8015     	LOAD	A,[VALUE+1]
06/C0: 4200     	ADD	A,C
06/C1: A015     	STORE	[VALUE+1],A
06/C2: 8014     	LOAD	A,[VALUE]
06/C3: F101     	BRNC	2F
06/C4: 5001     	ADDI	A,1
06/C5: 4100     2:	ADD	A,B
06/C6: A014     	STORE	[VALUE],A
06/C7: FFF5     	JUMP	1B
06/C9:          	
06/C8:          	; GET THE CHARACTER AGAIN, AND INCREMENT POINTER
06/C8: 8C12     3:	LOAD	D,[SPARK]
06/C9: 8039     	LOAD	A,[BUFPNTR]
06/CA: 9800     	LOADF	C,[A]
06/CB: 5001     	ADDI	A,1
06/CD:          	
06/CC:          	; CHECK BOUNDS
06/CC: 3430     	LOADI	B,'0'
06/CD: D900     	CMP	C,B
06/CE: F1E1     	BRB	8B 
06/CF: 3439     	LOADI	B,'9'
06/D0: D900     	CMP	C,B
06/D1: F907     	BRBE	4F
06/D3:          	
06/D2: 3441     	LOADI	B,'A'
06/D3: D900     	CMP	C,B
06/D4: F1DB     	BRB	8B
06/D5: 3446     	LOADI	B,'F'
06/D6: D900     	CMP	C,B
06/D7: F8D8     	BRA	8B
06/D9:          	
06/D8: 7807     	SUBI	C,'A'-('0'+10)
06/DA:          	
06/D9:          	; CONVERT FROM ASCII
06/D9: 7830     4:	SUBI	C,'0'
06/DB:          
06/DA:          	; COMPARE WITH RADIX
06/DA: 8418     	LOAD	B,[RADIX]
06/DB: D900     	CMP	C,B
06/DC: F0D3     	BRAE	8B
06/DE:          	
06/DD:          	; ADD TO VALUE
06/DD: 8415     	LOAD	B,[VALUE+1]
06/DE: 4600     	ADD	B,C
06/DF: A415     	STORE	[VALUE+1],B
06/E0: F1D4     	BRNC	0B
06/E1: 8414     	LOAD	B,[VALUE]
06/E2: 5401     	ADDI	B,1
06/E3: A414     	STORE	[VALUE],B
06/E4: FFD0     	JUMP	0B
06/E6:          
06/E5:          BI	= BI+1
06/E5:          .TEXT
06/E5:          .BANK	BI
07/80:          EXP1_B	= BI
07/80:          
07/80:          	; SHADOW OF PARSEX
07/80: 7C02     PARSEXA:SUBI	D,2
07/82:          
07/81:          	; RESET VALUE AND EXPRESSION STACKS
07/81: 3024     	LOADI	A,VSTACK
07/82: A02F     	STORE	[VINDEX],A
07/83: 301A     	LOADI	A,ESTACK
07/84: A02E     	STORE	[EINDEX],A
07/86:          	
07/85:          	; PROCESS TOKEN (VALUES AND LEFT PARATHESIS)
07/85:          	; ALSO SET RETURN ADDRESS
07/85: 3807     0:	LOADI	C,BI
07/86: BB01     	STOREF	[D+1],C
07/87: 8030     	LOAD	A,[TOKEN]
07/89:          
07/88:          	; IS IT A NUMERIC?
07/88: 7081     	SUBI	A,NUMERIC
07/89: F711     	BRNZ	7F
07/8B:          	
07/8A:          	; CHECK FOR LOCAL SYMBOLS
07/8A: 803C     	LOAD	A,[TBUF+2]
07/8B: 5000     	ADDI	A,0
07/8C: F709     	BRNZ	2F
07/8D: 803B     	LOAD	A,[TBUF+1]
07/8E: 7046     	SUBI	A,'F'
07/8F: F602     	BRZ	1F
07/90: 70FC     	SUBI	A,'B'-'F'
07/91: F704     	BRNZ	2F
07/93:          
07/92:          	; TODO: PROCESS LOCAL SYMBOL
07/92: 3000     1:	LOADI	A,0
07/93: A014     	STORE	[VALUE],A
07/94: A015     	STORE	[VALUE+1],A
07/95: FF10     	JUMP	8F
07/97:          
07/96:          	; PARSE NUMERIC
07/96: 38A6     2:	LOADI	C,8F
07/97: BB00     	STOREF	[D],C
07/98: 3406     	LOADI	B,EXP0_B
07/99: 3883     	LOADI	C,PARSEN
07/9A: FF67     	JUMP	INDIR
07/9C:          	
07/9B:          	; IS IT A SYMBOL?
07/9B: 70FF     7:	SUBI	A,SYMBOL-NUMERIC
07/9C: F704     	BRNZ	7F
07/9E:          
07/9D:          	; TODO: PROCESS SYMBOL
07/9D: 3000     	LOADI	A,0
07/9E: A014     	STORE	[VALUE],A
07/9F: A015     	STORE	[VALUE+1],A
07/A0: FF05     	JUMP	8F
07/A2:          
07/A1:          	; IS IT A '@'?
07/A1: 70C0     7:	SUBI	A,'@'-SYMBOL
07/A2: F70F     	BRNZ	7F
07/A4:          
07/A3:          	; TODO: PROCESS POINTER
07/A3: 3000     	LOADI	A,0
07/A4: A014     	STORE	[VALUE],A
07/A5: A015     	STORE	[VALUE+1],A
07/A7:          
07/A6:          	; PLACE [VALUE] ONTO THE VSTACK
07/A6: 842F     8:	LOAD	B,[VINDEX]
07/A7: 3029     	LOADI	A,VSTACK+STACKSZ
07/A8: D400     	CMP	B,A
07/A9: 3084     	LOADI	A,E_VSTKO
07/AA: F017     	BRAE	8F	; ERROR!
07/AB: 8014     	LOAD	A,[VALUE]
07/AC: B100     	STOREF	[B],A
07/AD: 8015     	LOAD	A,[VALUE+1]
07/AE: B101     	STOREF	[B+1],A
07/AF: 5402     	ADDI	B,2
07/B0: A42F     	STORE	[VINDEX],B
07/B1: FF13     	JUMP	PARSEXC
07/B3:          	
07/B2:          	; IS IT A '('?
07/B2: 70E8     7:	SUBI	A,'('-'@'
07/B3: F70D     	BRNZ	7F
07/B5:          	
07/B4: A013     	STORE	[PRECED],A
07/B6:          	
07/B5:          	; PLACE LEFT PARATHESIS ON ESTACK
07/B5: 842E     PARSEXB:LOAD	B,[EINDEX]
07/B6: 301F     	LOADI	A,ESTACK+STACKSZ
07/B7: D400     	CMP	B,A
07/B8: 3085     	LOADI	A,E_ESTKO
07/B9: F008     	BRAE	8F	; ERROR!
07/BA: 8030     	LOAD	A,[TOKEN]
07/BB: B100     	STOREF	[B],A
07/BC: 8013     	LOAD	A,[PRECED]
07/BD: B101     	STOREF	[B+1],A
07/BE: 5402     	ADDI	B,2
07/BF: A42E     	STORE	[EINDEX],B
07/C0: FF04     	JUMP	PARSEXC
07/C2:          	
07/C1:          	; ERROR!
07/C1: 3083     7:	LOADI	A,E_UXTOK
07/C2: 3401     8:	LOADI	B,CORE0_B
07/C3: 38D0     	LOADI	C,ERROR
07/C4: FF3D     	JUMP	INDIR
07/C6:          
07/C5:          	; GET THE NEXT TOKEN
07/C5: 3807     PARSEXC:LOADI	C,BI
07/C6: BB01     	STOREF	[D+1],C
07/C7: 38CC     	LOADI	C,@+5
07/C8: BB00     	STOREF	[D],C
07/C9: 3404     	LOADI	B,TOK0_B
07/CA: 3880     	LOADI	C,NEXTTOK
07/CB: FF36     	JUMP	INDIR
07/CD:          	
07/CC:          	; LOOK FOR SPECIAL VALUES
07/CC: 8030     	LOAD	A,[TOKEN]
07/CD: A013     	STORE	[CHAR],A
07/CE: 7081     	SUBI	A,NUMERIC
07/CF: F6B5     	BRZ	0B
07/D0: 70FF     	SUBI	A,SYMBOL-NUMERIC
07/D1: F6B3     	BRZ	0B
07/D2: 70C0     	SUBI	A,'@'-SYMBOL
07/D3: F6B1     	BRZ	0B
07/D4: 70E8     	SUBI	A,'('-'@'
07/D5: F6AF     	BRZ	0B
07/D7:          	
07/D6:          	; THIS IS SOME SORT OPERATION
07/D6: 3408     	LOADI	B,EXP2_B
07/D7: 3880     	LOADI	C,PARSEXD
07/D8: FF29     	JUMP	INDIR
07/DA:          
07/D9:          BI	= BI+1
07/D9:          .TEXT
07/D9:          .BANK	BI
08/80:          EXP2_B	= BI
08/80:          
08/80:          	; HANDLE OTHER CHARACTERS IN EXPRESSION
08/80:          	; ALSO GET PRECEDENCE OF CHARACTER
08/80: 3808     PARSEXD:LOADI	C,BI
08/81: BB01     	STOREF	[D+1],C
08/82: 3802     	LOADI	C,2
08/83: 7003     	SUBI	A,'+'-'('
08/84: F629     	BRZ	5F
08/85: 7002     	SUBI	A,'-'-'+'
08/86: F627     	BRZ	5F
08/87: 3803     	LOADI	C,3
08/88: 70FD     	SUBI	A,'*'-'-'
08/89: F624     	BRZ	5F
08/8A: 7005     	SUBI	A,'/'-'*'
08/8B: F622     	BRZ	5F
08/8C: 70F6     	SUBI	A,'%'-'/'
08/8D: F620     	BRZ	5F
08/8E: 3807     	LOADI	C,7
08/8F: 7057     	SUBI	A,'|'-'%'
08/90: F61D     	BRZ	5F
08/91: 3805     	LOADI	C,5
08/92: 70AA     	SUBI	A,'&'-'|'
08/93: F61A     	BRZ	5F
08/94: 3801     	LOADI	C,1
08/95: 70FB     	SUBI	A,'!'-'&'
08/96: F617     	BRZ	5F
08/97: 3806     	LOADI	C,6
08/98: 703D     	SUBI	A,'^'-'!'
08/99: F614     	BRZ	5F
08/9A: 70CB     	SUBI	A,')'-'^'
08/9B: F700     	BRNZ	3F
08/9D:          	
08/9C:          	; TODO: PROCESS RIGHT PARATHESIS
08/9C:          	
08/9C: 7015     3:	SUBI	A,'>'-')'
08/9D: F602     	BRZ	4F
08/9E: 70FE     	SUBI	A,'<'-'>'
08/9F: F722     	BRNZ	9F
08/A1:          
08/A0:          	; IT'S A '<<' OR '>>' (HOPEFULLY)
08/A0:          	; GET THE NEXT TOKEN TO CONFIRM
08/A0: 38A5     4:	LOADI	C,@+5
08/A1: BB00     	STOREF	[D],C
08/A2: 3404     	LOADI	B,TOK0_B
08/A3: 3880     	LOADI	C,NEXTTOK
08/A4: FF5D     	JUMP	INDIR
08/A6:          	
08/A5:          	; IF THE NEXT TOKEN IS THE SAME AS THE LAST, WE ARE GOOD
08/A5: 8030     	LOAD	A,[TOKEN]
08/A6: 8413     	LOAD	B,[CHAR]
08/A7: D100     	CMP	A,B
08/A8: 3804     	LOADI	C,4
08/A9: F604     	BRZ	5F
08/AB:          	
08/AA:          	; BOO! ERROR!
08/AA: 3083     	LOADI	A,E_UXTOK
08/AB: 3401     	LOADI	B,CORE0_B
08/AC: 38D0     	LOADI	C,ERROR
08/AD: FF54     	JUMP	INDIR
08/AF:          
08/AE:          	; WE HAVE A SPECIAL CHARACTER
08/AE:          	; C = PRECEDENCE
08/AE: A813     5:	STORE	[PRECED],C
08/B0:          	
08/AF:          	; CHECK EINDEX
08/AF: 802E     0:	LOAD	A,[EINDEX]
08/B0: 341A     	LOADI	B,ESTACK
08/B1: D100     	CMP	A,B
08/B2: F609     	BRZ	5F
08/B4:          
08/B3:          	; COMPARE PRECEDENCE OF THE TOP OF THE ESTACK WITH OP PRECEDENCE
08/B3: 94FF     	LOADF	B,[A+0-1]
08/B4: 8013     	LOAD	A,[PRECED]
08/B5: D100     	CMP	A,B
08/B6: F105     	BRB	5F
08/B8:          	
08/B7:          	; POP OFF OF ESTACK
08/B7: 38BC     	LOADI	C,@+5
08/B8: BB00     	STOREF	[D],C
08/B9: 3409     	LOADI	B,EXP3_B
08/BA: 3880     	LOADI	C,ESTKPOP
08/BB: FF46     	JUMP	INDIR
08/BD:          	
08/BC:          	; PUSH ONTO ESTACK
08/BC: 3407     5:	LOADI	B,EXP1_B
08/BD: 38B5     	LOADI	C,PARSEXB
08/BE: FF43     	JUMP	INDIR
08/C0:          
08/BF:          	; GET THE NEXT TOKEN
08/BF: 3407     	LOADI	B,EXP1_B
08/C0: 38C5     	LOADI	C,PARSEXC
08/C1: FF40     	JUMP	INDIR
08/C3:          	
08/C2:          	; CAN'T RECOGNIZE CHARACTER, END OF EXPRESSION
08/C2:          	; AND WE ARE DONE
08/C2: 3000     9:	LOADI	A,0
08/C3: 5C02     	ADDI	D,2
08/C4: FF3E     	JUMP	IRET
08/C6:          
08/C5:          BI	= BI+1
08/C5:          .TEXT
08/C5:          .BANK	BI
09/80:          EXP3_B	= BI
09/80:          
09/80:          	; POP A VALUE OFF OF THE ESTACK
09/80: 7C02     ESTKPOP:SUBI	D,2
09/82:          	
09/81:          	; CHECK IF EXPRESSION STACK IS EMPTY
09/81: 3087     	LOADI	A,E_ESTKD
09/82: 842E     	LOAD	B,[EINDEX]
09/83: 381A     	LOADI	C,ESTACK
09/84: D600     	CMP	B,C
09/85: F936     	BRBE	9F
09/87:          	
09/86:          	; POP VALUE OFF ESTACK
09/86: 7402     	SUBI	B,2
09/87: A42E     	STORE	[EINDEX],B
09/89:          	
09/88:          	; CHECK IF VALUE STACK HAS TWO VALUES
09/88: 3086     	LOADI	A,E_VSTKD
09/89: 842F     	LOAD	B,[VINDEX]
09/8A: 3826     	LOADI	C,VSTACK+2
09/8B: D600     	CMP	B,C
09/8C: F92F     	BRBE	9F
09/8E:          
09/8D:          	; MOVE TWO VSTACK VALUES INTO [VALUE] AND [OPERAND]
09/8D: 91FF     	LOADF	A,[B+0-1]
09/8E: A017     	STORE	[OPERAND+1],A
09/8F: 91FE     	LOADF	A,[B+0-2]
09/90: A016     	STORE	[OPERAND],A
09/91: 91FD     	LOADF	A,[B+0-3]
09/92: A015     	STORE	[VALUE+1],A
09/93: 91FC     	LOADF	A,[B+0-4]
09/94: A014     	STORE	[VALUE],A
09/96:          	
09/95:          	; RESPOSITION VSTACK POINTER
09/95: 7402     	SUBI	B,2
09/96: A42F     	STORE	[VINDEX],B
09/98:          	
09/97:          	; GRAB THE OPERATION
09/97: 802E     	LOAD	A,[EINDEX]
09/98: 9000     	LOADF	A,[A]
09/9A:          	
09/99:          	; CHECK FOR ADDITION '+'
09/99: 702B     	SUBI	A,'+'
09/9A: F70B     	BRNZ	7F
09/9C:          	
09/9B:          	; DO ADDITION OPERATION
09/9B: 8015     	LOAD	A,[VALUE+1]
09/9C: 8417     	LOAD	B,[OPERAND+1]
09/9D: 4100     	ADD	A,B
09/9E: A015     	STORE	[VALUE+1],A
09/9F: 8014     	LOAD	A,[VALUE]
09/A0: 8416     	LOAD	B,[OPERAND]
09/A1: F101     	BRNC	1F
09/A2: 5001     	ADDI	A,1
09/A3: 4100     1:	ADD	A,B
09/A4: A014     	STORE	[VALUE],A
09/A5: FF0F     	JUMP	8F
09/A7:          	
09/A6:          	; CHECK FOR SUBTRACTION '-'
09/A6: 7002     7:	SUBI	A,'-'-'+'
09/A7: F70B     	BRNZ	7F
09/A9:          	
09/A8:          	; DO ADDITION OPERATION
09/A8: 8015     	LOAD	A,[VALUE+1]
09/A9: 8417     	LOAD	B,[OPERAND+1]
09/AA: 6100     	SUB	A,B
09/AB: A015     	STORE	[VALUE+1],A
09/AC: 8014     	LOAD	A,[VALUE]
09/AD: 8416     	LOAD	B,[OPERAND]
09/AE: F001     	BRC	1F
09/AF: 7001     	SUBI	A,1
09/B0: 6100     1:	SUB	A,B
09/B1: A014     	STORE	[VALUE],A
09/B2: FF02     	JUMP	8F
09/B4:          	
09/B3:          	; CHECK FOR MULTIPLICATION
09/B3: 70FD     7:	SUBI	A,'*'-'-'
09/B4: F700     	BRNZ	8F
09/B6:          	
09/B5:          	 
09/B5:          
09/B5:          	; PLACE [VALUE] ON STACK AND RETURN
09/B5: 802F     8:	LOAD	A,[VINDEX]
09/B6: 8415     	LOAD	B,[VALUE+1]
09/B7: B4FF     	STOREF	[A+0-1],B
09/B8: 8414     	LOAD	B,[VALUE]
09/B9: B4FE     	STOREF	[A+0-2],B
09/BA: 5C02     	ADDI	D,2
09/BB: FF47     	JUMP	IRET
09/BD:          
09/BC:          	; HANDLE ERROR
09/BC: 3401     9:	LOADI	B,CORE0_B
09/BD: 38D0     	LOADI	C,ERROR
09/BE: FF43     	JUMP	INDIR
09/C0:          
