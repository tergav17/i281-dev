00/00:          ; DOSDEF.S
01/80:          ; THIS FILE CONTAINS IMPORTANT DEFINES USED IN DOS/281
01/80:          
01/80:          ; BIOS CALLS
01/80:          REBOOT	= 0
01/80:          INDIR	= 1
01/80:          IRET	= 2
01/80:          SYSCALL	= 3
01/80:          SYSJUMP	= 4
01/80:          PRGM	= 5
01/80:          IWRITE	= 6
01/80:          
01/80:          HALT	= 0X7F
01/80:          
01/80:          ; SYSTEM CALLS
01/80:          S_EXIT	= 0
01/80:          S_PUTC	= 1
01/80:          S_GETC	= 2
01/80:          S_STAT	= 3
01/80:          S_PUTS	= 4
01/80:          S_INPUT	= 5
01/80:          S_OPEN	= 6
01/80:          S_CLOSE	= 7
01/80:          S_READ	= 8
01/80:          S_WRITE	= 9
01/80:          S_FSRCH	= 10
01/80:          S_NEXT	= 11
01/80:          S_DELET	= 12
01/80:          S_CREAT	= 13
01/80:          S_FREE	= 14
01/80:          S_EXEC	= 15
01/80:          
01/80:          ; MEMORY AREAS
01/80:          CF_NAME	= 0X60
01/80:          CF_SIZE	= 0X68
01/80:          CF_USR	= 0X6A
01/80:          DFT_USR	= 0X6B
01/80:          ARG_BNK	= 0X6C
01/80:          BD_FREE	= 0X6E
01/80:          MAX_IB	= 0X70
01/80:          MAX_DB	= 0X71
01/80:          CMDL_B	= 0X72
01/80:          AUTO_B	= 0X73
01/80:          KERNMEM	= 0X78
01/80:          BIOSMEM	= 0X7C
01/80:          
01/80:          ; DATA BANK ADDRESS
01/80:          DBANK	= 0X80		
01/80:          
01/80:          ; EDIT.S
01/80:          ; SIMPLE TEXT EDITOR
01/80:          
01/80:          ; BANK ALLOCATION STUFF
01/80:          BI	= 1
01/80:          BD	= 1
01/80:          
01/80:          .TEXT
01/80:          .BANK	BI
01/80:          CORE0_B	= BI
01/80:          
01/80:          	; START BY PROCESSING THE ARGUMENTS
01/80: 3000     START:	LOADI	A,0
01/81: A080     	STORE	[DBANK],A
01/83:          	
01/82:          	; SET UP STACK
01/82: 3C5E     	LOADI	D,0X60-2
01/84:          	
01/83:          	; SYSCALL RETURN BANK
01/83: 3801     	LOADI	C,BI
01/84: BB01     	STOREF	[D+1],C
01/86:          	
01/85:          	; INIT MEMORY
01/85: 388A     	LOADI	C,@+5
01/86: BB00     	STOREF	[D],C
01/87: 3402     	LOADI	B,MEM0_B
01/88: 3880     	LOADI	C,MINIT
01/89: FF77     	JUMP	INDIR
01/8B:          	
01/8A:          	; SAVE STACK
01/8A: AC05     	STORE	[SPARK],D
01/8C:          	
01/8B:          	; GO TO ARGUMENT BANK
01/8B: 8072     	LOAD	A,[CMDL_B]
01/8C: A06C     	STORE	[ARG_BNK],A
01/8D: A080     	STORE	[DBANK],A
01/8F:          	
01/8E:          	; SET UP POINTER
01/8E: 3800     	LOADI	C,0
01/90:          	
01/8F:          	; SKIP THE INITIAL COMMAND
01/8F: 9200     0:	LOADF	A,[C]
01/90: 3420     	LOADI	B,0X20
01/91: D100     	CMP	A,B
01/92: F902     	BRBE	1F
01/93: 5801     	ADDI	C,1
01/94: FFFA     	JUMP	0B
01/96:          
01/95:          	; LOOK FOR THE FIRST ARGUMENT
01/95: 9200     1:	LOADF	A,[C]
01/96: 5000     	ADDI	A,0
01/97: F604     	BRZ	2F
01/98: D100     	CMP	A,B
01/99: F805     	BRA	OPENARG
01/9A: 5801     	ADDI	C,1
01/9B: FFF9     	JUMP	1B
01/9D:          	
01/9C:          	; NO ARGUMENT, EMPTY BUFFER
01/9C: 3000     2:	LOADI	A,0
01/9D: A080     	STORE	[DBANK],A
01/9E: FF17     	JUMP	DONE
01/A0:          
01/9F:          	
01/9F:          	; THERE IS AN ARG, TRY AND OPEN IT
01/9F: 3C0E     OPENARG:LOADI	D,FNAME
01/A0: 9200     0:	LOADF	A,[C]
01/A1: 3400     	LOADI	B,0
01/A2: A480     	STORE	[DBANK],B
01/A3: B300     	STOREF	[D],A
01/A4: 7020     	SUBI	A,0X20
01/A5: F908     	BRBE	1F
01/A6: 5801     	ADDI	C,1
01/A7: 5C01     	ADDI	D,1
01/A8: 341D     	LOADI	B,FNAME+15
01/A9: DD00     	CMP	D,B
01/AA: F003     	BRAE	1F
01/AB: 8472     	LOAD	B,[CMDL_B]
01/AC: A480     	STORE	[DBANK],B
01/AD: FFF2     	JUMP	0B
01/AF:          	
01/AE:          	; TERMINATE STRING AND OPEN FILE
01/AE: 3000     1:	LOADI	A,0
01/AF: B300     	STOREF	[D],A
01/B0: 8C05     	LOAD	D,[SPARK]
01/B2:          	
01/B1:          	; OPEN THE FILE
01/B1: 38B6     	LOADI	C,@+5
01/B2: BB00     	STOREF	[D],C
01/B3: 3403     	LOADI	B,FIO0_B
01/B4: 3880     	LOADI	C,FREAD
01/B5: FF4B     	JUMP	INDIR
01/B7:          
01/B6:          
01/B6:          	; EXIT PROGRAM
01/B6: 3400     DONE:	LOADI	B,S_EXIT
01/B7: FF4C     	JUMP	SYSJUMP
01/B9:          
01/B8:          	; BANK IS DONE, MOVE ON TO THE NEXT
01/B8:          BI	= BI+1
01/B8:          .TEXT
01/B8:          .BANK	BI
02/80:          MEM0_B	= BI
02/80:          
02/80:          	; MEMORY INIT
02/80:          	; DIVIDE THE HEAP INTO BLOCKS OF 32 BYTES, AND ADD IT
02/80:          	; TO THE FREE TABLE
02/80:          	; USES: A, B, C
02/80: 3806     MINIT:	LOADI	C,HEAP
02/81: 8471     	LOAD	B,[MAX_DB]
02/83:          	
02/82:          	; SET THE START OF THE FREE BLOCK LIST
02/82: 3000     	LOADI	A,0
02/83: A80A     	STORE	[FREETAB],C
02/84: A00B     	STORE	[FREETAB+1],A
02/86:          	
02/85:          	; MOVE TO BANK
02/85: A880     0:	STORE	[DBANK],C
02/86: 3020     	LOADI	A,32
02/88:          	
02/87:          	; WRITE FIRST 3 HEADERS
02/87: B0E1     1:	STOREF	[A+1-32],A
02/88: B8E0     	STOREF	[A+0-32],C
02/89: 5020     	ADDI	A,32
02/8A: F5FC     	BRNN	1B
02/8C:          	
02/8B:          	; WRITE 4TH HEADER
02/8B: 3000     2:	LOADI	A,0
02/8C: A061     	STORE	[32*3+1],A
02/8D: 5801     	ADDI	C,1
02/8E: D900     	CMP	C,B
02/8F: F802     	BRA	3F
02/90: A860     	STORE	[32*3],C
02/91: FFF3     	JUMP	0B
02/93:          	
02/92:          	; STORE BANK ZERO TO INDICATE END OF LIST
02/92: A060     3:	STORE	[32*3],A
02/93: A080     	STORE	[DBANK],A
02/94: FF6D     	JUMP	IRET
02/96:          	
02/95:          	
02/95:          	; ALLOCATE A BLOCK OF MEMORY
02/95:          	; BLOCK WILL BE LINKED ONTO THE CURRENT BLOCK IN [CBLOCK]
02/95:          	; THEN IT WILL BE RETURN IN [CBLOCK]
02/95:          	; RETURNS A = 0XFF OUT OF BLOCKS, A = 0X00 OTHERWISE
02/95:          	; USES: A, B, C
02/95: AC05     MALLOC:	STORE	[SPARK],D
02/96: 840A     	LOAD	B,[FREETAB]
02/98:          	
02/97:          	; MAKE SURE THE NEXT BLOCK ISN'T NULL
02/97: 5400     	ADDI	B,0
02/98: 30FF     	LOADI	A,0XFF
02/99: F668     	BRZ	IRET
02/9B:          	
02/9A:          	; STORE THE BLOCK ADDRESS IN LBLOCK
02/9A: 880B     	LOAD	C,[FREETAB+1]
02/9B: A408     	STORE	[LBLOCK],B
02/9C: A809     	STORE	[LBLOCK+1],C
02/9E:          	
02/9D:          	; MOVE THE NEXT BLOCK INTO FREETAB POINTER
02/9D: A480     	STORE	[DBANK],B
02/9E: 9200     	LOADF	A,[C]
02/9F: 9601     	LOADF	B,[C+1]
02/A0: 3C00     	LOADI	D,0
02/A1: BE00     	STOREF	[C],D
02/A2: BE01     	STOREF	[C+1],D
02/A3: AC80     	STORE	[DBANK],D
02/A4: A00A     	STORE	[FREETAB],A
02/A5: A40B     	STORE	[FREETAB+1],B
02/A7:          	
02/A6:          	; RESTORE STACK AND LINK
02/A6: 3000     	LOADI	A,0
02/A7: A080     	STORE	[DBANK],A
02/A8: 8C05     	LOAD	D,[SPARK]
02/AA:          	
02/A9:          	
02/A9:          	; LINK THE BLOCK IN LBLOCK ONTO CBLOCK
02/A9:          	; THE NEXT BLOCK OF CBLOCK WILL BECOME
02/A9:          	; THE NEXT BLOCK OF LBLOCK
02/A9:          	; AFTER THAT, CBLOCK WILL BECOME LBLOCK
02/A9:          	; RETURNS A = 0X00
02/A9:          	; USES: A, B, C
02/A9: AC05     LINK:	STORE	[SPARK],D
02/AB:          	
02/AA:          	; GET ADDRESS OF CBLOCK AND LBLOCK
02/AA: 8006     	LOAD	A,[CBLOCK]
02/AB: 8407     	LOAD	B,[CBLOCK+1]
02/AC: 8808     	LOAD	C,[LBLOCK]
02/AD: 8C09     	LOAD	D,[LBLOCK+1]
02/AF:          	
02/AE:          	; GRAB THE NEXT ADDRESS OF CBLOCK AND SET IT IN LBLOCK
02/AE: A080     	STORE	[DBANK],A
02/AF: 9100     	LOADF	A,[B]
02/B0: 9501     	LOADF	B,[B+1]
02/B1: A880     	STORE	[DBANK],C
02/B2: B300     	STOREF	[D],A
02/B3: B701     	STOREF	[D+1],B
02/B4: 3000     	LOADI	A,0
02/B5: A080     	STORE	[DBANK],A
02/B7:          	
02/B6:          	; RE-GRAB ADDRESS OF CBLOCK
02/B6: 8006     	LOAD	A,[CBLOCK]
02/B7: 8407     	LOAD	B,[CBLOCK+1]
02/B9:          	
02/B8:          	; SET CBLOCK NEXT TO LBLOCK
02/B8: A080     	STORE	[DBANK],A
02/B9: B900     	STOREF	[B],C
02/BA: BD01     	STOREF	[B+1],D
02/BC:          	
02/BB:          	; DONE, RESTORE STACK AND RETURN
02/BB: 3000     	LOADI	A,0
02/BC: A080     	STORE	[DBANK],A
02/BD: 8C05     	LOAD	D,[SPARK]
02/BE: FF43     	JUMP	IRET
02/C0:          
02/BF:          
02/BF:          	
02/BF:          	; PLACES THE BLOCK IN [CBLOCK] ONTO THE FREE
02/BF:          	; TABLE
02/BF:          	; USES: A, B, C
02/BF: AC05     FREE:	STORE	[SPARK],D
02/C1:          
02/C0:          	; GRAB ADDRESSES OF THE FREETAB AND CBLOCK
02/C0: 8006     	LOAD	A,[CBLOCK]
02/C1: 8407     	LOAD	B,[CBLOCK+1]
02/C2: 880A     	LOAD	C,[FREETAB]
02/C3: 8C0B     	LOAD	D,[FREETAB+1]
02/C5:          	
02/C4:          	; LINK REST OF FREETAB AFTER CBLOCK
02/C4: A080     	STORE	[DBANK],A
02/C5: B900     	STOREF	[B],C
02/C6: BD01     	STOREF	[B+1],D
02/C8:          	
02/C7:          	; SET CBLOCK AS BEGINNING OF FREE TABLE
02/C7: 3800     	LOADI	C,0
02/C8: A880     	STORE	[DBANK],C
02/C9: A00A     	STORE	[FREETAB],A
02/CA: A40B     	STORE	[FREETAB+1],B
02/CC:          	
02/CB:          	; RESTORE STACK AND RETURN
02/CB: 8C05     	LOAD	D,[SPARK]
02/CC: FF35     	JUMP	IRET
02/CE:          	
02/CD:          	; BANK IS DONE, MOVE ON TO THE NEXT
02/CD:          BI	= BI+1
02/CD:          .TEXT
02/CD:          .BANK	BI
03/80:          FIO0_B	= BI
03/80:          	
03/80:          	; READS A FILE INTO THE BUFFER
03/80:          	; [FNAME] = FILE TO OPEN
03/80:          	; RETURNS A = 0XFF IF ERROR, A = 0X00 RETURN OTHERWISE
03/80:          	; USES: A, B, C
03/80: 7C02     FREAD:	SUBI	D,2
03/82:          	
03/81:          	; SET OPEN TARGET
03/81: 3000     	LOADI	A,0
03/82: A06C     	STORE	[ARG_BNK],A
03/83: 300E     	LOADI	A,FNAME
03/85:          	
03/84:          	; ATTEMPT TO OPEN FILE
03/84: 3803     	LOADI	C,BI
03/85: BB01     	STOREF	[D+1],C
03/86: 3406     	LOADI	B,S_OPEN
03/87: 3889     	LOADI	C,@+2
03/88: FF7A     	JUMP	SYSCALL
03/8A:          	
03/89:          	; CHECK RESULT OF OPERATION
03/89: 5000     	ADDI	A,0
03/8A: F750     	BRNZ	9F
03/8C:          	
03/8B:          	; RE-INITALIZE MEMORY
03/8B: 3890     	LOADI	C,@+5
03/8C: BB00     	STOREF	[D],C
03/8D: 3402     	LOADI	B,MEM0_B
03/8E: 3880     	LOADI	C,MINIT
03/8F: FF71     	JUMP	INDIR
03/91:          	
03/90:          	; MALLOC FIRST BLOCK
03/90: 3000     	LOADI	A,0
03/91: A006     	STORE	[CBLOCK],A
03/92: A00C     	STORE	[LINETAB],A
03/93: A00D     	STORE	[LINETAB+1],A
03/94: 300C     	LOADI	A,LINETAB
03/95: A007     	STORE	[CBLOCK+1],A
03/97:          	
03/96: 389B     	LOADI	C,@+5
03/97: BB00     	STOREF	[D],C
03/98: 3402     	LOADI	B,MEM0_B
03/99: 3895     	LOADI	C,MALLOC
03/9A: FF66     	JUMP	INDIR
03/9C:          	
03/9B:          	; SET THE MEMORY BLOCK POINTER
03/9B: 8007     	LOAD	A,[CBLOCK+1]
03/9C: 5003     	ADDI	A,3
03/9D: A003     	STORE	[MB_PNTR],A
03/9E: 5020     	ADDI	A,32
03/9F: A004     	STORE	[MB_END],A
03/A0: 3000     	LOADI	A,0
03/A1: A004     	STORE	[LINES],A
03/A3:          	
03/A2:          	; RESET BLOCK READ IN STATE
03/A2: 3002     	LOADI	A,BUF_B
03/A3: A06C     	STORE	[ARG_BNK],A
03/A4: 3000     	LOADI	A,0
03/A6:          	
03/A5:          	; READ THE BLOCK
03/A5: A000     0:	STORE	[BLOCK],A
03/A6: 3408     	LOADI	B,S_READ
03/A7: 38A9     	LOADI	C,@+2
03/A8: FF5A     	JUMP	SYSCALL
03/AA:          
03/A9:          	; DID IT WORK?
03/A9: 5000     	ADDI	A,0
03/AA: F725     	BRNZ	0F
03/AC:          	
03/AB:          	; RESET THE BLOCK READ STATE
03/AB: 3002     	LOADI	A,BUF_B
03/AC: 3400     	LOADI	B,0
03/AE:          	
03/AD:          	; READ CHARACTER FROM BLOCK
03/AD: A001     1:	STORE	[BANK],A
03/AE: A402     	STORE	[POINTER],B
03/AF: A080     	STORE	[DBANK],A
03/B0: 9900     	LOADF	C,[B]
03/B1: 3000     	LOADI	A,0
03/B2: A080     	STORE	[DBANK],A
03/B4:          	
03/B3:          	; STORE VALUE IN MEMORY BLOCK
03/B3: 8003     5:	LOAD	A,[MB_PNTR]
03/B4: 8404     	LOAD	B,[MB_END]
03/B5: D100     	CMP	A,B
03/B6: F608     	BRZ	6F
03/B7: 8406     	LOAD	B,[CBLOCK]
03/B8: A480     	STORE	[DBANK],B
03/B9: B800     	STOREF	[A],C
03/BA: 3400     	LOADI	B,0
03/BB: A480     	STORE	[DBANK],B
03/BC: 5001     	ADDI	A,1
03/BD: A003     	STORE	[MB_PNTR],A
03/BE: FF05     	JUMP	8F
03/C0:          
03/BF:          	; ALLOC ANOTHER BLOCK
03/BF: 38C4     6:	LOADI	C,@+5
03/C0: BB00     	STOREF	[D],C
03/C1: 3402     	LOADI	B,MEM0_B
03/C2: 3895     	LOADI	C,MALLOC
03/C3: FF3D     	JUMP	INDIR
03/C5:          	
03/C4:          	; INCREMENT BLOCK POINTER
03/C4: 8001     8:	LOAD	A,[BANK]
03/C5: 8402     	LOAD	B,[POINTER]
03/C6: 5401     	ADDI	B,1
03/C7: F5E5     	BRNN	1B
03/C8: 3400     	LOADI	B,0
03/C9: 5001     	ADDI	A,1
03/CA: 3806     	LOADI	C,BUF_B+4 
03/CB: D200     	CMP	A,C
03/CC: F7E0     	BRNZ	1B
03/CD: 8000     	LOAD	A,[BLOCK]
03/CE: 5001     	ADDI	A,1
03/CF: F7D5     	BRNZ	0B
03/D1:          	
03/D0:          	; TERMINATE THE RECORD
03/D0: 8003     0:	LOAD	A,[MB_PNTR]
03/D1: 8404     	LOAD	B,[MB_END]
03/D2: 8804     	LOAD	C,[LINES]
03/D3: D100     	CMP	A,B
03/D4: 8406     	LOAD	B,[CBLOCK]
03/D5: A480     	STORE	[DBANK],B
03/D6: F102     	BRB	1F
03/D7: 34FF     	LOADI	B,0XFF
03/D8: B400     	STOREF	[A],B
03/D9: A8E6     1:	STORE	[MB_END+2-32],C
03/DB:          	
03/DA:          	; RESTORE STACK AND RETURN
03/DA: 3000     	LOADI	A,0
03/DB: 3400     9:	LOADI	B,0
03/DC: A480     	STORE	[DBANK],B
03/DD: 5C02     	ADDI	D,2
03/DE: FF23     	JUMP	IRET
03/E0:          
03/DF:          
03/DF:          	; ZERO BANK
03/DF:          .BANK	0
00/80:          .BSS
00/80:          
00/00:          	; MISC CONTEXT INFORMATION
00/00: 00       .DEFL BYTE BLOCK	0
00/01: 00       .DEFL BYTE BANK		0
00/02: 00       .DEFL BYTE POINTER	0
00/03:          
00/03:          	; MEMORY BLOCK PARSE INFORMATION
00/03: 00       .DEFL BYTE MB_PNTR	0
00/04:          .DEFL BYTE MB_END
00/04:          
00/04:          	; LINE COUNT
00/04: 00       .DEFL BYTE LINES	0
00/05:          
00/05:          	; STACK PARKING SPACE
00/05: 00       .DEFL BYTE SPARK	0
00/06:          
00/06:          	; CURRENT BLOCK OF MEMORY TO WORK ON
00/06: 0000     .DEFL BYTE CBLOCK	0,0
00/08:          
00/08:          	; BLOCK TO BE LINKED ONTO THE CURRENT BLOCK
00/08: 0000     .DEFL BYTE LBLOCK	0,0
00/0A:          
00/0A:          	; FREE MEMORY TABLE
00/0A: 0000     .DEFL BYTE FREETAB	0,0
00/0C:          
00/0C:          	; LINE EDITOR CONTENT
00/0C: 0000     .DEFL BYTE LINETAB	0,0
00/0E:          
00/0E:          	; CURRENT FILE NAME
00/0E: 00000000
       00000000 .DEFL BYTE FNAME	0,0,0,0,0,0,0,0,
00/16: 00000000
       00000000 			0,0,0,0,0,0,0,0
00/1E:          
00/1E:          	; START OF DEFINED MEMORY
00/1E:          .BANK	BD
01/00:          .DATA
01/00:          STR0_B = BD	; STRING BANK
01/00:          
01/00:          	; ERROR MESSAGES
01/00: 43414E27
       54204F50
       454E2046
       494C450A
       0D00     .DEFL BYTE ERROR0	"CAN'T OPEN FILE",0X0A,0X0D,0
01/12:          
01/12:          	; BANK IS DONE, MOVE ON TO THE NEXT
01/12:          BD	= BD+1
01/12:          BUF_B	= BD	; BUFFER BANK
01/12:          
01/12:          	; BANK IS DONE, MOVE ON TO THE NEXT
01/12:          BD	= BD+4
01/12:          HEAP	= BD	; THE REST OF MEMORY IS HEAP
