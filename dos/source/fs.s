; FS.S
; FILE SYSTEM HANDLING ROUTINES

.BANK BI
FS0_B	= BI
.TEXT
	; SET SEARCH PARAMETERS
	; USING A STRING IN USER SPACE, THE FILE SEARCH PATTERN WILL
	; BE UPDATED
	; THE FILE SEARCH POINTER WILL ALSO BE RESET
	; ASSUMES WORK BANK IS SELECTED
	; A = ADDRESS OF STRING
	; [SRC_BNK] = DATA BANK OF STRING
	; RETURNS A=0X00 IF PATTERN IS VALID, OTHERWISE 0XFF
	; USES: A, B, C, M0
SSPARAM:STORE	[M0],A
	
	; RESET THE PATTERN
	LOADI	A,PATTERN
	LOADI	B,8
	LOADI	C,'?'
0:	STOREF	[A],C
	ADDI	A,1
	SUBI	B,1
	BRNZ	0B
	
	; DO AN INITAL CHECKOUT OF THE PATTERN
	LOAD	A,[SRC_BNK]
	LOAD	B,[M0]
	STORE	[DBANK],A
	
	; MAKE SURE THERE IS ACTUALLY A PATTERN
	LOAD	C,[B]
	ADDI	C,0
	BRZ	9F
	
	; SEE IF THERE IS A USER AREA PREFIX
	LOAD	A,[B+1]
	SUBI	A,':'
	BRNZ	1F
	
	; MAKE SURE THAT THE USER AREA PREFIX IS VALID
	LOADI	A,'0'
	CMP	C,A
	BRB	9F
	LOADI	A,'9'
	CMP	C,A
	BRA	9F
	
	; SET THE WORKING USER AREA
	LOADI	A,WORK_B
	STORE	[DBANK],A
	STORE	[WRK_USR],C
	LOAD	A,[SRC_BNK]
	STORE	[DBANK],A

	
1:
	
9:	LOADI	A,0XFF
	JUMP	FS0DONE
	



	; INTERNAL FS0 FUNCTION TO RESET TO WORK BANK AND RETURN
FS0DONE:LOADI	C,WORK_B
	STORE	[DBANK],C
	JUMP	IRET

	; BANK IS DONE, MOVE ON TO THE NEXT
BI	= BI-1