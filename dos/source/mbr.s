; MBR.S
; MASTER BOOT RECORD (2ND STAGE BOOTLOADER)

; DEFINES
INDIR	= 0X01
PRGM	= 0X02
HALT	= 0X7F

DBANK	= 0X80		; DATA BANK ADDRESS 
CF	= 0XA0		; COMPACT FLASH BASE ADDRESS
CF_DATA	= CF+0X00	; CF DATA
CF_ERR	= CF+0X01	; CF ERROR
CF_FEAT	= CF+0x01	; CF FEATURES
CF_CNT	= CF+0X02	; CF SECTOR COUNT
CF_LBA0	= CF+0X03	; CF LBA BITS 0-7
CF_LBA1	= CF+0X04	; CF LBA BITS 8-15
CF_LBA2	= CF+0X05	; CF LBA BITS 16-23
CF_LBA3	= CF+0X06	; CF LBA BITS 24-27
CF_STAT	= CF+0X07	; CF STATUS
CF_CMD	= CF+0X07	; CF COMMAND

CF_READ	= 0X20		; READ COMMAND
.TEXT

	JUMP	HALT

	; READS FROM THE CF CARD
	; USING A PRE-LOADED LBA ADDRESS,
	; READ 512 BYTES INTO 4 DATA MEMORY
	; PAGES
	; A = DESTINATION PAGE(S)
CFREAD:	LOADI	B,1
	STORE	[CF_CNT]

	; WAIT FOR THE CF CARD TO BECOME READY
	; FOR THIS TO HAPPEN, THE BUSY FLAG MUST BE 0
	; AND THE READY FLAG MUST BE 1
	; IF A CF CARD ISN'T PRESENT, THIS ROUTINE HANGS
	; BUT WE DON'T CARE
	; USES: A
CFWAIT:	LOAD	A,[CF_STAT]

	; CHECK BIT 7 (BUSY FLAG)
	SHIFTL	A
	
	; GO BACK TO START BUSY
	BRC	CFWAIT
	
	; CHECK BIT 6 (READY FLAG)
	SHIFTL	A
	
	; GO BACK TO START IF NOT READY
	BRNC	CFWAIT
	
	; RETURN FROM FUNCTION CALL
	JUMPR	C
	




.DATA

