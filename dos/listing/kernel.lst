00/00:          ; COMMON.S
01/80:          ; SYSTEM COMMON DEFINITIONS
01/80:          ; GAVIN TERSTEEG, 2024
01/80:          ; SDMAY24-14
01/80:          
01/80:          ; BIOS CALLS
01/80:          BOOT	= 0
01/80:          ALTBOOT = 1
01/80:          INDIR	= 2
01/80:          IRET	= 3
01/80:          SYSCALL	= 4
01/80:          SYSJUMP	= 5
01/80:          PRGM	= 6
01/80:          IWRITE	= 7
01/80:          ZSTART	= 8
01/80:          
01/80:          ; DEFINES
01/80:          HALT	= 0X7F
01/80:          
01/80:          DBANK	= 0X80		; DATA BANK ADDRESS
01/80:          
01/80:          UART	= 0X90		; UART BASE ADDRESS
01/80:          UART_RH	= UART+0X00	; UART READ HOLDING
01/80:          UART_TH	= UART+0X00	; UART TRANSMIT HOLDING
01/80:          UART_DL = UART+0X00	; UART DIVISOR LOW
01/80:          UART_DH = UART+0X01	; UART DIVISOR HIGH
01/80:          UART_FC	= UART+0X02	; UART FIFO CONTROL
01/80:          UART_LC = UART+0X03	; UART LINE CONTROL
01/80:          UART_LS	= UART+0X05	; UART LINE STATUS
01/80:          SCRATCH	= UART+0X07	; SCRATCH BYTE ADDRESS
01/80:          
01/80:          CF	= 0XA0		; COMPACT FLASH BASE ADDRESS
01/80:          CF_DATA	= CF+0X00	; CF DATA
01/80:          CF_ERR	= CF+0X01	; CF ERROR
01/80:          CF_FEAT	= CF+0x01	; CF FEATURES
01/80:          CF_CNT	= CF+0X02	; CF SECTOR COUNT
01/80:          CF_LBA0	= CF+0X03	; CF LBA BITS 0-7
01/80:          CF_LBA1	= CF+0X04	; CF LBA BITS 8-15
01/80:          CF_LBA2	= CF+0X05	; CF LBA BITS 16-23
01/80:          CF_LBA3	= CF+0X06	; CF LBA BITS 24-27
01/80:          CF_STAT	= CF+0X07	; CF STATUS
01/80:          CF_CMD	= CF+0X07	; CF COMMAND
01/80:          
01/80:          CF_8BIT	= 0X01		; 8 BIT MODE
01/80:          CF_DCAC	= 0X82		; DISABLE CACHE
01/80:          
01/80:          CF_READ	= 0X20		; READ COMMAND
01/80:          CF_WRIT = 0X30		; WRITE COMMAND
01/80:          CF_SETF	= 0XEF		; SET FEATURE COMMAND
01/80:          
01/80:          
01/80:          ; LOW.S
01/80:          ; LOW MEMORY OF THE DOS/281 SYSTEM
01/80:          ; HANDLES SYSCALLS
01/80:          ; GAVIN TERSTEEG, 2024
01/80:          ; SDMAY24-14
01/80:          
01/80:          ; EQUATES
01/80:          KMEM_ST	= 0X78	; KERNEL MEMORY STACK SAVE SLOT
01/80:          ARG_BNK = 0x6C	; ARGUMENT BANK
01/80:          DFT_USR	= 0X6B	; DEFAULT USER AREA
01/80:          
01/80:          .BANK 0
00/80:          .TEXT
00/80:          
00/80:          	; JUMP STUB FOR RECEIVING SYSCALLS
00/80: FF03     	JUMP	SYSPREP
00/82:          
00/81:          
00/81:          	; ENTRY POINT FOR THE KERENL AFTER THE 2ND STAGE BOOT
00/81:          	; JUST JUMP DIRECTLY TO THE 'INIT' ROUTINE IN CORE 
00/81: 34FF     ENTRY:	LOADI	B,CORE0_B
00/82: 3880     	LOADI	C,INIT
00/83: FF7E     	JUMP	INDIR
00/85:          	
00/84:          	; SYSTEM CALL HANDLER PREPARATION
00/84:          	; SAVE THE PREVIOUS STACK, AND SWITCH TO THE KERNEL STACK
00/84:          	; THEN MOVE TO THE SYSTEM CALL HANDLER
00/84: AC78     SYSPREP:STORE	[KMEM_ST],D
00/86:          	
00/85:          	; GET THE ARGUMENT BANK
00/85: 8C6C     	LOAD	D,[ARG_BNK]
00/87:          	
00/86:          	; MOVE TO KERNEL WORK AREA
00/86: 38FF     	LOADI	C,WORK_B
00/87: A880     	STORE	[DBANK],C
00/89:          	
00/88:          	; SET THE SOURCE BANK
00/88: AC04     	STORE	[SRC_BNK],D
00/8A:          	
00/89:          	; SET UP KERNEL STACK
00/89: 3C7E     0:	LOADI	D,0X80-2
00/8B:          	
00/8A:          	; SAVE PLACE RETURN ADDRESS INTO THE STACK
00/8A: 3892     	LOADI	C,SYSDONE
00/8B: BB00     	STOREF	[D],C
00/8C: 3800     	LOADI	C,0
00/8D: BB01     	STOREF	[D+1],C
00/8F:          	
00/8E:          	; STICK THE CURRENT SYSTEM CALL IN M0
00/8E: A400     	STORE	[M0],B
00/90:          	
00/8F:          	; HANDLE THE SYSTEM CALL
00/8F: 34F5     	LOADI	B,SYS0_B
00/90: 3880     	LOADI	C,SYSHNDL
00/91: FF70     	JUMP	INDIR
00/93:          	
00/92:          	
00/92:          	; SYSTEM CALL DONE
00/92: 3800     SYSDONE:LOADI	C,0
00/93: A880     	STORE	[DBANK],C
00/95:          	
00/94:          	; RESTORE USER STACK
00/94: 8C78     	LOAD	D,[KMEM_ST]
00/96:          	
00/95:          	; RETURN
00/95: FF6D     	JUMP	IRET
00/97:          	
00/96:          .DATA
00/96:          
00/00:          	; SET UP ZERO PAGE
00/00:          .ORG	0X6B
00/6B: 30       .DEF BYTE	'0'
00/6C:          
00/6C:          
00/6C:          
00/6C:          	; SET UP UPPER BANK STUFF
00/6C:          	; THE 'B_' SYMBOLS WILL BE USED TO KEEP TRACK OF WHAT BANKS ARE
00/6C:          	; IN USE
00/6C:          	; 'BI" WILL BE USED FOR INSTRUCTION BANKS
00/6C:          	; 'BD' WILL BE USED FOR DATA BANKS
00/6C:          	; AT THE END OF ASSEMBLY, THESE VALUES WILL BE USED TO DETERMINE
00/6C:          	; HOW MUCH FREE MEMORY USER PROGRAMS HAVE
00/6C:          BI	= 255
00/6C:          BD	= 255
00/6C:          
00/6C:          
00/6C:          ; CORE.S
00/6C:          ; MAIN 'GUTS' OF DOS/281
00/6C:          ; GAVIN TERSTEEG, 2024
00/6C:          ; SDMAY24-14
00/6C:          
00/6C:          .BANK BI
FF/00:          CORE0_B	= BI
FF/00:          .TEXT
FF/00:          
FF/80:          	; SET UP SYSTEM FOR OPERATION
FF/80:          	; BRING UP THE WORK BANK
FF/80: 30FF     INIT:	LOADI	A,WORK_B
FF/81: A080     	STORE	[DBANK],A
FF/83:          	
FF/82:          	; SET THE STACK POINTER TO THE TOP OF THE STACK
FF/82: 3C7E     	LOADI	D,0X80-2
FF/84:          
FF/83:          	; INITALIZE THE TTY DRIVER
FF/83: 38FF     	LOADI	C,BI
FF/84: BB01     	STOREF	[D+1],C
FF/85: 388A     	LOADI	C,@+5
FF/86: BB00     	STOREF	[D],C
FF/88:          	
FF/87: 34FC     	LOADI	B,TTY0_B
FF/88: 3880     	LOADI	C,TTYINIT
FF/89: FF78     	JUMP	INDIR
FF/8B:          	
FF/8A:          	; INITALIZE THE PRINTER DRIVER
FF/8A: 388F     	LOADI	C,@+5
FF/8B: BB00     	STOREF	[D],C
FF/8D:          	
FF/8C: 34FA     	LOADI	B,PRT0_B
FF/8D: 3880     	LOADI	C,PRTINIT
FF/8E: FF73     	JUMP	INDIR
FF/90:          	
FF/8F:          	; INITALIZE THE AUX DRIVER
FF/8F: 3894     	LOADI	C,@+5
FF/90: BB00     	STOREF	[D],C
FF/92:          	
FF/91: 34F9     	LOADI	B,AUX0_B
FF/92: 3880     	LOADI	C,AUXINIT
FF/93: FF6E     	JUMP	INDIR
FF/95:          	
FF/94:          	; SEND OUT THE 'HELLO' SPLASH
FF/94: 38FF     	LOADI	C,WORK_B
FF/95: A804     	STORE	[SRC_BNK],C
FF/96: 3060     	LOADI	A,S_HELLO
FF/98:          	
FF/97: 389C     	LOADI	C,@+5
FF/98: BB00     	STOREF	[D],C
FF/9A:          	
FF/99: 34FC     	LOADI	B,TTY0_B
FF/9A: 3890     	LOADI	C,TTYPUTS
FF/9B: FF66     	JUMP	INDIR
FF/9D:          	
FF/9C:          	; INITALIZE THE BLOCK DRIVER
FF/9C: 38A1     	LOADI	C,@+5
FF/9D: BB00     	STOREF	[D],C
FF/9F:          	
FF/9E: 34FB     	LOADI	B,BLK0_B
FF/9F: 3880     	LOADI	C,BLKINIT
FF/A0: FF61     	JUMP	INDIR
FF/A2:          	
FF/A1:          	; INDEX ALLOCATION BITMAP
FF/A1: 3000     	LOADI	A,0X00
FF/A2: 38A7     	LOADI	C,@+5
FF/A3: BB00     	STOREF	[D],C
FF/A5:          	
FF/A4: 34F2     	LOADI	B,AL0_B
FF/A5: 38B5     	LOADI	C,INDEX
FF/A6: FF5B     	JUMP	INDIR
FF/A8:          	
FF/A7:          	; CHECK AUTO MODE
FF/A7: 34FD     DOCMD:	LOADI	B,AUTO_B
FF/A8: A480     	STORE	[DBANK],B
FF/A9: 8000     	LOAD	A,[AU_RUN]
FF/AA: 34FF     	LOADI	B,WORK_B
FF/AB: A480     	STORE	[DBANK],B
FF/AC: 5000     	ADDI	A,0
FF/AD: F613     	BRZ	PROMPT
FF/AF:          	
FF/AE:          	; LOOK FOR A CTRL+C
FF/AE: 38FF     	LOADI	C,BI
FF/AF: BB01     	STOREF	[D+1],C
FF/B0: 38B5     	LOADI	C,@+5
FF/B1: BB00     	STOREF	[D],C
FF/B3:          	
FF/B2: 34FC     	LOADI	B,TTY0_B
FF/B3: 38E6     	LOADI	C,TTYSTAT
FF/B4: FF4D     	JUMP	INDIR
FF/B5: 5000     	ADDI	A,0
FF/B6: F607     	BRZ	1F
FF/B8:          	
FF/B7: 38BC     	LOADI	C,@+5
FF/B8: BB00     	STOREF	[D],C
FF/BA:          	
FF/B9: 34FC     	LOADI	B,TTY0_B
FF/BA: 389D     	LOADI	C,TTYGETC
FF/BB: FF46     	JUMP	INDIR
FF/BC: 7003     	SUBI	A,0X03	; CTRL+C
FF/BD: F603     	BRZ	PROMPT
FF/BF:          	
FF/BE:          	; GO READ FROM THE AUTO FILE
FF/BE: 34FD     1:	LOADI	B,CORE2_B
FF/BF: 3880     	LOADI	C,GETAUTO
FF/C0: FF41     	JUMP	INDIR
FF/C2:          	
FF/C1:          	; DOT PROMPT
FF/C1: 301C     PROMPT: LOADI	A,ST_PRMT
FF/C2: 38FF     CPRMPT:	LOADI	C,WORK_B	; USED FOR CUSTOM PROMPTS
FF/C3: A880     	STORE	[DBANK],C
FF/C4: A804     	STORE	[SRC_BNK],C
FF/C6:          
FF/C5: 38FF     	LOADI	C,BI
FF/C6: BB01     	STOREF	[D+1],C
FF/C7: 38CC     	LOADI	C,@+5
FF/C8: BB00     	STOREF	[D],C
FF/CA:          	
FF/C9: 34FC     	LOADI	B,TTY0_B
FF/CA: 3890     	LOADI	C,TTYPUTS
FF/CB: FF36     	JUMP	INDIR
FF/CD:          	
FF/CC:          	; QUICKLY TURN OFF AUTO MODE
FF/CC: 3000     	LOADI	A,0
FF/CD: 34FD     	LOADI	B,AUTO_B
FF/CE: A480     	STORE	[DBANK],B
FF/CF: A000     	STORE	[AU_RUN],A
FF/D0: 34FF     	LOADI	B,WORK_B
FF/D1: A480     	STORE	[DBANK],B
FF/D3:          	
FF/D2:          	; GET AN INPUT FROM THE TERMINAL
FF/D2: 38FE     	LOADI	C,CMDL_B
FF/D3: A804     	STORE	[SRC_BNK],C
FF/D5:          	
FF/D4: 38D9     	LOADI	C,@+5
FF/D5: BB00     	STOREF	[D],C
FF/D7:          	
FF/D6: 34FC     	LOADI	B,TTY0_B
FF/D7: 38A2     	LOADI	C,TTYINPT
FF/D8: FF29     	JUMP	INDIR
FF/DA:          	
FF/D9:          	; DO CR / LF
FF/D9: 300D     	LOADI	A,0X0D
FF/DA: 38DF     	LOADI	C,@+5
FF/DB: BB00     	STOREF	[D],C
FF/DD:          	
FF/DC: 34FC     	LOADI	B,TTY0_B
FF/DD: 3889     	LOADI	C,TTYPUTC
FF/DE: FF23     	JUMP	INDIR
FF/E0:          	
FF/DF: 300A     	LOADI	A,0X0A
FF/E0: 38E5     	LOADI	C,@+5
FF/E1: BB00     	STOREF	[D],C
FF/E3:          	
FF/E2: 34FC     	LOADI	B,TTY0_B
FF/E3: 3889     	LOADI	C,TTYPUTC
FF/E4: FF1D     	JUMP	INDIR
FF/E6:          	
FF/E5:          	; NOW, EXECUTE THE COMMAND
FF/E5: 34FE     	LOADI	B,CORE1_B
FF/E6: 3880     	LOADI	C,EXEC
FF/E7: FF1A     	JUMP	INDIR
FF/E9:          
FF/E8:          	; BANK IS DONE, MOVE ON TO THE NEXT
FF/E8:          BI	= BI-1
FF/E8:          .BANK BI
FE/80:          CORE1_B	= BI
FE/80:          .TEXT
FE/80:          
FE/80:          	; ATTEMPT TO EXECUTE WHATEVER HAS BEEN PLACE IN THE CMD
FE/80:          	; BUFFER
FE/80:          	; START BY CLOSING THE FILE
FE/80: 38FE     EXEC:	LOADI	C,BI
FE/81: BB01     	STOREF	[D+1],C
FE/82: 3887     	LOADI	C,@+5
FE/83: BB00     	STOREF	[D],C
FE/85:          	
FE/84: 34F8     	LOADI	B,FS0_B
FE/85: 38E6     	LOADI	C,FCLOSE
FE/86: FF7B     	JUMP	INDIR	
FE/88:          	
FE/87:          	; SET WORKING USER AREA TO '0'
FE/87: 3030     	LOADI	A,'0'
FE/88: A008     	STORE	[WRK_USR],A
FE/8A:          
FE/89:          	; CHECK FOR "&"
FE/89: 3000     	LOADI	A,0
FE/8A: 34FE     	LOADI	B,CMDL_B
FE/8B: A480     	STORE	[DBANK],B
FE/8C: 8800     	LOAD	C,[0]
FE/8D: 34FF     	LOADI	B,WORK_B
FE/8E: A480     	STORE	[DBANK],B
FE/8F: 5800     	ADDI	C,0
FE/90: F606     	BRZ	1F
FE/91: 7826     	SUBI	C,'&'
FE/92: F701     	BRNZ	0F
FE/93: 5001     	ADDI	A,1
FE/94: A027     0:	STORE	[EX_HALT],A
FE/95: 7814     	SUBI	C,':'-'&'
FE/96: F703     	BRNZ	0F
FE/98:          	
FE/97:          	; COMMENT
FE/97: 34FF     1:	LOADI	B,CORE0_B
FE/98: 38A7     	LOADI	C,DOCMD
FE/99: FF68     	JUMP	INDIR
FE/9B:          
FE/9A:          	; ATTEMPT TO SET PARAMETERS FOR SEARCH
FE/9A: 389F     0:	LOADI	C,@+5
FE/9B: BB00     	STOREF	[D],C
FE/9D:          	
FE/9C: 34F8     	LOADI	B,FS0_B
FE/9D: 3880     	LOADI	C,SSPARAM
FE/9E: FF63     	JUMP	INDIR
FE/A0:          	
FE/9F:          	; CHECK TO MAKE SURE IT RETURNS 0XFE
FE/9F: 70FE     	SUBI	A,0XFE
FE/A0: F75B     	BRNZ	EXECERR
FE/A2:          	
FE/A1:          	; MANUALLY SET THE EXTENSION AS 'SV'
FE/A1: 3053     	LOADI	A,'S'
FE/A2: A00F     	STORE	[PATTERN+6],A
FE/A3: 3056     	LOADI	A,'V'
FE/A4: A010     	STORE	[PATTERN+7],A
FE/A6:          	
FE/A5:          	; AND SEARCH FOR IT
FE/A5: 3000     	LOADI	A,0
FE/A6: 38AB     	LOADI	C,@+5
FE/A7: BB00     	STOREF	[D],C
FE/A9:          	
FE/A8: 34F8     	LOADI	B,FS0_B
FE/A9: 38D9     	LOADI	C,FSEARCH
FE/AA: FF57     	JUMP	INDIR
FE/AC:          	
FE/AB:          	; DID IT WORK?
FE/AB: 5000     	ADDI	A,0
FE/AC: F74F     	BRNZ	EXECERR
FE/AE:          	
FE/AD:          	; NOW OPEN IT
FE/AD: 38B2     	LOADI	C,@+5
FE/AE: BB00     	STOREF	[D],C
FE/B0:          	
FE/AF: 34F8     	LOADI	B,FS0_B
FE/B0: 38E3     	LOADI	C,FOPEN
FE/B1: FF50     	JUMP	INDIR
FE/B3:          	
FE/B2:          	; RESET LOAD STATE
FE/B2: 30F1     	LOADI	A,KBUF_B
FE/B3: A004     	STORE	[SRC_BNK],A
FE/B4: 3000     	LOADI	A,0
FE/B6:          	
FE/B5:          	; READ IN THE SAV RECORD
FE/B5: A028     0:	STORE	[EX_BLK],A
FE/B6: 38BB     	LOADI	C,@+5
FE/B7: BB00     	STOREF	[D],C
FE/B9:          	
FE/B8: 34F8     	LOADI	B,FS0_B
FE/B9: 38E9     	LOADI	C,FREAD
FE/BA: FF47     	JUMP	INDIR
FE/BC:          	
FE/BB:          	; SAVE THE STACK
FE/BB: AC00     	STORE	[M0],D
FE/BD:          	
FE/BC:          	; MAKE SURE THE READ WORKED
FE/BC: 5000     	ADDI	A,0
FE/BD: F73E     	BRNZ	EXECERR
FE/BF:          	
FE/BE:          	; CHECK THAT THE RECORD IS VALID
FE/BE: 30F1     	LOADI	A,KBUF_B
FE/BF: A080     	STORE	[DBANK],A
FE/C1:          	
FE/C0:          	; LOOK FOR THE 0X0281 AT THE BEGINNING OF THE RECORD
FE/C0: 8000     	LOAD	A,[0X00]
FE/C1: 7002     	SUBI	A,0X02
FE/C2: F739     	BRNZ	EXECERR
FE/C3: 8001     	LOAD	A,[0X01]
FE/C4: 7081     	SUBI	A,0X81
FE/C5: F736     	BRNZ	EXECERR
FE/C7:          	
FE/C6:          	; GRAB THE DESTINATION SECTOR
FE/C6: 8002     	LOAD	A,[0X02]
FE/C8:          	
FE/C7:          	; NO BANK 0!
FE/C7: 5000     	ADDI	A,0
FE/C8: F633     	BRZ	EXECERR
FE/CA:          	
FE/C9:          	; MAKE SURE IT ISN'T TOO BIG TOO
FE/C9: 34EC     	LOADI	B,MAX_IB
FE/CA: D100     	CMP	A,B
FE/CB: F030     	BRAE	EXECERR
FE/CC: 34F0     	LOADI	B,MAX_DB
FE/CD: D100     	CMP	A,B
FE/CE: F02D     	BRAE	EXECERR
FE/D0:          	
FE/CF:          	; AND LOAD UP THE DATA BLOCK
FE/CF: 3800     	LOADI	C,0
FE/D0: 34F2     1:	LOADI	B,KBUF_B+1
FE/D1: A480     	STORE	[DBANK],B
FE/D2: 9600     	LOADF	B,[C]
FE/D3: A080     	STORE	[DBANK],A
FE/D4: B600     	STOREF	[C],B
FE/D5: 5801     	ADDI	C,1
FE/D6: F5F9     	BRNN	1B
FE/D8:          	
FE/D7:          	; FINALLY, LOAD UP THE ISR BLOCK
FE/D7: 34F3     	LOADI	B,KBUF_B+2
FE/D8: 3CFE     	LOADI	D,BI
FE/D9: 38DB     	LOADI	C,@+2
FE/DA: FF2B     	JUMP	PRGM
FE/DC:          	
FE/DB:          	; RESTORE THE STACK AND WORK AREA
FE/DB: 30FF     	LOADI	A,WORK_B
FE/DC: A080     	STORE	[DBANK],A
FE/DD: 8C00     	LOAD	D,[M0]
FE/DF:          	
FE/DE:          	; EITHER MOVE ON TO THE NEXT BLOCK OR EXIT
FE/DE: 8028     	LOAD	A,[EX_BLK]
FE/DF: 8419     	LOAD	B,[OF_SIZE+1]
FE/E0: 5001     	ADDI	A,1
FE/E1: D100     	CMP	A,B
FE/E2: F7D2     	BRNZ	0B
FE/E4:          	
FE/E3:          	; COMMIT TO EXECUTION
FE/E3: 8C27     	LOAD	D,[EX_HALT]
FE/E5:          	
FE/E4:          	; SET SYSTEM VARIABLES
FE/E4: 3400     	LOADI	B,0
FE/E5: A480     	STORE	[DBANK],B
FE/E6: 34EC     	LOADI	B,MAX_IB
FE/E7: A470     	STORE	[0X70],B
FE/E8: 34F0     	LOADI	B,MAX_DB
FE/E9: A471     	STORE	[0X71],B
FE/EA: 34FE     	LOADI	B,CMDL_B
FE/EB: A472     	STORE	[0X72],B
FE/EC: 34FD     	LOADI	B,AUTO_B
FE/ED: A473     	STORE	[0X73],B
FE/EF:          	
FE/EE:          	; "REFRESH" BANK 1 DISPLAY
FE/EE: 3401     	LOADI	B,1
FE/EF: A480     	STORE	[DBANK],B
FE/F0: 3407     	LOADI	B,7
FE/F1: 9100     2:	LOADF	A,[B]
FE/F2: B100     	STOREF	[B],A
FE/F3: 7401     	SUBI	B,1
FE/F4: F0FC     	BRC	2B
FE/F6:          	
FE/F5:          	; RUN THE PROGRAM
FE/F5: 7C01     	SUBI	D,1
FE/F6: 3401     	LOADI	B,1
FE/F7: 3880     	LOADI	C,0X80
FE/F8: F709     	BRNZ	INDIR
FE/FA:          	
FE/F9:          	; DO A ZSTART IF WE ARE HALTING
FE/F9: 3400     	LOADI	B,0
FE/FA: 3800     	LOADI	C,0
FE/FB: FF0C     	JUMP	ZSTART
FE/FD:          
FE/FC:          	; HANDLE ERROR IN EXEC
FE/FC: 301B     EXECERR:LOADI	A,ST_ERR
FE/FD: 34FF     	LOADI	B,CORE0_B
FE/FE: 38C2     	LOADI	C,CPRMPT
FE/FF: FF02     	JUMP	INDIR
FE/101:          	
FE/00:          	; BANK IS DONE, MOVE ON TO THE NEXT
FE/00:          BI	= BI-1
FE/00:          .BANK BI
FD/80:          CORE2_B	= BI
FD/80:          .TEXT
FD/80:          
FD/80:          
FD/80:          	; GET A LINE FROM THE AUTO FILE
FD/80: 38FD     GETAUTO:LOADI	C,BI
FD/81: BB01     	STOREF	[D+1],C
FD/82: 3887     	LOADI	C,@+5
FD/83: BB00     	STOREF	[D],C
FD/85:          	
FD/84: 34F8     	LOADI	B,FS0_B
FD/85: 38E6     	LOADI	C,FCLOSE
FD/86: FF7B     	JUMP	INDIR	
FD/88:          	
FD/87:          	; SET WORKING USER AREA TO AU_UA
FD/87: 34FD     	LOADI	B,AUTO_B
FD/88: A480     	STORE	[DBANK],B
FD/89: 8004     	LOAD	A,[AU_UA]
FD/8A: 34FF     	LOADI	B,WORK_B
FD/8B: A480     	STORE	[DBANK],B
FD/8C: A008     	STORE	[WRK_USR],A
FD/8E:          
FD/8D:          	; ATTEMPT TO SET PARAMETERS FOR SEARCH
FD/8D: 30FD     	LOADI	A,AUTO_B
FD/8E: A004     	STORE	[SRC_BNK],A
FD/8F: 3006     	LOADI	A,AU_FILE
FD/90: 3895     	LOADI	C,@+5
FD/91: BB00     	STOREF	[D],C
FD/93:          	
FD/92: 34F8     	LOADI	B,FS0_B
FD/93: 3880     	LOADI	C,SSPARAM
FD/94: FF6D     	JUMP	INDIR
FD/96:          	
FD/95:          	; CHECK TO MAKE SURE IT RETURNS 0X00
FD/95: 5000     	ADDI	A,0
FD/96: F762     	BRNZ	AUTOERR
FD/98:          	
FD/97:          	; AND SEARCH FOR IT
FD/97: 3000     	LOADI	A,0
FD/98: 389D     	LOADI	C,@+5
FD/99: BB00     	STOREF	[D],C
FD/9B:          	
FD/9A: 34F8     	LOADI	B,FS0_B
FD/9B: 38D9     	LOADI	C,FSEARCH
FD/9C: FF65     	JUMP	INDIR
FD/9E:          	
FD/9D:          	; DID IT WORK?
FD/9D: 5000     	ADDI	A,0
FD/9E: F75A     	BRNZ	AUTOERR
FD/A0:          	
FD/9F:          	; NOW OPEN IT
FD/9F: 38A4     	LOADI	C,@+5
FD/A0: BB00     	STOREF	[D],C
FD/A2:          	
FD/A1: 34F8     	LOADI	B,FS0_B
FD/A2: 38E3     	LOADI	C,FOPEN
FD/A3: FF5E     	JUMP	INDIR
FD/A5:          	
FD/A4:          	; RESET POINTER AND SOURCE BUFFER
FD/A4: 3000     	LOADI	A,0
FD/A5: A029     	STORE	[EX_PNTR],A
FD/A6: A02A     	STORE	[EX_LAST],A
FD/A7: 30F1     	LOADI	A,KBUF_B
FD/A8: A004     	STORE	[SRC_BNK],A
FD/AA:          
FD/A9:          	; GRAB THE CURRENT BLOCK
FD/A9: 34FD     0:	LOADI	B,AUTO_B
FD/AA: A480     	STORE	[DBANK],B
FD/AB: 8003     	LOAD	A,[AU_BLK]
FD/AC: 34FF     	LOADI	B,WORK_B
FD/AD: A480     	STORE	[DBANK],B
FD/AF:          	
FD/AE:          	; READ BLOCK
FD/AE: 38B3     	LOADI	C,@+5
FD/AF: BB00     	STOREF	[D],C
FD/B1:          	
FD/B0: 34F8     	LOADI	B,FS0_B
FD/B1: 38E9     	LOADI	C,FREAD
FD/B2: FF4F     	JUMP	INDIR
FD/B3: 5000     	ADDI	A,0
FD/B4: F732     	BRNZ	8F
FD/B6:          
FD/B5:          	; GET A CHARACTER
FD/B5: 38FD     	LOADI	C,AUTO_B
FD/B6: A880     	STORE	[DBANK],C
FD/B7: 8001     	LOAD	A,[AU_PNTR]
FD/B8: 8402     	LOAD	B,[AU_BANK]
FD/BA:          
FD/B9: A001     1:	STORE	[AU_PNTR],A
FD/BA: A402     	STORE	[AU_BANK],B
FD/BC:          	
FD/BB:          	; CHECK LAST
FD/BB: 38FF     	LOADI	C,WORK_B
FD/BC: A880     	STORE	[DBANK],C
FD/BD: 882A     	LOAD	C,[EX_LAST]
FD/BE: 780A     	SUBI	C,0X0A
FD/BF: F62D     	BRZ	9F
FD/C1:          
FD/C0:          	; READ IT FROM THE BLOCK
FD/C0: 38F1     	LOADI	C,KBUF_B
FD/C1: 4900     	ADD	C,B
FD/C2: A880     	STORE	[DBANK],C
FD/C3: 9000     	LOADF	A,[A]
FD/C4: 38FF     	LOADI	C,WORK_B
FD/C5: A880     	STORE	[DBANK],C
FD/C7:          	
FD/C6:          	; CHECK ZERO
FD/C6: 5000     	ADDI	A,0
FD/C7: F61F     	BRZ	8F
FD/C9:          	
FD/C8:          	; INCREMENT CMDL POINTER
FD/C8: 8429     	LOAD	B,[EX_PNTR]
FD/C9: 3801     	LOADI	C,1
FD/CA: 4900     	ADD	C,B
FD/CB: F40A     	BRN	3F
FD/CD:          	
FD/CC:          	; SKIP 0X0D
FD/CC: A02A     	STORE	[EX_LAST],A
FD/CD: 700D     	SUBI	A,0X0D
FD/CE: F607     	BRZ	3F
FD/CF: 70FD     	SUBI	A,0X0A-0X0D
FD/D0: F605     	BRZ	3F
FD/D1: 500A     	ADDI	A,0X0A
FD/D2: A829     	STORE	[EX_PNTR],C
FD/D4:          	
FD/D3:          	; STORE IN CMDL
FD/D3: 38FE     	LOADI	C,CMDL_B
FD/D4: A880     	STORE	[DBANK],C
FD/D5: B100     	STOREF	[B],A
FD/D7:          	
FD/D6:          	; NEXT CHARACTER
FD/D6: 38FD     3:	LOADI	C,AUTO_B
FD/D7: A880     	STORE	[DBANK],C
FD/D8: 8001     	LOAD	A,[AU_PNTR]
FD/D9: 8402     	LOAD	B,[AU_BANK]
FD/DA: 5001     	ADDI	A,1
FD/DB: F5DD     	BRNN	1B
FD/DC: 3000     	LOADI	A,0
FD/DD: 5401     	ADDI	B,1
FD/DE: 3804     	LOADI	C,4
FD/DF: D600     	CMP	B,C
FD/E0: F1D8     	BRB	1B
FD/E2:          	
FD/E1:          	; INCREMENT BLOCK
FD/E1: A001     	STORE	[AU_PNTR],A
FD/E2: A002     	STORE	[AU_BANK],A
FD/E3: 8003     	LOAD	A,[AU_BLK]
FD/E4: 5001     	ADDI	A,1
FD/E5: A003     	STORE	[AU_BLK],A
FD/E6: F1C2     	BRNC	0B
FD/E8:          
FD/E7:          	; TURN OFF FLAG
FD/E7: 38FD     8:	LOADI	C,AUTO_B
FD/E8: A880     	STORE	[DBANK],C
FD/E9: 3000     	LOADI	A,0
FD/EA: A000     	STORE	[AU_RUN],A
FD/EB: 30FF     	LOADI	A,WORK_B
FD/EC: A080     	STORE	[DBANK],A
FD/EE:          
FD/ED:          	; TERMINATE AND EXECUTE
FD/ED: 3000     9: 	LOADI	A,0
FD/EE: 8829     	LOAD	C,[EX_PNTR]
FD/EF: 34FE     	LOADI	B,CMDL_B
FD/F0: A480     	STORE	[DBANK],B
FD/F1: B200     	STOREF	[C],A
FD/F2: 34FF     	LOADI	B,WORK_B
FD/F3: A480     	STORE	[DBANK],B
FD/F4: 30FE     	LOADI	A,CMDL_B
FD/F5: A004     	STORE	[SRC_BNK],A
FD/F6: 34FE     	LOADI	B,CORE1_B
FD/F7: 3880     	LOADI	C,EXEC
FD/F8: FF09     	JUMP	INDIR
FD/FA:          	
FD/F9:          	; HANDLE ERROR IN AUTO
FD/F9: 30FF     AUTOERR:LOADI	A,WORK_B
FD/FA: A080     	STORE	[DBANK],A
FD/FB: 34FF     	LOADI	B,CORE0_B
FD/FC: 38C1     	LOADI	C,PROMPT
FD/FD: FF04     	JUMP	INDIR
FD/FF:          
FD/FE:          	; BANK IS DONE, MOVE ON TO THE NEXT
FD/FE:          BI	= BI-1
FD/FE:          
FD/FE:          	; ALLOCATE A BANK FOR THE KERNEL WORK AREA
FD/FE:          	; 0X60-7F = KERNEL STACK SPACE
FD/FE:          .BANK	BD
FF/E8:          WORK_B	= BD
FF/E8:          .DATA
FF/E8:          
FF/00:          	; MISC VALUES
FF/00:          	; USED AS TEMP REGISTERS FOR ALL SORTS OF STUFF
FF/00: 00       .DEFL BYTE M0		0
FF/01: 00       .DEFL BYTE M1		0
FF/02: 00       .DEFL BYTE M2		0
FF/03:          
FF/03:          	; DEVICE SPECIFIC MISC VALUES
FF/03:          	; SAFE TO USE IN DEVICE DRIVERS
FF/03: 00       .DEFL BYTE D0		0
FF/04:          
FF/04:          	; SOURCE BANK OF WHATEVER OPERATION IS BEING DONE
FF/04:          	; MAINLY USED TO KEEP TRACK OF THE BANK ADDRESS
FF/04:          	; OF STUFF BEING WORKED ON IN USER SPACE
FF/04: 00       .DEFL BYTE SRC_BNK	0
FF/05:          
FF/05:          	; ADDRESSES FOR THE BLOCK DEVICE DRIVER
FF/05:          	; USED DURING A 'READ' OR 'WRITE' CALL
FF/05: 0000     .DEFL BYTE BLK		0,0
FF/07:          
FF/07:          	; PATTERN FOR SEARCHING FOR FILES
FF/07:          	; AND WORKING USER AREA
FF/07: FF       .DEFL BYTE MATCH	0XFF	; THIS IS ALWAYS 0XFF
FF/08: 30       .DEFL BYTE WRK_USR	'0'
FF/09: 2D2D2D2D
       2D2D2D2D .DEFL BYTE PATTERN	"--------"
FF/11:          
FF/11:          	; STATE INFORMATION FOR SEARCHING 
FF/11: 00       .DEFL BYTE SRCH_LO	0	; LOW BLOCK
FF/12: 00       .DEFL BYTE SRCH_BK	0	; CURRENT BANK
FF/13: 00       .DEFL BYTE SRCH_RP	0	; RECORD POINTER
FF/14: 00       .DEFL BYTE SRCH_LS	0	; LAST ENDING
FF/15:          
FF/15:          	; STATE INFORMATION FOR OPEN FILES
FF/15: 00       .DEFL BYTE OF_OPEN	0	; OF_OPEN = 1 IF THERE IS A FILE OPEN
FF/16: 0000     .DEFL BYTE OF_BTAB	0,0	; BLOCK TABLE ADDRESS
FF/18: 0000     .DEFL BYTE OF_SIZE	0,0	; OPEN FILE SIZE
FF/1A: 00       .DEFL BYTE OF_DRTY	0	; OPEN FILE IS DIRTY
FF/1B:          
FF/1B:          	; ERROR
FF/1B: 3F       .DEFL BYTE ST_ERR	"?"
FF/1C:          
FF/1C:          	; COMMAND LINE PROMPT
FF/1C: 0A0D2E00 .DEFL BYTE ST_PRMT	0X0A,0X0D,'.',0
FF/20:          
FF/20:          	; STATE INFORMATION FOR ALLOCATION BITMAP
FF/20: 00       .DEFL BYTE AB_CBLK	0	; CURRENT BLOCK IN THE ALLOCATION TABLE
FF/21: 00       .DEFL BYTE AB_DRTY	0	; IS ALLOCATION BLOCK DIRTY?
FF/22: 00       .DEFL BYTE AB_BANK	0	; CURRENT BANK
FF/23: 00       .DEFL BYTE AB_CPNT	0	; CHUNK POINTER
FF/24: 00       .DEFL BYTE AB_BIT	0	; CHUNK BIT
FF/25: 0000     .DEFL BYTE AB_FREE	0,0	; BLOCK TO FREE
FF/27:          
FF/27:          	; PROGRAM EXECUTION INFORMATION
FF/27: 00       .DEFL BYTE EX_HALT	0	; HALT PROGRAM ON EXECUTION
FF/28: 00       .DEFL BYTE EX_BLK	0	; BLOCK POINTER FOR EXEC
FF/29: 00       .DEFL BYTE EX_PNTR	0	; POINTER INTO CMDL BUFFER
FF/2A: 00       .DEFL BYTE EX_LAST	0	; LAST CHARACTER PUT IN CMDL
FF/2B:          
FF/2B:          	; EMPTY PATTERN USED TO FIND UNUSED FILE RECORDS
FF/2B: 003F3F3F
       3F3F3F3F
       3F3F     .DEFL BYTE EMPTYP	0X00,'?',"????????"
FF/35:          
FF/35:          	; PLACE 'HELLO' AT BOTTOM  OF STACK
FF/35:          	; WE DON'T CARE IF IT GETS OVERWRITTEN LATER
FF/35:          .ORG 0X60
FF/60: 444F532F
       32383120
       56312E34
       0A0D00   .DEFL BYTE S_HELLO	"DOS/281 V1.4",0X0A,0X0D,0
FF/6F:          
FF/6F:          
FF/6F:          	; BANK IS DONE, MOVE ON TO THE NEXT
FF/6F:          BD	= BD-1
FF/6F:          
FF/6F:          	; COMMAND LINE BANK
FF/6F:          CMDL_B	= BD
FF/6F:          
FF/6F:          	; BANK IS DONE, MOVE ON TO THE NEXT
FF/6F:          BD	= BD-1
FF/6F:          
FF/6F:          	; AUTO EXECUTE STATE
FF/6F:          .BANK BD
FD/00:          AUTO_B	= BD
FD/00:          .DATA
FD/00:          
FD/00: FF       .DEFL BYTE AU_RUN	0XFF
FD/01: 00       .DEFL BYTE AU_PNTR	0
FD/02: 00       .DEFL BYTE AU_BANK	0
FD/03: 00       .DEFL BYTE AU_BLK	0
FD/04: 00       .DEFL BYTE AU_UA	0
FD/05: 00       .DEFL BYTE AU_DRV	0
FD/06: 313A4155
       544F2E53
       4800     .DEFL BYTE AU_FILE	"1:AUTO.SH",0
FD/10:          
FD/10:          AU_MISC	= 0X18
FD/10:          
FD/10:          	; BANK IS DONE, MOVE ON TO THE NEXT
FD/10:          BD	= BD-4
FD/10:          	
FD/10:          	; ALLOCATION BITMAP BUFFER
FD/10:          ABM_B	= BD
FD/10:          
FD/10:          	; BANK IS DONE, MOVE ON TO THE NEXT
FD/10:          BD	= BD-4
FD/10:          
FD/10:          	; FILE BLOCK TABLE
FD/10:          FBT_B	= BD
FD/10:          
FD/10:          	; BANK IS DONE, MOVE ON TO THE NEXT
FD/10:          BD	= BD-4
FD/10:          
FD/10:          	; KERNEL BUFFER
FD/10:          KBUF_B	= BD
FD/10:          
FD/10:          	; BANK IS DONE, MOVE ON TO THE NEXT
FD/10:          BD	= BD-1
FD/10:          
FD/10:          ; TTY.S
FD/10:          ; SERIAL CONSOLE DRIVER
FD/10:          ; GAVIN TERSTEEG, 2024
FD/10:          ; SDMAY24-14
FD/10:          
FD/10:          .BANK BI
FC/00:          TTY0_B	= BI
FC/00:          .TEXT
FC/00:          
FC/80:          	; SERIAL INIT
FC/80:          	; SET UP THE 16C550 UART
FC/80:          	; ASSUMES WORK BANK IS SELECTED
FC/80:          	; USES: A, B, C
FC/80: 3080     TTYINIT:LOADI	A,0X80
FC/81: A093     	STORE	[UART_LC],A
FC/83:          	
FC/82:          	; DIVISOR = 12
FC/82:          	; FOR 9600B @ 1.843, 19200B @ 3.604
FC/82: 300C     	LOADI	A,12
FC/83: A090     	STORE	[UART_DL],A
FC/84: 3000     	LOADI	A,0
FC/85: A091     	STORE	[UART_DH],A
FC/87:          	
FC/86:          	; TURN ON THE FIFO
FC/86:          	; LOADI	A,0X01
FC/86:          	; STORE	[UART_FC],A
FC/86:          	
FC/86:          	; SET 8-BIT, 1 STOP, RESET DLAB
FC/86: 3003     	LOADI	A,0X03
FC/87: A093     	STORE	[UART_LC],A
FC/89:          
FC/88: FF62     	JUMP	TTYDONE
FC/8A:          
FC/89:          	; PUTS A CHARACTER ONTO THE TERMINAL
FC/89:          	; ASSUMES WORK BANK IS SELECTED
FC/89:          	; A = CHARACTER TO PRINT
FC/89:          	; USES: B
FC/89: 8495     TTYPUTC:LOAD	B,[UART_LS]
FC/8B:          
FC/8A:          	; READ 5TH BIT TO SEE IF WE CAN TRANSMIT YET
FC/8A: 4500     	SHIFTL	B
FC/8B: 4500     	SHIFTL	B
FC/8C: 4500     	SHIFTL	B
FC/8D: F1FB     	BRNC	TTYPUTC
FC/8F:          	
FC/8E:          	; TRANSMITE BYTE
FC/8E: A090     	STORE	[UART_TH],A
FC/8F: FF5B     	JUMP	TTYDONE
FC/91:          
FC/90:          	; PUTS A STRING FROM USER SPACE ONTO THE TERMINAL
FC/90:          	; ASSUMES WORK BANK IS SELECTED
FC/90:          	; A = ADDRESS OF STRING
FC/90:          	; [SRC_BNK] = DATA BANK OF STRING
FC/90:          	; USES: A, B, C
FC/90: 8404     TTYPUTS:LOAD	B,[SRC_BNK]
FC/91: A480     	STORE	[DBANK],B
FC/93:          
FC/92:          	; READ BYTE FROM STRING
FC/92: 9800     0:	LOADF	C,[A]
FC/93: 5800     	ADDI	C,0
FC/94: F656     	BRZ	TTYDONE
FC/96:          	
FC/95:          	; GET THE LINE STATUS REGISTER
FC/95: 8495     1:	LOAD	B,[UART_LS]
FC/97:          
FC/96:          	; READ 5TH BIT TO SEE IF WE CAN TRANSMIT YET
FC/96: 4500     	SHIFTL	B
FC/97: 4500     	SHIFTL	B
FC/98: 4500     	SHIFTL	B
FC/99: F1FB     	BRNC	1B
FC/9B:          	
FC/9A:          	; TRANSMIT BYTE
FC/9A: A890     	STORE	[UART_TH],C
FC/9C:          	
FC/9B:          	; INCREMENT POINTER
FC/9B: 5001     	ADDI	A,1
FC/9D:          	
FC/9C:          	; RETURN TO PRINT LOOP
FC/9C: FFF5     	JUMP	0B
FC/9E:          	
FC/9D:          	; WAIT FOR A CHARACTER TO BE TYPED AND THEN RETURNS IT
FC/9D:          	; CHARACTER WILL NOT BE ECHOED
FC/9D:          	; IF TTYSTAT RETURN 0XFF, THE RETURN WILL BE INSTANT
FC/9D:          	; ASSUMES WORK BANK IS SELECTED
FC/9D:          	; CHARACTER RETURNED IN A
FC/9D:          	; USES: A, B
FC/9D: 8495     TTYGETC:LOAD	B,[UART_LS]
FC/9F:          
FC/9E:          	; READ 1ST BIT
FC/9E: C500     	SHIFTR	B
FC/9F: F1FD     	BRNC	TTYGETC
FC/A1:          	
FC/A0:          	; READ BYTE
FC/A0: 8090     	LOAD	A,[UART_RH]
FC/A1: FF49     	JUMP	TTYDONE
FC/A3:          	
FC/A2:          	; INPUTS A LINE OF CHARACTER INTO A DATA BANK
FC/A2:          	; RESULTING STRING WILL START AT ADDRESS ZERO, AND BE ZERO
FC/A2:          	; TERMINATED
FC/A2:          	; ASSUMES WORK BANK IS SELECTED
FC/A2:          	; [SRC_BNK] = DATA BANK OF RESULT
FC/A2:          	; USES: A, B, C
FC/A2: 8404     TTYINPT:LOAD	B,[SRC_BNK]
FC/A3: A480     	STORE	[DBANK],B
FC/A5:          	
FC/A4:          	; SET POINTER FOR STORAGE
FC/A4: 3800     	LOADI	C,0
FC/A6:          
FC/A5:          	; READ CHARACTER FROM CONSOLE
FC/A5:          	; GET THE LINE STATUS REGISTER
FC/A5: 8495     0:	LOAD	B,[UART_LS]
FC/A7:          
FC/A6:          	; CHECK BIT 0 TO SEE IF WE HAVE A CHARACTER 
FC/A6: C500     	SHIFTR	B
FC/A7: F1FD     	BRNC	0B
FC/A9:          	
FC/A8:          	; READ THE CHARACTER INTO A
FC/A8: 8090     	LOAD	A,[UART_RH]
FC/AA:          
FC/A9:          	; SEE IF IT IS A 'CR' CHARACTER
FC/A9: 340D     1:	LOADI	B,0X0D
FC/AA: D100     	CMP	A,B
FC/AB: F637     	BRZ	9F
FC/AD:          	
FC/AC:          	; SEE IF IT IS A 'BS' CHARACTER
FC/AC: 3408     	LOADI	B,0X08
FC/AD: D100     	CMP	A,B
FC/AE: F61D     	BRZ	4F
FC/B0:          	
FC/AF:          	; SEE IF IT IS A 'TAB' CHARACTER
FC/AF: 3409     	LOADI	B,0X09
FC/B0: D100     	CMP	A,B
FC/B1: F608     	BRZ	2F
FC/B3:          	
FC/B2:          	; IGNORE ALL OTHER WHITESPACE CHARACTERS
FC/B2: 3420     	LOADI	B,0X20
FC/B3: D100     	CMP	A,B
FC/B4: F1F0     	BRB	0B
FC/B6:          	
FC/B5:          	; CHECK IF IT IS A DELETE CHARACTER
FC/B5: 347F     	LOADI	B,0X7F
FC/B6: D100     	CMP	A,B
FC/B7: F702     	BRNZ	2F
FC/B9:          	
FC/B8:          	; YEP, CONVERT IT IN TO A 'BS' CHARACTER
FC/B8: 3008     	LOADI	A,0X08
FC/B9: FFEF     	JUMP	1B
FC/BB:          	
FC/BA:          	; CHECK TO SEE IF THERE IS SPACE TO PLACE THE CHARACTERS
FC/BA:          	; INTO THE BUFFER
FC/BA: D600     2:	CMP	B,C
FC/BB: F6E9     	BRZ	0B
FC/BD:          
FC/BC:          	; CONVERT TO UPPER CASE
FC/BC: 3461     	LOADI	B,0X61
FC/BD: D100     	CMP	A,B
FC/BE: F104     	BRB	3F
FC/BF: 347A     	LOADI	B,0X7A
FC/C0: D100     	CMP	A,B
FC/C1: F801     	BRA	3F
FC/C2: 7020     	SUBI	A,0X20
FC/C4:          	
FC/C3:          	; WAIT FOR LS TO BE READY
FC/C3: 8495     3:	LOAD	B,[UART_LS]
FC/C4: 4500     	SHIFTL	B
FC/C5: 4500     	SHIFTL	B
FC/C6: 4500     	SHIFTL	B
FC/C7: F1FB     	BRNC	3B
FC/C9:          
FC/C8:          	; PRINT THE CHARACTER
FC/C8: A090     	STORE	[UART_TH],A
FC/CA:          	
FC/C9:          	; PLACE IT INTO THE BUFFER
FC/C9: B200     	STOREF	[C],A
FC/CA: 5801     	ADDI	C,1
FC/CB: FFD9     	JUMP	0B
FC/CD:          
FC/CC:          	; HANDLE BACKSPACE
FC/CC:          	; SUBTRACT ONE FROM THE BUFFER
FC/CC: 5800     4:	ADDI	C,0
FC/CD: F6D7     	BRZ	0B
FC/CE: 7801     	SUBI	C,1
FC/D0:          
FC/CF:          	; WAIT FOR LS TO BE READY
FC/CF: 8495     4:	LOAD	B,[UART_LS]
FC/D0: 4500     	SHIFTL	B
FC/D1: 4500     	SHIFTL	B
FC/D2: 4500     	SHIFTL	B
FC/D3: F1FB     	BRNC	4B
FC/D5:          
FC/D4:          	; ECHO THE CHARACTER
FC/D4: A090     	STORE	[UART_TH],A
FC/D6:          
FC/D5:          	; PRINT AN ADDITIONAL SPACE AND THEN BACKSPACE
FC/D5: 8495     5:	LOAD	B,[UART_LS]
FC/D6: 4500     	SHIFTL	B
FC/D7: 4500     	SHIFTL	B
FC/D8: 4500     	SHIFTL	B
FC/D9: F1FB     	BRNC	5B
FC/DB:          	
FC/DA: 3420     	LOADI	B,0X20
FC/DB: A490     	STORE	[UART_TH],B
FC/DD:          	
FC/DC: 8495     6:	LOAD	B,[UART_LS]
FC/DD: 4500     	SHIFTL	B
FC/DE: 4500     	SHIFTL	B
FC/DF: 4500     	SHIFTL	B
FC/E0: F1FB     	BRNC	6B
FC/E2:          	
FC/E1: A090     	STORE	[UART_TH],A
FC/E3:          	
FC/E2: FFC2     	JUMP	0B
FC/E4:          	
FC/E3:          	; TERMINATE THE STRING AND EXIT
FC/E3: 3000     9:	LOADI	A,0
FC/E4: B200     	STOREF	[C],A
FC/E5: FF05     	JUMP	TTYDONE
FC/E7:          	
FC/E6:          
FC/E6:          	; POLL THE UART TO SEE IF THERE IS A CHARACTER WAITING
FC/E6:          	; ASSUMES WORK BANK IS SELECTED
FC/E6:          	; RETURNS A=0XFF IF THERE IS A CHARACTER, OTHERWISE A=0X00
FC/E6: 3000     TTYSTAT:LOADI	A,0
FC/E8:          
FC/E7:          	; GET THE LINE STATUS REGISTER
FC/E7: 8495     	LOAD	B,[UART_LS]
FC/E9:          
FC/E8:          	; READ 1ST BIT
FC/E8: C500     	SHIFTR	B
FC/E9: F101     	BRNC	TTYDONE
FC/EB:          	
FC/EA:          	; SET A AND FALL TO TTYDONE
FC/EA: 30FF     	LOADI	A,0XFF
FC/EC:          
FC/EB:          	; INTERNAL TTY FUNCTION TO RESET TO WORK BANK AND RETURN
FC/EB: 38FF     TTYDONE:LOADI	C,WORK_B
FC/EC: A880     	STORE	[DBANK],C
FC/ED: FF15     	JUMP	IRET
FC/EF:          
FC/EE:          	; BANK IS DONE, MOVE ON TO THE NEXT
FC/EE:          BI	= BI-1
FC/EE:          
FC/EE:          ; BLK.S
FC/EE:          ; BLOCK DEVICE DRIVER
FC/EE:          ; (COMPACT FLASH VERSION)
FC/EE:          ; GAVIN TERSTEEG, 2024
FC/EE:          ; SDMAY24-14
FC/EE:          
FC/EE:          .BANK BI
FB/80:          BLK0_B	= BI
FB/80:          .TEXT
FB/80:          
FB/80:          	; BLOCK DEVICE INIT
FB/80:          	; SET UP THE COMPACT FLASH CARD
FB/80:          	; ASSUMES WORK BANK IS SELECTED
FB/80:          	; USES: A, B, C
FB/80: 3882     BLKINIT:LOADI	C,@+2
FB/81: FF45     	JUMP	CFWAIT
FB/83:          	
FB/82:          	; SET LBA3 TO 0XE0
FB/82: 30E0     	LOADI	A,0XE0
FB/83: A0A6     	STORE	[CF_LBA3],A
FB/85:          	
FB/84:          	; SET 8 BIT MODE
FB/84: 3001     	LOADI	A,CF_8BIT
FB/85: A0A1     	STORE	[CF_FEAT],A
FB/86: 30EF     	LOADI	A,CF_SETF
FB/87: A0A7     	STORE	[CF_CMD],A
FB/89:          	
FB/88:          	; NOW DISABLE THE CACHE
FB/88: 388A     	LOADI	C,@+2
FB/89: FF3D     	JUMP	CFWAIT
FB/8B:          ;	LOADI	A,CF_DCAC
FB/8A:          ;	STORE	[CF_FEAT],A
FB/8A:          ;	LOADI	A,CF_SETF
FB/8A:          ;	STORE	[CF_CMD],A
FB/8A:          
FB/8A: FF42     	JUMP	BLKDONE
FB/8C:          
FB/8B:          	; READS A BLOCK (512 BYTES) FROM THE BLOCK DEVICE
FB/8B:          	; CONTENTS WILL BE PLACED IN 4 SEQUENTIAL DATA BANKS
FB/8B:          	; ASSUMES WORK BANK IS SELECTED
FB/8B:          	; A = LOWEST DESTINATION DATA BANK
FB/8B:          	; RETURNS A = 0X00
FB/8B:          	; USES: A, B, C, D0
FB/8B: 388D     BLKREAD:LOADI	C,@+2
FB/8C: FF30     	JUMP	CFADDR
FB/8E:          	
FB/8D:          	; EXECUTE THE READ COMMAND AND WAIT
FB/8D: 3420     	LOADI	B,CF_READ
FB/8E: A4A7     	STORE	[CF_CMD],B
FB/8F: 3891     	LOADI	C,@+2
FB/90: FF36     	JUMP	CFWAIT
FB/92:          	
FB/91:          	; COPY INTO 4 DATA BANKS
FB/91: 3804     	LOADI	C,4
FB/92: A003     0:	STORE	[D0],A
FB/93: A080     	STORE	[DBANK],A
FB/94: 3000     	LOADI	A,0
FB/96:          	
FB/95:          	; COPY 128 BYTES
FB/95: 84A0     1:	LOAD	B,[CF_DATA]
FB/96: B400     	STOREF	[A],B
FB/97: 5001     	ADDI	A,1
FB/98: F5FC     	BRNN	1B
FB/9A:          	
FB/99:          	; NEXT BANK?
FB/99: 30FF     	LOADI	A,WORK_B
FB/9A: A080     	STORE	[DBANK],A
FB/9B: 8003     	LOAD	A,[D0]
FB/9C: 5001     	ADDI	A,1
FB/9D: 7801     	SUBI	C,1
FB/9E: F7F3     	BRNZ	0B
FB/A0:          	
FB/9F:          	; CHECK IF THERE IS AN ERROR
FB/9F: 80A7     	LOAD	A,[CF_STAT]
FB/A0: C100     	SHIFTR	A
FB/A1: F0E9     	BRC	BLKREAD
FB/A3:          	
FB/A2:          	; OPERATION COMPLETE
FB/A2: 3000     2:	LOADI	A,0
FB/A3: FF29     	JUMP	BLKDONE
FB/A5:          	
FB/A4:          	; WRITES A BLOCK (512 BYTES) TO THE BLOCK DEVICE
FB/A4:          	; CONTENTS WILL BE TAKEN FROM 4 SEQUENTIAL DATA BANKS
FB/A4:          	; ASSUMES WORK BANK IS SELECTED
FB/A4:          	; A = LOWEST SOURCE DATA BANK
FB/A4:          	; RETURNS A = 0X00
FB/A4:          	; USES: A, B, C, D0
FB/A4: 38A6     BLKWRIT:LOADI	C,@+2
FB/A5: FF17     	JUMP	CFADDR
FB/A7:          	
FB/A6:          	; EXECUTE THE WRITE COMMAND AND WAIT FOR 0X58
FB/A6: 3430     	LOADI	B,CF_WRIT
FB/A7: A4A7     	STORE	[CF_CMD],B
FB/A8: 38AA     	LOADI	C,@+2
FB/A9: FF1D     	JUMP	CFWAIT
FB/AB:          ;0:	LOAD	B,[CF_STAT]
FB/AA:          ;	SUBI	B,0X58
FB/AA:          ;	BRNZ	0B
FB/AA:          	
FB/AA:          	; COPY OUT OF 4 DATA BANKS
FB/AA: 3804     	LOADI	C,4
FB/AB: A003     0:	STORE	[D0],A
FB/AC: A080     	STORE	[DBANK],A
FB/AD: 3000     	LOADI	A,0
FB/AF:          	
FB/AE:          	; COPY 128 BYTES
FB/AE: 9400     1:	LOADF	B,[A]
FB/AF: A4A0     	STORE	[CF_DATA],B
FB/B0: 5001     	ADDI	A,1
FB/B1: F5FC     	BRNN	1B
FB/B3:          	
FB/B2:          	; NEXT BANK?
FB/B2: 30FF     	LOADI	A,WORK_B
FB/B3: A080     	STORE	[DBANK],A
FB/B4: 8003     	LOAD	A,[D0]
FB/B5: 5001     	ADDI	A,1
FB/B6: 7801     	SUBI	C,1
FB/B7: F7F3     	BRNZ	0B
FB/B9:          	
FB/B8:          	; CHECK IF THERE IS AN ERROR
FB/B8: 80A7     	LOAD	A,[CF_STAT]
FB/B9: C100     	SHIFTR	A
FB/BA: F0E9     	BRC	BLKWRIT
FB/BC:          	
FB/BB:          	; OPERATION COMPLETE
FB/BB: 3000     	LOADI	A,0
FB/BC: FF10     	JUMP	BLKDONE
FB/BE:          
FB/BD:          	; SET THE LBA ADDRESS OF THE CF CARD
FB/BD:          	; USING THE BLOCK ADDRESS ON THE WORK BANK
FB/BD:          	; BLOCK COUNT IS ALSO SET
FB/BD:          	; AFTER THAT, A WAIT IS PERFORMED SO A
FB/BD:          	; COMMAND CAN BE EXECUTED AFTER
FB/BD:          	; USES: B
FB/BD: 8406     CFADDR:	LOAD	B,[BLK+1]
FB/BE: A4A3     	STORE	[CF_LBA0],B
FB/BF: 8405     	LOAD	B,[BLK]
FB/C0: A4A4     	STORE	[CF_LBA1],B
FB/C1: 3400     	LOADI	B,0
FB/C2: A4A5     	STORE	[CF_LBA2],B
FB/C3: 34E0     	LOADI	B,0XE0
FB/C4: A4A6     	STORE	[CF_LBA3],B
FB/C5: 3401     	LOADI	B,1
FB/C6: A4A2     	STORE	[CF_CNT],B
FB/C8:          
FB/C7:          	; WAIT FOR THE CF CARD TO BECOME READY
FB/C7:          	; FOR THIS TO HAPPEN, THE BUSY FLAG MUST BE 0
FB/C7:          	; AND THE READY FLAG MUST BE 1
FB/C7:          	; IF A CF CARD ISN'T PRESENT, THIS ROUTINE HANGS
FB/C7:          	; BUT WE DON'T CARE
FB/C7:          	; USES: B
FB/C7: 84A7     CFWAIT:	LOAD	B,[CF_STAT]
FB/C9:          
FB/C8:          	; CHECK BIT 7 (BUSY FLAG)
FB/C8: 4500     	SHIFTL	B
FB/CA:          	
FB/C9:          	; GO BACK TO START BUSY
FB/C9: F0FD     	BRC	CFWAIT
FB/CB:          	
FB/CA:          	; CHECK BIT 6 (READY FLAG)
FB/CA: 4500     	SHIFTL	B
FB/CC:          	
FB/CB:          	; GO BACK TO START IF NOT READY
FB/CB: F1FB     	BRNC	CFWAIT
FB/CD:          	
FB/CC:          	; RETURN FROM FUNCTION CALL
FB/CC: FE33     	JUMPR	C
FB/CE:          
FB/CD:          
FB/CD:          	; INTERNAL BLK FUNCTION TO RESET TO WORK BANK AND RETURN
FB/CD: 38FF     BLKDONE:LOADI	C,WORK_B
FB/CE: A880     	STORE	[DBANK],C
FB/CF: FF33     	JUMP	IRET
FB/D1:          
FB/D0:          	; BANK IS DONE, MOVE ON TO THE NEXT
FB/D0:          BI	= BI-1
FB/D0:          
FB/D0:          ; PRT.S
FB/D0:          ; PRINTER DRIVER
FB/D0:          ; GAVIN TERSTEEG, 2024
FB/D0:          ; SDMAY24-14
FB/D0:          
FB/D0:          ; AY-3-8910 ADDRESSES
FB/D0:          MEGAIO	= 0XB0
FB/D0:          AY0_ADR	= MEGAIO+0
FB/D0:          AY1_ADR	= MEGAIO+2
FB/D0:          AY0_WR	= MEGAIO+1
FB/D0:          AY1_WR	= MEGAIO+3
FB/D0:          AY0_RD	= MEGAIO+0
FB/D0:          AY1_RD	= MEGAIO+2
FB/D0:          
FB/D0:          .BANK BI
FA/80:          PRT0_B	= BI
FA/80:          .TEXT
FA/80:          
FA/80:          	; PRINTER INIT
FA/80:          	; NOT USED ATM
FA/80:          	; ASSUMES WORK BANK IS SELECTED
FA/80:          	; USES: A, B, C
FA/80: FF33     PRTINIT:JUMP	PRTDONE
FA/82:          
FA/81:          	; PRINTER PUT CHARACTER
FA/81:          	; WAITS FOR PRINTER TO NOT BE BUSY BEFORE SENDING CHARACTER
FA/81:          	; A = CHARACTER TO PRINT
FA/81:          	; ASSUMES WORK BANK IS SELECTED
FA/81:          	; USES: A, B, C
FA/81:          	; SET UP AY CHIPS
FA/81: 3407     PRTPUTC:LOADI	B,7
FA/82: A4B2     	STORE	[AY1_ADR],B
FA/83: A4B0     	STORE	[AY0_ADR],B
FA/84: 34BF     	LOADI	B,0XBF
FA/85: A4B3     	STORE	[AY1_WR],B
FA/86: 34FF     	LOADI	B,0XFF
FA/87: A4B1     	STORE	[AY0_WR],B
FA/89:          	
FA/88:          	; SET DEVICE CONTROL STATE
FA/88: 340F     	LOADI	B,15
FA/89: A4B2     	STORE	[AY1_ADR],B
FA/8A: 34FF     	LOADI	B,0XFF
FA/8B: A4B3     	STORE	[AY1_WR],B
FA/8D:          	
FA/8C:          	; WAIT FOR BUSY TO CLEAR
FA/8C: 340E     	LOADI	B,14
FA/8D: A4B2     	STORE	[AY1_ADR],B
FA/8E: 84B2     0:	LOAD	B,[AY1_RD]
FA/8F: C500     	SHIFTR	B
FA/90: C500     	SHIFTR	B
FA/91: C500     	SHIFTR	B
FA/92: F0FB     	BRC	0B
FA/94:          	
FA/93:          	; SEND OUT CHARACTER
FA/93: 340F     	LOADI	B,15
FA/94: A4B0     	STORE	[AY0_ADR],B
FA/95: A0B1     	STORE	[AY0_WR],A
FA/97:          
FA/96:          	; STROBE PRINTER
FA/96: 300F     	LOADI	A,15
FA/97: A0B2     	STORE	[AY1_ADR],A
FA/98: 30F7     	LOADI	A,0XF7
FA/99: A0B3     	STORE	[AY1_WR],A
FA/9A: 30FF     	LOADI	A,0XFF
FA/9B: A0B3     	STORE	[AY1_WR],A
FA/9D:          	
FA/9C:          	; DONE
FA/9C: FF17     	JUMP	PRTDONE
FA/9E:          
FA/9D:          	; PRINTER STATUS
FA/9D:          	; RETURNS A=0XFF IF THE PRINTER IS READY
FA/9D:          	; ASSUMES WORK BANK IS SELECTED
FA/9D:          	; USES: A, B, C
FA/9D: 3007     PRTSTAT:LOADI	A,7
FA/9E: A0B2     	STORE	[AY1_ADR],A
FA/9F: A0B0     	STORE	[AY0_ADR],A
FA/A0: 30BF     	LOADI	A,0XBF
FA/A1: A0B3     	STORE	[AY1_WR],A
FA/A2: 30FF     	LOADI	A,0XFF
FA/A3: A0B1     	STORE	[AY0_WR],A
FA/A5:          	
FA/A4:          	; SET DEVICE CONTROL STATE
FA/A4: 300F     	LOADI	A,15
FA/A5: A0B2     	STORE	[AY1_ADR],A
FA/A6: 30FF     	LOADI	A,0XFF
FA/A7: A0B3     	STORE	[AY1_WR],A
FA/A9:          	
FA/A8:          	; GET BUSY FLAG
FA/A8: 3800     	LOADI	C,0X00
FA/A9: 3000     	LOADI	A,0X00
FA/AA: 340E     	LOADI	B,14
FA/AB: A4B2     	STORE	[AY1_ADR],B
FA/AC: 84B2     0:	LOAD	B,[AY1_RD]
FA/AD: 5801     	ADDI	C,1
FA/AE: F605     	BRZ	PRTDONE
FA/AF: C500     	SHIFTR	B
FA/B0: C500     	SHIFTR	B
FA/B1: C500     	SHIFTR	B
FA/B2: F0F9     	BRC	0B
FA/B3: 30FF     	LOADI	A,0XFF
FA/B5:          	
FA/B4:          	; FALL TO PRTDONE
FA/B4:          
FA/B4:          	; INTERNAL PRT FUNCTION TO RESET TO WORK BANK AND RETURN
FA/B4: 38FF     PRTDONE:LOADI	C,WORK_B
FA/B5: A880     	STORE	[DBANK],C
FA/B6: FF4C     	JUMP	IRET
FA/B8:          
FA/B7:          	; BANK IS DONE, MOVE ON TO THE NEXT
FA/B7:          BI	= BI-1
FA/B7:          ; AUXTTY.S
FA/B7:          ; AUXILIARY SERIAL DEVICE DRIVER
FA/B7:          ; GAVIN TERSTEEG, 2024
FA/B7:          ; SDMAY24-14
FA/B7:          
FA/B7:          .BANK BI
F9/80:          AUX0_B	= BI
F9/80:          .TEXT
F9/80:          
F9/80:          	; AUXILIARY SERIAL INIT
F9/80:          	; ASSUMES WORK BANK IS SELECTED
F9/80:          	; USES:
F9/80: FF03     AUXINIT:JUMP	AUXDONE
F9/82:          
F9/81:          	; SENDS A BYTE TO THE AUXILIARY SERIAL DEVICE
F9/81:          	; ASSUMES WORK BANK IS SELECTED
F9/81:          	; A = BYTE TO SEND
F9/81:          	; USES: 
F9/81: FF02     AUXPUTB:JUMP	AUXDONE
F9/83:          
F9/82:          	; WAIT FOR A BYTE TO BE RECIEVED BY THE AUXILIARY SERIAL DEVICE
F9/82:          	; IF AUXSTAT RETURN 0XFF, THE RETURN WILL BE INSTANT
F9/82:          	; ASSUMES WORK BANK IS SELECTED
F9/82:          	; BYTE RETURNED IN A
F9/82:          	; USES:
F9/82: FF01     AUXGETB:JUMP	AUXDONE
F9/84:          
F9/83:          	; POLL THE AUXILIARY SERIAL DEVICE TO SEE IF THERE IS A 
F9/83:          	; BYTE WAITING
F9/83:          	; ASSUMES WORK BANK IS SELECTED
F9/83:          	; RETURNS A=0XFF IF THERE IS A BYTE, OTHERWISE A=0X00
F9/83: 3000     AUXSTAT:LOADI	A,0
F9/85:          
F9/84:          	; INTERNAL TTY FUNCTION TO RESET TO WORK BANK AND RETURN
F9/84: 38FF     AUXDONE:LOADI	C,WORK_B
F9/85: A880     	STORE	[DBANK],C
F9/86: FF7C     	JUMP	IRET
F9/88:          
F9/87:          	; BANK IS DONE, MOVE ON TO THE NEXT
F9/87:          BI	= BI-1
F9/87:          
F9/87:          ; FS.S
F9/87:          ; FILE SYSTEM HANDLING ROUTINES
F9/87:          ; GAVIN TERSTEEG, 2024
F9/87:          ; SDMAY24-14
F9/87:          
F9/87:          .BANK BI
F8/80:          FS0_B	= BI
F8/80:          .TEXT
F8/80:          	; SET SEARCH PARAMETERS
F8/80:          	; USING A STRING IN USER SPACE, THE FILE SEARCH PATTERN WILL
F8/80:          	; BE UPDATED
F8/80:          	; THE FILE SEARCH POINTER WILL ALSO BE RESET
F8/80:          	; ASSUMES WORK BANK IS SELECTED
F8/80:          	; A = ADDRESS OF STRING
F8/80:          	; [SRC_BNK] = DATA BANK OF STRING
F8/80:          	; RETURNS A=0X00 IF PATTERN IS VALID, OTHERWISE 0XFF
F8/80:          	; 0XFE CAN BE RETURNED IF THERE NEVER IS A '.' IN THE FILE
F8/80:          	; USES: A, B, C, M0, M1, M2
F8/80: A000     SSPARAM:STORE	[M0],A
F8/82:          
F8/81:          	; STORE PATTERN COUNTER
F8/81: 3006     	LOADI	A,6
F8/82: A001     	STORE	[M1],A
F8/84:          	
F8/83:          	; STORE PATTERN POINTER
F8/83: 3009     	LOADI	A,PATTERN
F8/84: A002     	STORE	[M2],A
F8/86:          	
F8/85:          	; RESET THE PATTERN
F8/85: 3009     	LOADI	A,PATTERN
F8/86: 3408     	LOADI	B,8
F8/87: 3820     	LOADI	C,0X20
F8/88: B800     0:	STOREF	[A],C
F8/89: 5001     	ADDI	A,1
F8/8A: 7401     	SUBI	B,1
F8/8B: F7FC     	BRNZ	0B
F8/8D:          	
F8/8C:          	; DO AN INITAL CHECKOUT OF THE PATTERN
F8/8C: 8004     	LOAD	A,[SRC_BNK]
F8/8D: 8400     	LOAD	B,[M0]
F8/8E: A080     	STORE	[DBANK],A
F8/90:          	
F8/8F:          	; MAKE SURE THERE IS ACTUALLY A PATTERN
F8/8F: 9900     	LOADF	C,[B]
F8/90: 3020     	LOADI	A,0X20
F8/91: D200     	CMP	A,C
F8/92: F042     	BRAE	9F
F8/94:          	
F8/93:          	; SEE IF THERE IS A USER AREA PREFIX
F8/93:          	; AND CHANGE BANK TO KERNEL WORK AREA
F8/93: 9101     	LOADF	A,[B+1]
F8/94: 703A     	SUBI	A,':'
F8/95: 30FF     	LOADI	A,WORK_B
F8/96: A080     	STORE	[DBANK],A
F8/97: F70C     	BRNZ	1F
F8/99:          	
F8/98:          	; MAKE SURE THAT THE USER AREA PREFIX IS VALID
F8/98: 303F     	LOADI	A,'?'
F8/99: D800     	CMP	C,A
F8/9A: F606     	BRZ	0F
F8/9B: 3030     	LOADI	A,'0'
F8/9C: D800     	CMP	C,A
F8/9D: F137     	BRB	9F
F8/9E: 3039     	LOADI	A,'9'
F8/9F: D800     	CMP	C,A
F8/A0: F834     	BRA	9F
F8/A2:          
F8/A1:          	; SET THE WORKING USER AREA
F8/A1: A808     0:	STORE	[WRK_USR],C
F8/A3:          	
F8/A2:          	; AND SKIP THE PREFIX
F8/A2: 5402     	ADDI	B,2
F8/A3: A400     	STORE	[M0],B
F8/A5:          
F8/A4:          	; GRAB THE NEXT CHARACTER
F8/A4:          	; C = NEXT CHARACTER
F8/A4: 8400     1:	LOAD	B,[M0]
F8/A5: 8004     	LOAD	A,[SRC_BNK]
F8/A6: A080     	STORE	[DBANK],A
F8/A7: 9900     	LOADF	C,[B]
F8/A8: 30FF     	LOADI	A,WORK_B
F8/A9: A080     	STORE	[DBANK],A
F8/AB:          	
F8/AA:          	; INCREMENT AND SAVE POINTER INTO M0
F8/AA: 5401     	ADDI	B,1
F8/AB: A400     	STORE	[M0],B
F8/AD:          	
F8/AC:          	; GRAB PATTERN POINTER
F8/AC: 8002     	LOAD	A,[M2]
F8/AE:          	
F8/AD:          	; SEE IF THE PATTERN IS COMPLETE
F8/AD:          	; AND GRAB PATTERN COUNTER
F8/AD: 3420     	LOADI	B,0X20
F8/AE: D600     	CMP	B,C
F8/AF: 8401     	LOAD	B,[M1]
F8/B0: F01A     	BRAE	6F
F8/B2:          	
F8/B1:          	; SEE IF IT IS A '.'
F8/B1: 782E     	SUBI	C,'.'
F8/B2: F611     	BRZ	5F
F8/B4:          	
F8/B3:          	; THERE MUST BE SPACE IN THE PATTERN BUFFER FOR ANY
F8/B3:          	; OF THE NEXT VALUES TO BE VALID
F8/B3:          	; LETS CHECK IT
F8/B3: 7401     	SUBI	B,1
F8/B4: F420     	BRN	9F
F8/B6:          	
F8/B5:          	; SEE IF IT IS A '*'
F8/B5: 78FC     	SUBI	C,'*'-'.'
F8/B6: F606     	BRZ	3F
F8/B8:          	
F8/B7:          	; OTHERWISE, IT'S A NORMAL CHARACTER
F8/B7:          	; PLACE IT IN THE BUFFER AND MOVE ON
F8/B7: 582A     	ADDI	C,'*'
F8/B8: B800     	STOREF	[A],C
F8/B9: 5001     	ADDI	A,1
F8/BA: A002     2:	STORE	[M2],A
F8/BB: A401     	STORE	[M1],B
F8/BC: FFE7     	JUMP	1B
F8/BE:          
F8/BD:          	; HANDLE '*'
F8/BD:          	; FILL REST OF PATTERN SECTION WITH '?'
F8/BD: 5401     3:	ADDI	B,1
F8/BE: 383F     	LOADI	C,'?'
F8/BF: B800     4:	STOREF	[A],C
F8/C0: 5001     	ADDI	A,1
F8/C1: 7401     	SUBI	B,1
F8/C2: F7FC     	BRNZ	4B
F8/C3: FFF6     	JUMP	2B
F8/C5:          	
F8/C4:          	; HANDLE '.'
F8/C4:          	; MAKE SURE THE LAST 2 BYTES OF THE PATTERN BUFFER ARE EMPTY
F8/C4:          	; AND THERE HASN'T BEEN A '.' ALREADY
F8/C4: 380F     5:	LOADI	C,PATTERN+6
F8/C5: 4100     	ADD	A,B
F8/C6: D200     	CMP	A,C
F8/C7: F80D     	BRA	9F
F8/C9:          	
F8/C8:          	; SET THE NEW PATTERN POINTER
F8/C8: 300F     	LOADI	A,PATTERN+6
F8/C9: 3402     	LOADI	B,2
F8/CA: FFEF     	JUMP	2B
F8/CC:          
F8/CB:          	; PATTERN IS COMPLETE
F8/CB:          	; MAKE SURE ALL FIELDS HAVE BEEN FILLED IN
F8/CB: 380F     6:	LOADI	C,PATTERN+6
F8/CC: D200     	CMP	A,C
F8/CD: F902     	BRBE	7F
F8/CE: 3000     	LOADI	A,0
F8/CF: FF1F     	JUMP	FS0DONE
F8/D1:          	
F8/D0:          	; CHECK TO SEE IF A '.' HAS BEEN PLACED
F8/D0: 4100     7:	ADD	A,B
F8/D1: D200     	CMP	A,C
F8/D2: F702     	BRNZ	9F
F8/D3: 30FE     	LOADI	A,0XFE
F8/D4: FF1A     	JUMP	FS0DONE
F8/D6:          	
F8/D5:          	; PATTERN IS INVALID
F8/D5: 30FF     9:	LOADI	A,0XFF
F8/D6: FF18     	JUMP	FS0DONE
F8/D8:          	
F8/D7:          	; SIMILAR TO FSEARCH, BUT LOOKS FOR AN EMPTY FILE
F8/D7: 342B     FEMPTY:	LOADI	B,EMPTYP
F8/D8: FF01     	JUMP	0F
F8/DA:          		
F8/D9:          	; FILE RECORD FORMAT (16 BYTES)
F8/D9:          	; 0:     FILE ALLOCATED TAG
F8/D9:          	;   0X00 = UNALLOCATED
F8/D9:          	;   0XFF = ALLOCATED
F8/D9:          	; 1:     USER AREA
F8/D9:          	;   '0'-'9' FOR USER AREA
F8/D9:          	; 2-7:   FILE NAME
F8/D9:          	;   'A'-'Z','0'-'9','-','_'
F8/D9:          	; 8-9:   FILE EXTENSION
F8/D9:          	;   'A'-'Z','0'-'9','-','_'
F8/D9:          	; 10-11  FILE SIZE IN BLOCKS
F8/D9:          	; 12:    UNUSED
F8/D9:          	; 13-14: FILE BLOCK TABLE ADDRESS
F8/D9:          	;   16 BIT PHYSICAL ADDRESS OF BLOCK TABLE
F8/D9:          	; 15:    NEXT RECORD / END RECORD
F8/D9:          	;   0X00 = HAS NEXT RECORD
F8/D9:          	;   0X01 = NEXT RECORD ON NEXT BLOCK
F8/D9:          	;   0XFF = END OF RECORD 
F8/D9:          	
F8/D9:          	; SEARCHES THE FILE RECORDS UNTIL ONE MATCHING THE CURRENT PATTERN
F8/D9:          	; IS FOUND OR ALL RECORDS ARE EXHAUSTED
F8/D9:          	; ASSUMES WORK BANK IS SELECTED
F8/D9:          	; A = 0 TO RESET THE SEARCH, 1 TO CONTINUE TO NEXT ENTRY
F8/D9:          	; A RETURNS 0X00 IF FOUND, OTHERWISE 0XFF IS RETURNED
F8/D9:          	; USES: A, B, C, M0, M1, M2
F8/D9: 3407     FSEARCH:LOADI	B,MATCH
F8/DA: A402     0:	STORE	[M2],B
F8/DB: 5000     	ADDI	A,0
F8/DC: 34F7     	LOADI	B,FS1_B
F8/DD: 38C7     	LOADI	C,FSNEXT
F8/DE: F723     	BRNZ	INDIR
F8/E0:          	
F8/DF:          	; RESET SEARCH STATE
F8/DF: 3011     	LOADI	A,17
F8/E0: A011     	STORE	[SRCH_LO],A
F8/E2:          	
F8/E1:          	; CHECK THE RECORD
F8/E1: 3880     	LOADI	C,FSSTART
F8/E2: FF1F     	JUMP	INDIR
F8/E4:          	
F8/E3:          	; OPENS THE FILE THAT IS CURRENTLY BEING POINTED
F8/E3:          	; TO BE THE FILE SEARCH STATE
F8/E3:          	; DUE TO THIS, FOPEN MUST BE RUN IMMEDIATELY
F8/E3:          	; AFTER A FILE SEARCH
F8/E3:          	; ASSUMES WORK BANK IS SELECTED
F8/E3:          	; A RETURNS 0X00 IF SUCCESSFUL, OTHERWISE 0XFF IS RETURNED
F8/E3:          	; USES: A, B, C, M0
F8/E3: 34F7     FOPEN:	LOADI	B,FS1_B
F8/E4: 38DA     	LOADI	C,FOPENA
F8/E5: FF1C     	JUMP	INDIR
F8/E7:          	
F8/E6:          	; CLOSES ANY FILES THAT ARE OPEN
F8/E6:          	; ALL BUFFERS WILL BE FLUSHED AFTER THE OPERATION COMPLETES
F8/E6:          	; USES: A, B, C, M0, M1, M2
F8/E6: 34F6     FCLOSE:	LOADI	B,FS2_B
F8/E7: 38DA     	LOADI	C,FCLOSEA
F8/E8: FF19     	JUMP	INDIR
F8/EA:          
F8/E9:          	; READS A BLOCK OUT OF THE CURRENTLY OPEN FILE
F8/E9:          	; AN ERROR IS RETURNED IF THE BLOCK IS OUTSIDE OF THE CURRENT
F8/E9:          	; FILE SIZE
F8/E9:          	; A FILE MUST CURRENTLY BE OPEN
F8/E9:          	; A = BLOCK TO READ
F8/E9:          	; [SRC_BNK] = DESTINATION OF READ DATA
F8/E9:          	; ASSUMES WORK BANK IS SELECTED
F8/E9:          	; A RETURNS 0X00 IF SUCCESSFUL, OTHERWISE 0XFF IS RETURNED
F8/E9:          	; USES: A, B, C, M0
F8/E9: 34F6     FREAD:	LOADI	B,FS2_B
F8/EA: 3880     	LOADI	C,FREADA
F8/EB: FF16     	JUMP	INDIR
F8/ED:          	
F8/EC:          	; WRITE A BLOCK INTO THE CURRENTLY OPEN FILE
F8/EC:          	; IF THE ADDRESS IS AN EXISTING BLOCK, IT WILL BE OVERWRITTEN
F8/EC:          	; IF THE ADDRESS IS EQUAL TO THE FILE SIZE, THEN A NEW BLOCK
F8/EC:          	; WILL BE ALLOCATED
F8/EC:          	; OTHERWISE THERE WILL BE AN ERROR
F8/EC:          	; A FILE MUST CURRENTLY BE OPEN
F8/EC:          	; A = BLOCK TO WRITE
F8/EC:          	; [SRC_BNK] = SOURCE OF WRITE DATA
F8/EC:          	; ASSUMES WORK BANK IS SELECTED
F8/EC:          	; A RETURNS 0X00 IF SUCCESSFUL, OTHERWISE 0XFF IS RETURNED
F8/EC:          	; USES: A, B, C, M0, M1, M2
F8/EC: 34F6     FWRITE:	LOADI	B,FS2_B
F8/ED: 3898     	LOADI	C,FWRITEA
F8/EE: FF13     	JUMP	INDIR
F8/F0:          
F8/EF:          
F8/EF:          
F8/EF:          	; INTERNAL FS0 FUNCTION TO RESET TO WORK BANK AND RETURN
F8/EF: 38FF     FS0DONE:LOADI	C,WORK_B
F8/F0: A880     	STORE	[DBANK],C
F8/F1: FF11     	JUMP	IRET
F8/F3:          
F8/F2:          	; BANK IS DONE, MOVE ON TO THE NEXT
F8/F2:          BI	= BI-1
F8/F2:          .BANK BI
F7/80:          FS1_B	= BI
F7/80:          .TEXT
F7/80:          
F7/80:          	; START THE FILE SEARCH ON A BLOCK
F7/80:          	; RESET INTER-BLOCK SEARCH STATE
F7/80:          	; AND READ THE BLOCK
F7/80:          	; THEN EXECUTE FSCHECK
F7/80:          	; ASSUMES WORK BANK IS SELECTED
F7/80:          	; USES: A, B, C
F7/80: 3000     FSSTART:LOADI	A,0
F7/81: A013     	STORE	[SRCH_RP],A
F7/82: 30F1     	LOADI	A,KBUF_B
F7/83: A012     	STORE	[SRCH_BK],A
F7/85:          	
F7/84:          	; SET ADDRESS FOR READ
F7/84: 3400     	LOADI	B,0
F7/85: A405     	STORE	[BLK],B
F7/86: 8411     	LOAD	B,[SRCH_LO]
F7/87: A406     	STORE	[BLK+1],B
F7/89:          	
F7/88:          	; AND EXECUTE A READ INTO THE KBUF
F7/88: 7C02     	SUBI	D,2
F7/89: 38F7     	LOADI	C,FS1_B
F7/8A: BB01     	STOREF	[D+1],C
F7/8B: 3890     	LOADI	C,@+5
F7/8C: BB00     	STOREF	[D],C
F7/8D: 34FB     	LOADI	B,BLK0_B
F7/8E: 388B     	LOADI	C,BLKREAD
F7/8F: FF72     	JUMP	INDIR
F7/90: 5C02     	ADDI	D,2
F7/92:          
F7/91:          	; FILE SEARCH CHECK
F7/91:          	; USING THE CURRENT SEARCH STATE, THE RECORD WILL BE CHECKED
F7/91:          	; AGAINST THE CURRENT PATTERN
F7/91:          	; ASSUMES WORK BANK IS SELECTED
F7/91:          	; A RETURNS 0X00 IF FOUND, OTHERWISE FSNEXT IS CALLED
F7/91:          	; USES: A, B, C, M0, M1
F7/91: 380A     FSCHECK:LOADI	C,10
F7/92: A801     	STORE	[M1],C
F7/94:          
F7/93:          	; RECORD THE CURRENT RECORD ENDING
F7/93: 8013     	LOAD	A,[SRCH_RP]
F7/94: 8412     	LOAD	B,[SRCH_BK]
F7/95: A480     	STORE	[DBANK],B 
F7/96: 980F     	LOADF	C,[A+15]
F7/97: 34FF     	LOADI	B,WORK_B
F7/98: A480     	STORE	[DBANK],B
F7/99: A814     	STORE	[SRCH_LS],C
F7/9B:          	
F7/9A:          	; GET THE PATTERN TO MATCH AGAINST
F7/9A: 8802     	LOAD	C,[M2]
F7/9C:          	
F7/9B:          	; GET BYTE OF MATCH PATTERN
F7/9B: A800     0:	STORE	[M0],C
F7/9C: 9A00     	LOADF	C,[C]
F7/9D: 783F     	SUBI	C,'?'
F7/9E: F608     	BRZ	1F
F7/9F: 583F     	ADDI	C,'?'
F7/A1:          	
F7/A0:          	; SWITCH TO RECORD BANK
F7/A0: 8412     	LOAD	B,[SRCH_BK]
F7/A1: A480     	STORE	[DBANK],B
F7/A3:          	
F7/A2:          	; CHECK AGAINST THE RECORD POINTER
F7/A2: 9400     	LOADF	B,[A]
F7/A3: D600     	CMP	B,C
F7/A4: 34FF     	LOADI	B,WORK_B
F7/A5: A480     	STORE	[DBANK],B
F7/A6: F720     	BRNZ	FSNEXT
F7/A8:          	
F7/A7:          	; THAT ONE MATCHED, KEEP GOING
F7/A7: 5001     1:	ADDI	A,1
F7/A8: 8800     	LOAD	C,[M0]
F7/A9: 5801     	ADDI	C,1
F7/AA: 8401     	LOAD	B,[M1]
F7/AB: 7401     	SUBI	B,1
F7/AC: A401     	STORE	[M1],B
F7/AD: F7ED     	BRNZ	0B
F7/AF:          	
F7/AE:          	; WE HAVE A MATCH!
F7/AE:          	; COPY USER AREA INTO USER SPACE
F7/AE: AC00     	STORE	[M0],D
F7/AF: 8013     	LOAD	A,[SRCH_RP]
F7/B0: 8412     	LOAD	B,[SRCH_BK]
F7/B1: A480     	STORE	[DBANK],B 
F7/B2: 9801     	LOADF	C,[A+1]
F7/B3: 3400     	LOADI	B,0
F7/B4: A480     	STORE	[DBANK],B
F7/B5: A86A     	STORE	[0X6A],C
F7/B7:          	
F7/B6:          	; COPY FILE NAME AND SIZE
F7/B6: 3C0A     	LOADI	D,10
F7/B7: 34FF     	LOADI	B,WORK_B
F7/B8: A480     	STORE	[DBANK],B
F7/B9: 8412     2:	LOAD	B,[SRCH_BK]
F7/BA: A480     	STORE	[DBANK],B 
F7/BB: 980B     	LOADF	C,[A+11]
F7/BC: 3400     	LOADI	B,0
F7/BD: A480     	STORE	[DBANK],B
F7/BE: BB5F     	STOREF	[D+0X60-1],C
F7/BF: 7001     	SUBI	A,1
F7/C0: 7C01     	SUBI	D,1
F7/C1: 34FF     	LOADI	B,WORK_B
F7/C2: A480     	STORE	[DBANK],B
F7/C3: F7F5     	BRNZ	2B
F7/C4: 8C00     	LOAD	D,[M0]
F7/C6:          	
F7/C5:          	; COMPLETE OPERATION
F7/C5: 3000     	LOADI	A,0
F7/C6: FF2E     	JUMP	FS1DONE
F7/C8:          	
F7/C7:          	; INCREMENT TO THE NEXT RECORD
F7/C7:          	; CHECK TO SEE IF THERE IS ACTUALLY A NEXT RECORD
F7/C7: 30FF     FSNEXT:	LOADI	A,0XFF
F7/C8: 8414     	LOAD	B,[SRCH_LS]
F7/C9: 5400     	ADDI	B,0
F7/CA: F42A     	BRN	FS1DONE
F7/CB: F70A     	BRNZ	0F
F7/CD:          	
F7/CC:          	; INCREMENT TO NEXT RECORD ON BANK
F7/CC: 8013     	LOAD	A,[SRCH_RP]
F7/CD: 5010     	ADDI	A,16
F7/CE: A013     	STORE	[SRCH_RP],A
F7/CF: F5C1     	BRNN	FSCHECK
F7/D1:          	
F7/D0:          	; INCREMENT TO NEXT BANK
F7/D0: 3000     	LOADI	A,0
F7/D1: A013     	STORE	[SRCH_RP],A
F7/D2: 8012     	LOAD	A,[SRCH_BK]
F7/D3: 5001     	ADDI	A,1
F7/D4: A012     	STORE	[SRCH_BK],A
F7/D5: FFBB     	JUMP	FSCHECK
F7/D7:          	
F7/D6:          	; MOVE ON TO NEXT BLOCK
F7/D6: 8011     0:	LOAD	A,[SRCH_LO]
F7/D7: 5001     	ADDI	A,1
F7/D8: A011     	STORE	[SRCH_LO],A
F7/D9: FFA6     	JUMP	FSSTART
F7/DB:          	
F7/DA:          	; SHADOW OF FOPEN
F7/DA: 8413     FOPENA:	LOAD	B,[SRCH_RP]
F7/DC:          
F7/DB:          	; SAVE THE STACK SO WE CAN USE THE REGISTER FOR TRANSFERS
F7/DB: AC00     	STORE	[M0],D
F7/DD:          	
F7/DC:          	; LOAD OPEN FILE SIZE
F7/DC: 8012     	LOAD	A,[SRCH_BK]
F7/DD: A080     	STORE	[DBANK],A
F7/DE: 990A     	LOADF	C,[B+10]
F7/DF: 9D0B     	LOADF	D,[B+11]
F7/E0: 30FF     	LOADI	A,WORK_B
F7/E1: A080     	STORE	[DBANK],A
F7/E2: A818     	STORE	[OF_SIZE],C
F7/E3: AC19     	STORE	[OF_SIZE+1],D
F7/E5:          	
F7/E4:          	; LOAD OPEN FILE BLOCK TABLE
F7/E4: 8012     	LOAD	A,[SRCH_BK]
F7/E5: A080     	STORE	[DBANK],A
F7/E6: 990D     	LOADF	C,[B+13]
F7/E7: 9D0E     	LOADF	D,[B+14]
F7/E8: 30FF     	LOADI	A,WORK_B
F7/E9: A080     	STORE	[DBANK],A
F7/EA: A816     	STORE	[OF_BTAB],C
F7/EB: AC17     	STORE	[OF_BTAB+1],D
F7/EC: A805     	STORE	[BLK],C
F7/ED: AC06     	STORE	[BLK+1],D
F7/EF:          	
F7/EE:          	; RESTORE STACK AND SET OPEN FLAG
F7/EE: 8C00     	LOAD	D,[M0]
F7/EF: 30FF     	LOADI	A,0XFF
F7/F0: A015     	STORE	[OF_OPEN],A
F7/F2:          	
F7/F1:          	; EXECUTE BLOCK READ
F7/F1: 30F5     	LOADI	A,FBT_B
F7/F2: 34FB     	LOADI	B,BLK0_B
F7/F3: 388B     	LOADI	C,BLKREAD
F7/F4: FF0D     	JUMP	INDIR
F7/F6:          
F7/F5:          
F7/F5:          	; INTERNAL FS1 FUNCTION TO RESET TO WORK BANK AND RETURN
F7/F5: 38FF     FS1DONE:LOADI	C,WORK_B
F7/F6: A880     	STORE	[DBANK],C
F7/F7: FF0B     	JUMP	IRET
F7/F9:          
F7/F8:          	; BANK IS DONE, MOVE ON TO THE NEXT
F7/F8:          BI	= BI-1
F7/F8:          .BANK BI
F6/80:          FS2_B	= BI
F6/80:          .TEXT
F6/80:          
F6/80:          	; SHADOW OF FREAD
F6/80:          	; ERROR IF NO FILE IS OPEN
F6/80: 8415     FREADA:	LOAD	B,[OF_OPEN]
F6/81: 5400     	ADDI	B,0
F6/82: F65C     	BRZ	FS2ERR
F6/84:          	
F6/83:          	; CHECK SIZE
F6/83: 8418     	LOAD	B,[OF_SIZE]
F6/84: 5400     	ADDI	B,0
F6/85: F703     	BRNZ	0F
F6/86: 8419     	LOAD	B,[OF_SIZE+1]
F6/87: D100     	CMP	A,B
F6/88: F056     	BRAE	FS2ERR
F6/8A:          	
F6/89:          	; CALL FACONV
F6/89: 388B     0:	LOADI	C,@+2
F6/8A: FF46     	JUMP	FACONV
F6/8C:          	
F6/8B:          	; GET THE BLOCK
F6/8B: AC00     	STORE	[M0],D
F6/8C: A480     	STORE	[DBANK],B
F6/8D: 9800     	LOADF	C,[A+0]
F6/8E: 9C01     	LOADF	D,[A+1]
F6/8F: 34FF     	LOADI	B,WORK_B
F6/90: A480     	STORE	[DBANK],B
F6/91: A805     	STORE	[BLK],C
F6/92: AC06     	STORE	[BLK+1],D	
F6/93: 8C00     	LOAD	D,[M0]
F6/95:          	
F6/94:          	; EXECUTE BLOCK READ
F6/94: 8004     	LOAD	A,[SRC_BNK]
F6/95: 34FB     	LOADI	B,BLK0_B
F6/96: 388B     	LOADI	C,BLKREAD
F6/97: FF6A     	JUMP	INDIR
F6/99:          	
F6/98:          	; SHADOW OF FWRITE
F6/98:          	; ERROR IF NO FILE IS OPEN
F6/98: 8415     FWRITEA:LOAD	B,[OF_OPEN]
F6/99: 5400     	ADDI	B,0
F6/9A: F644     	BRZ	FS2ERR
F6/9C:          	
F6/9B:          	; CHECK SIZE
F6/9B: 8418     	LOAD	B,[OF_SIZE]
F6/9C: 5400     	ADDI	B,0
F6/9D: F70F     	BRNZ	0F
F6/9E: 8419     	LOAD	B,[OF_SIZE+1]
F6/9F: D100     	CMP	A,B
F6/A0: F83E     	BRA	FS2ERR
F6/A1: F60F     	BRZ	1F
F6/A3:          	
F6/A2:          	; READ AN EXISTING BLOCK
F6/A2:          	; CALL FACONV
F6/A2: 38A4     	LOADI	C,@+2
F6/A3: FF2D     	JUMP	FACONV
F6/A5:          	
F6/A4:          	; GET THE BLOCK
F6/A4: AC00     	STORE	[M0],D
F6/A5: A480     	STORE	[DBANK],B
F6/A6: 9800     	LOADF	C,[A+0]
F6/A7: 9C01     	LOADF	D,[A+1]
F6/A8: 34FF     	LOADI	B,WORK_B
F6/A9: A480     	STORE	[DBANK],B
F6/AA: A805     	STORE	[BLK],C
F6/AB: AC06     	STORE	[BLK+1],D	
F6/AC: 8C00     	LOAD	D,[M0]
F6/AE:          	
F6/AD:          	; EXECUTE BLOCK WRITE
F6/AD: 8004     0:	LOAD	A,[SRC_BNK]
F6/AE: 34FB     	LOADI	B,BLK0_B
F6/AF: 38A4     	LOADI	C,BLKWRIT
F6/B0: FF51     	JUMP	INDIR
F6/B2:          	
F6/B1:          	; ALLOCATE A NEW BLOCK
F6/B1: 7C02     1:	SUBI	D,2
F6/B2: 38F6     	LOADI	C,BI
F6/B3: BB01     	STOREF	[D+1],C
F6/B4: 38B9     	LOADI	C,@+5
F6/B5: BB00     	STOREF	[D],C
F6/B6: 34F2     	LOADI	B,AL0_B
F6/B7: 38B8     	LOADI	C,ALLOC
F6/B8: FF49     	JUMP	INDIR
F6/B9: 5C02     	ADDI	D,2
F6/BA: 5000     	ADDI	A,0
F6/BB: F723     	BRNZ	FS2ERR
F6/BD:          	
F6/BC:          	; SET THE FILE AS DIRTY
F6/BC: 30FF     	LOADI	A,0XFF
F6/BD: A01A     	STORE	[OF_DRTY],A
F6/BF:          	
F6/BE:          	; STORE THE NEW BLOCK
F6/BE: 8019     	LOAD	A,[OF_SIZE+1]
F6/BF: 38C1     	LOADI	C,@+2
F6/C0: FF10     	JUMP	FACONV
F6/C1: AC00     	STORE	[M0],D
F6/C2: 8805     	LOAD	C,[BLK]
F6/C3: 8C06     	LOAD	D,[BLK+1]
F6/C4: A480     	STORE	[DBANK],B
F6/C5: B800     	STOREF	[A+0],C
F6/C6: BC01     	STOREF	[A+1],D
F6/C7: 34FF     	LOADI	B,WORK_B
F6/C8: A480     	STORE	[DBANK],B	
F6/C9: 8C00     	LOAD	D,[M0]
F6/CB:          	
F6/CA:          	; INCREMENT SIZE
F6/CA: 8019     	LOAD	A,[OF_SIZE+1]
F6/CB: 5001     	ADDI	A,1
F6/CC: A019     	STORE	[OF_SIZE+1],A
F6/CD: F1DF     	BRNC	0B
F6/CE: 3001     	LOADI	A,1
F6/CF: A018     	STORE	[OF_SIZE],A
F6/D1:          	
F6/D0:          	; EXECUTE THE READ
F6/D0: FFDC     	JUMP	0B
F6/D2:          
F6/D1:          	; CONVERT TO BANK / ADDRESS FOR BLOCK TABLE LOOP
F6/D1: 34F5     FACONV:	LOADI	B,FBT_B
F6/D2: 4000     	SHIFTL	A
F6/D3: F101     	BRNC	0F
F6/D4: 5402     	ADDI	B,2
F6/D5: 4000     0:	SHIFTL	A
F6/D6: F101     	BRNC	1F
F6/D7: 5401     	ADDI	B,1
F6/D8: C100     1:	SHIFTR	A
F6/D9: FE26     	JUMPR	C
F6/DB:          	
F6/DA:          	; SHADOW OF FCLOSE
F6/DA: 3000     FCLOSEA:LOADI	A,0
F6/DB: A015     	STORE	[OF_OPEN],A
F6/DC: 34F2     	LOADI	B,AL0_B
F6/DD: 3880     	LOADI	C,FLUSH
F6/DE: FF23     	JUMP	INDIR
F6/E0:          	
F6/DF:          	; READ / WRITE ERROR
F6/DF: 30FF     FS2ERR:	LOADI	A,0XFF
F6/E1:          	
F6/E0:          	; INTERNAL FS2 FUNCTION TO RESET TO WORK BANK AND RETURN
F6/E0: 38FF     FS2DONE:LOADI	C,WORK_B
F6/E1: A880     	STORE	[DBANK],C
F6/E2: FF20     	JUMP	IRET
F6/E4:          
F6/E3:          
F6/E3:          	; BANK IS DONE, MOVE ON TO THE NEXT
F6/E3:          BI	= BI-1
F6/E3:          
F6/E3:          ; SYS.S
F6/E3:          ; USER SYSTEM CALL HANDLER
F6/E3:          ; GAVIN TERSTEEG, 2024
F6/E3:          ; SDMAY24-14
F6/E3:          
F6/E3:          .BANK BI
F5/80:          SYS0_B	= BI
F5/80:          .TEXT
F5/80:          
F5/80:          	; SYSTEM CALL HANDLER
F5/80:          	; A = SYSTEM CALL ARGUMENT
F5/80:          	; [M0] = SYSTEM CALL #
F5/80: 8400     SYSHNDL:LOAD	B,[M0]
F5/82:          	
F5/81:          	; 0: S_EXIT
F5/81: 5400     	ADDI	B,0
F5/82: F707     	BRNZ	9F
F5/84:          	
F5/83:          	; CLOSE FILE AND JUMP TO PROMPT
F5/83: 38FF     	LOADI	C,CORE0_B
F5/84: BB01     	STOREF	[D+1],C
F5/85: 38A7     	LOADI	C,DOCMD
F5/86: BB00     	STOREF	[D],C
F5/88:          	
F5/87: 34F8     	LOADI	B,FS0_B
F5/88: 38E6     	LOADI	C,FCLOSE
F5/89: FF78     	JUMP	INDIR
F5/8B:          	
F5/8A:          	; 1: S_PUTC
F5/8A: 7401     9:	SUBI	B,1
F5/8B: F703     	BRNZ	9F
F5/8D:          
F5/8C: 34FC     	LOADI	B,TTY0_B
F5/8D: 3889     	LOADI	C,TTYPUTC
F5/8E: FF73     	JUMP	INDIR
F5/90:          	
F5/8F:          	; 2: S_GETC
F5/8F: 7401     9:	SUBI	B,1
F5/90: F703     	BRNZ	9F
F5/92:          
F5/91: 34FC     	LOADI	B,TTY0_B
F5/92: 389D     	LOADI	C,TTYGETC
F5/93: FF6E     	JUMP	INDIR
F5/95:          	
F5/94:          	; 3: S_STAT
F5/94: 7401     9:	SUBI	B,1
F5/95: F703     	BRNZ	9F
F5/97:          
F5/96: 34FC     	LOADI	B,TTY0_B
F5/97: 38E6     	LOADI	C,TTYSTAT
F5/98: FF69     	JUMP	INDIR
F5/9A:          
F5/99:          	; 4: S_PUTS
F5/99: 7401     9:	SUBI	B,1
F5/9A: F703     	BRNZ	9F
F5/9C:          
F5/9B: 34FC     	LOADI	B,TTY0_B
F5/9C: 3890     	LOADI	C,TTYPUTS
F5/9D: FF64     	JUMP	INDIR
F5/9F:          	
F5/9E:          	; 5: S_INPUT
F5/9E: 7401     9:	SUBI	B,1
F5/9F: F703     	BRNZ	9F
F5/A1:          
F5/A0: 34FC     	LOADI	B,TTY0_B
F5/A1: 38A2     	LOADI	C,TTYINPT
F5/A2: FF5F     	JUMP	INDIR
F5/A4:          	
F5/A3:          	; 6: S_OPEN
F5/A3: 7401     9:	SUBI	B,1
F5/A4: F723     	BRNZ	9F
F5/A6:          
F5/A5:          	; ALLOCATE SPACE ON THE STACK
F5/A5:          	; AND STORE SEARCH ARGUMENT
F5/A5: 7C03     	SUBI	D,3
F5/A6: B302     	STOREF	[D+2],A
F5/A8:          
F5/A7:          	; START BY CLOSING THE FILE
F5/A7: 38F5     	LOADI	C,BI
F5/A8: BB01     	STOREF	[D+1],C
F5/A9: 38AE     	LOADI	C,@+5
F5/AA: BB00     	STOREF	[D],C
F5/AC:          	
F5/AB: 34F8     	LOADI	B,FS0_B
F5/AC: 38E6     	LOADI	C,FCLOSE
F5/AD: FF54     	JUMP	INDIR
F5/AF:          	
F5/AE:          	; GET THE DEFAULT USER AREA
F5/AE: 3800     	LOADI	C,0
F5/AF: A880     	STORE	[DBANK],C
F5/B0: 846B     	LOAD	B,[DFT_USR]
F5/B2:          	
F5/B1:          	; SET THE WORKING USER AREA
F5/B1: 38FF     	LOADI	C,WORK_B
F5/B2: A880     	STORE	[DBANK],C
F5/B3: A408     	STORE	[WRK_USR],B
F5/B5:          
F5/B4:          	; ATTEMPT TO SET PARAMETERS FOR SEARCH
F5/B4: 9302     	LOADF	A,[D+2]
F5/B5: 38BA     	LOADI	C,@+5
F5/B6: BB00     	STOREF	[D],C
F5/B8:          	
F5/B7: 34F8     	LOADI	B,FS0_B
F5/B8: 3880     	LOADI	C,SSPARAM
F5/B9: FF48     	JUMP	INDIR
F5/BB:          	
F5/BA:          	; CHECK TO MAKE SURE IT RETURNS 0X00
F5/BA: 5000     	ADDI	A,0
F5/BB: F724     	BRNZ	SYSERR0
F5/BD:          	
F5/BC:          	; AND SEARCH FOR IT
F5/BC: 3000     	LOADI	A,0
F5/BD: 38C2     	LOADI	C,@+5
F5/BE: BB00     	STOREF	[D],C
F5/C0:          	
F5/BF: 34F8     	LOADI	B,FS0_B
F5/C0: 38D9     	LOADI	C,FSEARCH
F5/C1: FF40     	JUMP	INDIR
F5/C3:          	
F5/C2:          	; DID IT WORK?
F5/C2: 5000     	ADDI	A,0
F5/C3: F71C     	BRNZ	SYSERR0
F5/C5:          	
F5/C4:          	; NOW OPEN IT
F5/C4: 5C03     	ADDI	D,3
F5/C6:          	
F5/C5: 34F8     	LOADI	B,FS0_B
F5/C6: 38E3     	LOADI	C,FOPEN
F5/C7: FF3A     	JUMP	INDIR
F5/C9:          	
F5/C8:          	; 7: S_CLOSE
F5/C8: 7401     9:	SUBI	B,1
F5/C9: F703     	BRNZ	9F
F5/CB:          
F5/CA: 34F8     	LOADI	B,FS0_B
F5/CB: 38E6     	LOADI	C,FCLOSE
F5/CC: FF35     	JUMP	INDIR
F5/CE:          	
F5/CD:          	; 8: S_READ
F5/CD: 7401     9:	SUBI	B,1
F5/CE: F706     	BRNZ	9F
F5/D0:          	
F5/CF:          	; CHECK TO MAKE SURE A FILE IS OPEN
F5/CF: 8415     	LOAD	B,[OF_OPEN]
F5/D0: 5400     	ADDI	B,0
F5/D1: F60E     	BRZ	SYSERR0
F5/D3:          
F5/D2: 34F8     	LOADI	B,FS0_B
F5/D3: 38E9     	LOADI	C,FREAD
F5/D4: FF2D     	JUMP	INDIR
F5/D6:          	
F5/D5:          	; 9: S_WRITE
F5/D5: 7401     9:	SUBI	B,1
F5/D6: A400     	STORE	[M0],B
F5/D7: 34F4     	LOADI	B,SYS1_B
F5/D8: 3880     	LOADI	C,9F
F5/D9: F728     	BRNZ	INDIR
F5/DB:          	
F5/DA:          	; CHECK TO MAKE SURE A FILE IS OPEN
F5/DA: 8415     	LOAD	B,[OF_OPEN]
F5/DB: 5400     	ADDI	B,0
F5/DC: F603     	BRZ	SYSERR0
F5/DE:          
F5/DD: 34F8     	LOADI	B,FS0_B
F5/DE: 38EC     	LOADI	C,FWRITE
F5/DF: FF22     	JUMP	INDIR
F5/E1:          	
F5/E0:          	; SYSCALL ERROR
F5/E0: 5C03     SYSERR0:ADDI	D,3
F5/E1: 30FF     	LOADI	A,0XFF
F5/E2: FF20     	JUMP	IRET
F5/E4:          	
F5/E3:          	; BANK IS DONE, MOVE ON TO THE NEXT
F5/E3:          BI	= BI-1
F5/E3:          .BANK BI
F4/80:          SYS1_B	= BI
F4/80:          .TEXT
F4/80:          
F4/80:          	; 10: S_FSRCH
F4/80: 8400     9:	LOAD	B,[M0]
F4/81: 7401     	SUBI	B,1
F4/82: F71A     	BRNZ	9F
F4/84:          	
F4/83:          	; ALLOCATE SPACE ON THE STACK
F4/83:          	; AND STORE SEARCH ARGUMENT
F4/83: 7C03     	SUBI	D,3
F4/84: B302     	STOREF	[D+2],A
F4/86:          	
F4/85:          	; CHECK TO MAKE SURE THE FILE IS CLOSED
F4/85: 8415     	LOAD	B,[OF_OPEN]
F4/86: 5400     	ADDI	B,0
F4/87: F74A     	BRNZ	SYSERR1
F4/89:          	
F4/88:          	; GET THE DEFAULT USER AREA
F4/88: 3800     	LOADI	C,0
F4/89: A880     	STORE	[DBANK],C
F4/8A: 846B     	LOAD	B,[DFT_USR]
F4/8C:          	
F4/8B:          	; SET THE WORKING USER AREA
F4/8B: 38FF     	LOADI	C,WORK_B
F4/8C: A880     	STORE	[DBANK],C
F4/8D: A408     	STORE	[WRK_USR],B
F4/8F:          
F4/8E:          	; ATTEMPT TO SET PARAMETERS FOR SEARCH
F4/8E: 38F4     	LOADI	C,BI
F4/8F: BB01     	STOREF	[D+1],C
F4/90: 9302     	LOADF	A,[D+2]
F4/91: 3896     	LOADI	C,@+5
F4/92: BB00     	STOREF	[D],C
F4/94:          	
F4/93: 34F8     	LOADI	B,FS0_B
F4/94: 3880     	LOADI	C,SSPARAM
F4/95: FF6C     	JUMP	INDIR
F4/97:          	
F4/96:          	; CHECK TO MAKE SURE IT RETURNS 0X00
F4/96: 5000     	ADDI	A,0
F4/97: F73A     	BRNZ	SYSERR1
F4/99:          	
F4/98:          	; AND SEARCH FOR IT
F4/98: 3000     	LOADI	A,0
F4/99: 5C03     	ADDI	D,3
F4/9B:          	
F4/9A: 34F8     	LOADI	B,FS0_B
F4/9B: 38D9     	LOADI	C,FSEARCH
F4/9C: FF65     	JUMP	INDIR
F4/9E:          	
F4/9D:          	; 11: S_NEXT
F4/9D: 7401     9:	SUBI	B,1
F4/9E: F708     	BRNZ	9F
F4/A0:          	
F4/9F:          	; CHECK TO MAKE SURE THE FILE IS CLOSED
F4/9F: 8415     	LOAD	B,[OF_OPEN]
F4/A0: 5400     	ADDI	B,0
F4/A1: 30FF     	LOADI	A,0XFF
F4/A2: F760     	BRNZ	IRET
F4/A4:          
F4/A3: 3001     	LOADI	A,1
F4/A4: 34F8     	LOADI	B,FS0_B
F4/A5: 38D9     	LOADI	C,FSEARCH
F4/A6: FF5B     	JUMP	INDIR
F4/A8:          	
F4/A7:          	; 12: S_DELET
F4/A7: 7401     9:	SUBI	B,1
F4/A8: F707     	BRNZ	9F
F4/AA:          	
F4/A9:          	; CHECK TO MAKE SURE THE FILE IS OPEN
F4/A9: 8415     	LOAD	B,[OF_OPEN]
F4/AA: 5400     	ADDI	B,0
F4/AB: 30FF     	LOADI	A,0XFF
F4/AC: F656     	BRZ	IRET
F4/AE:          
F4/AD:          	; FREE THE FILE
F4/AD: 34F2     	LOADI	B,AL0_B
F4/AE: 38BE     	LOADI	C,FFREE
F4/AF: FF52     	JUMP	INDIR
F4/B1:          	
F4/B0:          	; 13: S_CREAT
F4/B0: 7401     9:	SUBI	B,1
F4/B1: F703     	BRNZ	9F
F4/B3:          
F4/B2: 34F3     	LOADI	B,SYS2_B
F4/B3: 3880     	LOADI	C,SCREAT
F4/B4: FF4D     	JUMP	INDIR
F4/B6:          	
F4/B5:          	; 14: S_FREE
F4/B5: 7401     9:	SUBI	B,1
F4/B6: F708     	BRNZ	9F
F4/B8:          	
F4/B7:          	; CHECK TO MAKE SURE THE FILE IS CLOSED
F4/B7: 8415     	LOAD	B,[OF_OPEN]
F4/B8: 5400     	ADDI	B,0
F4/B9: 30FF     	LOADI	A,0XFF
F4/BA: F748     	BRNZ	IRET
F4/BC:          	
F4/BB: 30FF     	LOADI	A,0XFF
F4/BC: 34F2     	LOADI	B,AL0_B
F4/BD: 38B5     	LOADI	C,INDEX
F4/BE: FF43     	JUMP	INDIR
F4/C0:          	
F4/BF:          	; 15: S_EXEC
F4/BF: 7401     9:	SUBI	B,1
F4/C0: F705     	BRNZ	9F
F4/C2:          	
F4/C1:          	; SET WORKING USER AREA TO COMMAND LINE BANK
F4/C1: 30FE     	LOADI	A,CMDL_B
F4/C2: A008     	STORE	[WRK_USR],A
F4/C4:          	
F4/C3: 34FF     	LOADI	B,CORE0_B
F4/C4: 3880     	LOADI	C,EXEC
F4/C5: FF3C     	JUMP	INDIR
F4/C7:          	
F4/C6:          	; 16: S_PRNTC
F4/C6: 7401     9:	SUBI	B,1
F4/C7: F703     	BRNZ	9F
F4/C9:          	
F4/C8: 34FA     	LOADI	B,PRT0_B
F4/C9: 3881     	LOADI	C,PRTPUTC
F4/CA: FF37     	JUMP	INDIR
F4/CC:          	
F4/CB:          	; 17: S_PSTAT
F4/CB: 7401     9:	SUBI	B,1
F4/CC: F703     	BRNZ	9F
F4/CE:          	
F4/CD: 34FA     	LOADI	B,PRT0_B
F4/CE: 389D     	LOADI	C,PRTSTAT
F4/CF: FF32     	JUMP	INDIR
F4/D1:          	
F4/D0:          	; UNKNOWN SYSCALL
F4/D0: 30FF     9:	LOADI	A,0XFF
F4/D1: FF31     	JUMP	IRET
F4/D3:          
F4/D2:          	; SYSCALL ERROR
F4/D2: 5C03     SYSERR1:ADDI	D,3
F4/D3: 30FF     	LOADI	A,0XFF
F4/D4: FF2E     	JUMP	IRET
F4/D6:          	
F4/D5:          	; BANK IS DONE, MOVE ON TO THE NEXT
F4/D5:          BI	= BI-1
F4/D5:          .BANK BI
F3/80:          SYS2_B	= BI
F3/80:          .TEXT
F3/80:          
F3/80:          	; SYSTEM CREATE ROUTINE
F3/80:          	; ALLOCATE SPACE ON THE STACK
F3/80:          	; AND STORE SEARCH ARGUMENT
F3/80: 7C03     SCREAT:	SUBI	D,3
F3/81: B302     	STOREF	[D+2],A
F3/83:          
F3/82:          	; START BY CLOSING THE FILE
F3/82: 38F3     	LOADI	C,BI
F3/83: BB01     	STOREF	[D+1],C
F3/84: 3889     	LOADI	C,@+5
F3/85: BB00     	STOREF	[D],C
F3/86: 34F8     	LOADI	B,FS0_B
F3/87: 38E6     	LOADI	C,FCLOSE
F3/88: FF79     	JUMP	INDIR
F3/8A:          	
F3/89:          	; GET THE DEFAULT USER AREA
F3/89: 3800     	LOADI	C,0
F3/8A: A880     	STORE	[DBANK],C
F3/8B: 846B     	LOAD	B,[DFT_USR]
F3/8D:          	
F3/8C:          	; SET THE WORKING USER AREA
F3/8C: 38FF     	LOADI	C,WORK_B
F3/8D: A880     	STORE	[DBANK],C
F3/8E: A408     	STORE	[WRK_USR],B
F3/90:          
F3/8F:          	; ATTEMPT TO SET PARAMETERS FOR SEARCH
F3/8F: 9302     	LOADF	A,[D+2]
F3/90: 3895     	LOADI	C,@+5
F3/91: BB00     	STOREF	[D],C
F3/92: 34F8     	LOADI	B,FS0_B
F3/93: 3880     	LOADI	C,SSPARAM
F3/94: FF6D     	JUMP	INDIR
F3/95: 5000     	ADDI	A,0
F3/96: F722     	BRNZ	SYSERR2
F3/98:          	
F3/97:          	; CHECK PATTERN FOR WILDCARDS
F3/97: 3407     	LOADI	B,MATCH
F3/98: 380A     	LOADI	C,10
F3/99: 9100     0:	LOADF	A,[B]
F3/9A: 703F     	SUBI	A,'?'
F3/9B: 30FF     	LOADI	A,0XFF
F3/9C: F61C     	BRZ	SYSERR2
F3/9D: 7801     	SUBI	C,1
F3/9E: F7FA     	BRNZ	0B
F3/A0:          	
F3/9F:          	; AND SEARCH FOR IT
F3/9F: 3000     	LOADI	A,0
F3/A0: 38A5     	LOADI	C,@+5
F3/A1: BB00     	STOREF	[D],C
F3/A2: 34F8     	LOADI	B,FS0_B
F3/A3: 38D9     	LOADI	C,FSEARCH
F3/A4: FF5D     	JUMP	INDIR
F3/A5: 5000     	ADDI	A,0
F3/A6: F70E     	BRNZ	1F
F3/A8:          	
F3/A7:          	; NOW OPEN IT
F3/A7: 38AC     	LOADI	C,@+5
F3/A8: BB00     	STOREF	[D],C
F3/A9: 34F8     	LOADI	B,FS0_B
F3/AA: 38E3     	LOADI	C,FOPEN
F3/AB: FF56     	JUMP	INDIR
F3/AC: 5000     	ADDI	A,0
F3/AD: F70B     	BRNZ	SYSERR2
F3/AF:          	
F3/AE:          	; AND FREE IT
F3/AE: 38B3     	LOADI	C,@+5
F3/AF: BB00     	STOREF	[D],C
F3/B0: 34F2     	LOADI	B,AL0_B
F3/B1: 38BE     	LOADI	C,FFREE
F3/B2: FF4F     	JUMP	INDIR
F3/B3: 5000     	ADDI	A,0
F3/B4: F704     	BRNZ	SYSERR2
F3/B6:          
F3/B5:          	; NOW WE CAN ALLOCATE A NEW FILE
F3/B5: 5C03     1:	ADDI	D,3
F3/B6: 34F2     	LOADI	B,AL0_B
F3/B7: 38C1     	LOADI	C,FALLOC
F3/B8: FF49     	JUMP	INDIR
F3/BA:          	
F3/B9:          	; SYSCALL ERROR
F3/B9: 5C03     SYSERR2:ADDI	D,3
F3/BA: 30FF     	LOADI	A,0XFF
F3/BB: FF47     	JUMP	IRET
F3/BD:          
F3/BC:          	; BANK IS DONE, MOVE ON TO THE NEXT
F3/BC:          BI	= BI-1
F3/BC:          
F3/BC:          ; ALLOC.S
F3/BC:          ; BLOCK ALLOCATION MANAGEMENT
F3/BC:          ; GAVIN TERSTEEG, 2024
F3/BC:          ; SDMAY24-14
F3/BC:          
F3/BC:          .BANK BI
F2/80:          AL0_B	= BI
F2/80:          .TEXT
F2/80:          
F2/80:          	; FLUSH ANY BUFFERS THAT MAY HAVE BECOME DIRTY
F2/80:          	; ASSUMES WORK BANK IS SELECTED
F2/80:          	; USES: A, B, C, M0
F2/80: 7C02     FLUSH:	SUBI	D,2
F2/81: 38F2     	LOADI	C,BI
F2/82: BB01     	STOREF	[D+1],C
F2/84:          
F2/83:          	; CHECK IF OPEN FILE IS DIRTY
F2/83: 801A     	LOAD	A,[OF_DRTY]
F2/84: 5000     	ADDI	A,0
F2/85: F61E     	BRZ	1F
F2/87:          	
F2/86:          	; RESET OPEN FILE DIRTY FLAG
F2/86: 3000     	LOADI	A,0
F2/87: A01A     	STORE	[OF_DRTY],A
F2/89:          	
F2/88:          	; MOVE FILE SIZE BACK INTO FILE RECORD
F2/88: AC00     	STORE	[M0],D
F2/89: 8818     	LOAD	C,[OF_SIZE]
F2/8A: 8C19     	LOAD	D,[OF_SIZE+1]
F2/8B: 8013     	LOAD	A,[SRCH_RP]
F2/8C: 8412     	LOAD	B,[SRCH_BK]
F2/8D: A480     	STORE	[DBANK],B
F2/8E: B80A     	STOREF	[A+10],C
F2/8F: BC0B     	STOREF	[A+11],D
F2/90: 34FF     	LOADI	B,WORK_B
F2/91: A480     	STORE	[DBANK],B
F2/92: 8C00     	LOAD	D,[M0]
F2/94:          
F2/93:          	; EXECUTE WRITES FOR FILE RECORD AND BTAB
F2/93: 3000     	LOADI	A,0
F2/94: 8411     	LOAD	B,[SRCH_LO]
F2/95: A005     	STORE	[BLK],A
F2/96: A406     	STORE	[BLK+1],B
F2/98:          	
F2/97:          	; WRITE FILE RECORD
F2/97: 30F1     	LOADI	A,KBUF_B
F2/98: 389D     	LOADI	C,@+5
F2/99: BB00     0:	STOREF	[D],C
F2/9A: 34FB     	LOADI	B,BLK0_B
F2/9B: 38A4     	LOADI	C,BLKWRIT
F2/9C: FF65     	JUMP	INDIR
F2/9E:          	
F2/9D:          	; GET ADDRESS OF THE FILE BLOCK TABLE
F2/9D: 8016     	LOAD	A,[OF_BTAB]
F2/9E: 8417     	LOAD	B,[OF_BTAB+1]
F2/9F: A005     	STORE	[BLK],A
F2/A0: A406     	STORE	[BLK+1],B
F2/A2:          	
F2/A1:          	; WRITE FILE BLOCK TABLE
F2/A1: 30F5     	LOADI	A,FBT_B
F2/A2: 38A4     	LOADI	C,@+2
F2/A3: FFF5     	JUMP	0B
F2/A5:          	
F2/A4:          	; CHECK IF ALLOCATION BITMAP IS DIRTY
F2/A4: 8021     1:	LOAD	A,[AB_DRTY]
F2/A5: 5000     	ADDI	A,0
F2/A6: F609     	BRZ	2F
F2/A8:          	
F2/A7:          	; RESET ALLOCATION BITMAP DIRTY FLAG
F2/A7: 3000     	LOADI	A,0
F2/A8: A021     	STORE	[AB_DRTY],A
F2/AA:          	
F2/A9:          	; GET ADDRESS OF CURRENT ALLOCATION BITMAP BLOCK
F2/A9: 3000     	LOADI	A,0
F2/AA: 8420     	LOAD	B,[AB_CBLK]
F2/AB: A005     	STORE	[BLK],A
F2/AC: A406     	STORE	[BLK+1],B
F2/AE:          
F2/AD:          	; WRITE ALLOCATION BITMAP
F2/AD: 30F9     	LOADI	A,ABM_B
F2/AE: 38B0     	LOADI	C,@+2
F2/AF: FFE9     	JUMP	0B
F2/B1:          
F2/B0:          	; RESET STACK AND RETURN
F2/B0: 5C02     2:	ADDI	D,2
F2/B1: 30FF     	LOADI	A,WORK_B
F2/B2: A080     	STORE	[DBANK],A
F2/B3: 3000     	LOADI	A,0
F2/B4: FF4E     	JUMP	IRET
F2/B6:          	
F2/B5:          	; INDEX ALLOCATION BITMAP
F2/B5:          	; SEARCHES FOR A BLOCK IN THE ALLOCATION TABLE
F2/B5:          	; THAT CONTAINS AN EMPTY BLOCK OR ALLOCATED BLOCK
F2/B5:          	; ASSUMES WORK BANK IS SELECTED
F2/B5:          	; A = 0 IF LOOKING FOR EMPTY BLOCK, A = 1 IF LOOKING FOR FULL BLOCK
F2/B5:          	; A = 0XFF IF COUNTING FREE BLOCKS
F2/B5:          	; RETURNS A = 0 IF OPERATION IS SUCCESSFUL, A = 0XFF OTHERWISE
F2/B5:          	; USES: A, B, C, M0, M1, M2
F2/B5: 34F1     INDEX:	LOADI	B,AL1_B
F2/B6: 3880     	LOADI	C,INDEXA
F2/B7: FF4A     	JUMP	INDIR
F2/B9:          	
F2/B8:          	; ALLOCATE BLOCK ON DISK
F2/B8:          	; LOOKS FOR AN UNUSED BLOCK IN THE ALLOCATION BITMAP,
F2/B8:          	; RESERVES IT, AND THEN RETURNS IT.
F2/B8:          	; ADDRESS WILL BE RETURNED IN [BLK]
F2/B8:          	; RETURNS A = 0 IF OPERATION IS SUCCESSFUL, A = 0XFF OTHERWISE
F2/B8:          	; USES: A, B, C, M0, M1, M2
F2/B8: 34F0     ALLOC:	LOADI	B,AL2_B
F2/B9: 3880     	LOADI	C,ALLOCA
F2/BA: FF47     	JUMP	INDIR
F2/BC:          	
F2/BB:          	; FREE BLOCK ON DISK
F2/BB:          	; GIVEN A BLOCK IN [AB_FREE], THE ABM WILL BE
F2/BB:          	; SEARCHED AND THAT BIT WILL BE MARKED AS UNALLOCATED
F2/BB:          	; [AB_FREE] = BLOCK TO FREE
F2/BB:          	; USES: A, B, C, M0, M1, M2
F2/BB: 34EF     FREE:	LOADI	B,AL3_B
F2/BC: 3880     	LOADI	C,FREEA
F2/BD: FF44     	JUMP	INDIR
F2/BF:          	
F2/BE:          	; FREE A FILE
F2/BE:          	; GIVEN AN OPEN FILE, ALL OWNED BLOCKS WILL BE FREED
F2/BE:          	; AND ITS FILE RECORD WILL BE MARKED EMPTY
F2/BE:          	; USES: A, B, C, M0, M1, M2
F2/BE: 34EE     FFREE:	LOADI	B,AL4_B
F2/BF: 3880     	LOADI	C,FFREEA
F2/C0: FF41     	JUMP	INDIR
F2/C2:          	
F2/C1:          	; ALLOCATE A FILE
F2/C1:          	; A FILE RECORD WILL BE RESERVED AND A NEW FILE BLOCK TABLE
F2/C1:          	; WILL BE ALLOCATED
F2/C1:          	; THE FILE WILL BE GIVEN THE NAME OF THE CURRENT FILE MATCH PARAMETER
F2/C1:          	; NO WILDCARDS SHOULD APPEAR IN THE MATCH STRING
F2/C1:          	; USES: A, B, C, M0, M1, M2
F2/C1: 34ED     FALLOC:	LOADI	B,AL5_B
F2/C2: 3880     	LOADI	C,FALLOCA
F2/C3: FF3E     	JUMP	INDIR
F2/C5:          
F2/C4:          	; BANK IS DONE, MOVE ON TO THE NEXT
F2/C4:          BI	= BI-1
F2/C4:          .BANK BI
F1/80:          AL1_B	= BI
F1/80:          .TEXT
F1/80:          	
F1/80:          BD_FREE	= 0X6E
F1/80:          	
F1/80:          	; SHADOW OF INDEX
F1/80: A001     INDEXA: STORE	[M1],A
F1/81: 7C02     	SUBI	D,2
F1/83:          
F1/82:          	; DO WE RESET THE BLOCK COUNT?
F1/82: 5000     	ADDI	A,0
F1/83: F506     	BRNN	0F
F1/85:          	
F1/84:          	; YES, WE DO
F1/84: 3000     	LOADI	A,0
F1/85: A080     	STORE	[DBANK],A
F1/86: A06E     	STORE	[BD_FREE],A
F1/87: A06F     	STORE	[BD_FREE+1],A
F1/89:          	
F1/88:          	; SWITCH BACK THE WORK BANK AND CONTINUE
F1/88: 30FF     	LOADI	A,WORK_B
F1/89: A080     	STORE	[DBANK],A
F1/8B:          	
F1/8A:          	; BEFORE WE DO ANY WORK, LETS FLUSH THE EXISTING BUFFERS
F1/8A: 38F1     0:	LOADI	C,BI
F1/8B: BB01     	STOREF	[D+1],C
F1/8C: 3891     	LOADI	C,@+5
F1/8D: BB00     	STOREF	[D],C
F1/8E: 34F2     	LOADI	B,AL0_B
F1/8F: 3880     	LOADI	C,FLUSH
F1/90: FF71     	JUMP	INDIR
F1/92:          	
F1/91:          	; SET CURRENT AB BLOCK TO 1
F1/91: 3000     	LOADI	A,0
F1/92: A005     	STORE	[BLK],A
F1/93: 3001     	LOADI	A,1
F1/95:          	
F1/94:          	
F1/94:          	; GRAB THE BLOCK AND START PROCESSING
F1/94: A020     0:	STORE	[AB_CBLK],A
F1/95: A006     	STORE	[BLK+1],A
F1/96: 30F9     	LOADI	A,ABM_B
F1/97: 389C     	LOADI	C,@+5
F1/98: BB00     	STOREF	[D],C
F1/99: 34FB     	LOADI	B,BLK0_B
F1/9A: 388B     	LOADI	C,BLKREAD
F1/9B: FF66     	JUMP	INDIR
F1/9D:          	
F1/9C:          	; INIT SEARCH
F1/9C: 3000     	LOADI	A,0
F1/9D: 34F9     	LOADI	B,ABM_B
F1/9F:          	
F1/9E:          	; SEARCH THE BITMAP
F1/9E: A023     1:	STORE	[AB_CPNT],A
F1/9F: A422     	STORE	[AB_BANK],B
F1/A0: A480     	STORE	[DBANK],B
F1/A1: 9800     	LOADF	C,[A]
F1/A2: 34FF     	LOADI	B,WORK_B
F1/A3: A480     	STORE	[DBANK],B
F1/A5:          	
F1/A4:          	; GET BEHAVIOR
F1/A4: 8001     	LOAD	A,[M1]
F1/A5: 5000     	ADDI	A,0
F1/A6: F627     	BRZ	7F
F1/A7: F52A     	BRNN	8F
F1/A9:          	
F1/A8:          	; COUNT BITS IN C
F1/A8: 3000     	LOADI	A,0
F1/A9: A080     	STORE	[DBANK],A
F1/AA: 3408     	LOADI	B,8
F1/AC:          	
F1/AB:          	; KEEP POPPING BITS OFF OF C TILL NONE REMAIN
F1/AB: 4A00     2:	SHIFTL	C
F1/AC: F001     	BRC	3F
F1/AE:          	
F1/AD:          	; ADD 1 TO COUNT
F1/AD: 5001     	ADDI	A,1
F1/AF:          	
F1/AE:          	; ARE WE DONE?
F1/AE: 7401     3:	SUBI	B,1
F1/AF: F7FB     	BRNZ	2B
F1/B1:          	
F1/B0:          	; ADD A TO BIT COUNTER
F1/B0: 846F     	LOAD	B,[BD_FREE+1]
F1/B1: 4400     	ADD	B,A
F1/B2: A46F     	STORE	[BD_FREE+1],B
F1/B3: F103     	BRNC	4F
F1/B4: 846E     	LOAD	B,[BD_FREE]
F1/B5: 5401     	ADDI	B,1
F1/B6: A46E     	STORE	[BD_FREE],B
F1/B8:          	
F1/B7:          	; DONE, BACK TO THE WORK BANK
F1/B7: 30FF     4:	LOADI	A,WORK_B
F1/B8: A080     	STORE	[DBANK],A
F1/BA:          	
F1/B9:          	; GET NEXT CHUNK
F1/B9: 8023     6:	LOAD	A,[AB_CPNT]
F1/BA: 8422     	LOAD	B,[AB_BANK]
F1/BB: 5001     	ADDI	A,1
F1/BC: F5E1     	BRNN	1B
F1/BD: 3000     	LOADI	A,0
F1/BE: 5401     	ADDI	B,1
F1/BF: 38FD     	LOADI	C,ABM_B+4
F1/C0: D600     	CMP	B,C
F1/C1: F7DC     	BRNZ	1B
F1/C3:          	
F1/C2:          	; READ THE NEXT BLOCK
F1/C2: 8020     	LOAD	A,[AB_CBLK]
F1/C3: 5001     	ADDI	A,1
F1/C4: 3411     	LOADI	B,17
F1/C5: D100     	CMP	A,B
F1/C6: F7CD     	BRNZ	0B
F1/C8:          	
F1/C7:          	; WE DIDN'T FIND IT
F1/C7:          	; OR WE ARE JUST DONE COUNTING
F1/C7:          	; COULD BE EITHER
F1/C7: 8401     	LOAD	B,[M1]
F1/C8: 30FF     	LOADI	A,0xFF
F1/C9: 5400     	ADDI	B,0
F1/CA: F50A     	BRNN	9F	; NOPE, RIP :(
F1/CC:          	
F1/CB:          	; YAY, LETS DO IT AGAIN
F1/CB: 3000     	LOADI	A,0
F1/CC: 5C02     	ADDI	D,2
F1/CD: FFB2     	JUMP	INDEXA
F1/CF:          	
F1/CE:          	; CHECK TO SEE IF CHUNK HAS AN EMPTY BLOCK
F1/CE: 5801     7:	ADDI	C,1
F1/CF: F6E9     	BRZ	6B
F1/D0: 3000     	LOADI	A,0
F1/D1: FF03     	JUMP	9F
F1/D3:          
F1/D2:          	; CHECK TO SEE IF CHUNK HAS A FILLED BLOCK
F1/D2: 5800     8:	ADDI	C,0
F1/D3: F6E5     	BRZ	6B
F1/D4: 3000     	LOADI	A,0
F1/D6:          
F1/D5:          	; RESTORE STACK
F1/D5: 5C02     9:	ADDI	D,2
F1/D7:          
F1/D6: 34FF     AL1DONE:LOADI	B,WORK_B
F1/D7: A480     	STORE	[DBANK],B
F1/D8: FF2A     	JUMP	IRET
F1/DA:          
F1/D9:          	; BANK IS DONE, MOVE ON TO THE NEXT
F1/D9:          BI	= BI-1
F1/D9:          .BANK BI
F0/80:          AL2_B	= BI
F0/80:          .TEXT
F0/80:          
F0/80:          	; SHADOW OF ALLOC
F0/80: 7C02     ALLOCA:	SUBI	D,2
F0/82:          
F0/81:          	; START SEARCH FOR AN EMPTY BIT
F0/81: 8422     0:	LOAD	B,[AB_BANK]
F0/82: 8823     	LOAD	C,[AB_CPNT]
F0/83: AC01     	STORE	[M1],D
F0/85:          
F0/84:          	; SEARCH MEMORY BANK
F0/84: A480     1:	STORE	[DBANK],B
F0/86:          
F0/85:          	; CHECK BYTE
F0/85: 9200     2:	LOADF	A,[C]
F0/86: 5001     	ADDI	A,1
F0/87: F715     	BRNZ	3F
F0/88: 5801     	ADDI	C,1
F0/89: F5FB     	BRNN	2B
F0/8B:          	
F0/8A:          	; MOVE ON TO NEXT BANK
F0/8A: 5401     	ADDI	B,1
F0/8B: 38FD     	LOADI	C,ABM_B+4
F0/8C: D600     	CMP	B,C
F0/8D: 3800     	LOADI	C,0
F0/8E: F7F5     	BRNZ	1B
F0/90:          	
F0/8F:          	; AT THIS POINT, JUST RE-INDEX
F0/8F: 30FF     	LOADI	A,WORK_B
F0/90: A080     	STORE	[DBANK],A
F0/91: 3000     	LOADI	A,0
F0/92: 38F0     	LOADI	C,BI
F0/93: BB01     	STOREF	[D+1],C
F0/94: 3899     	LOADI	C,@+5
F0/95: BB00     	STOREF	[D],C
F0/96: 34F2     	LOADI	B,AL0_B
F0/97: 38B5     	LOADI	C,INDEX
F0/98: FF69     	JUMP	INDIR
F0/99: AC01     	STORE	[M1],D
F0/9B:          	
F0/9A:          	; DID IT WORK?
F0/9A: 5000     	ADDI	A,0
F0/9B: F730     	BRNZ	9F
F0/9C: FFE4     	JUMP	0B
F0/9E:          
F0/9D:          	; WE FOUND ONE
F0/9D: 7001     3:	SUBI	A,1
F0/9E: 3CFF     	LOADI	D,WORK_B
F0/9F: AC80     	STORE	[DBANK],D
F0/A1:          	
F0/A0:          	; SAVE BANK AND CPNT
F0/A0: A422     	STORE	[AB_BANK],B
F0/A1: A823     	STORE	[AB_CPNT],C
F0/A3:          	
F0/A2:          	; GET THE BIT #
F0/A2: 3C00     	LOADI	D,0
F0/A3: C100     4:	SHIFTR	A
F0/A4: F102     	BRNC	4F
F0/A5: 5C01     	ADDI	D,1
F0/A6: FFFC     	JUMP	4B
F0/A8:          
F0/A7:          	; STORE IT AND THEN MASK THE ENTRY IN THE ABM
F0/A7: AC00     4:	STORE	[M0],D
F0/A8: 3001     	LOADI	A,1
F0/A9: 7C01     5:	SUBI	D,1
F0/AA: F102     	BRNC	6F
F0/AB: 4000     	SHIFTL	A
F0/AC: FFFC     	JUMP	5B
F0/AD: A480     6:	STORE	[DBANK],B
F0/AE: 9E00     	LOADF	D,[C]
F0/AF: 4C00     	ADD	D,A
F0/B0: BE00     	STOREF	[C],D
F0/B1: 30FF     	LOADI	A,WORK_B
F0/B2: A080     	STORE	[DBANK],A
F0/B4:          	
F0/B3:          	; SET ABM DIRTY FLAG
F0/B3: 30FF     	LOADI	A,0XFF
F0/B4: A021     	STORE	[AB_DRTY],A
F0/B6:          	
F0/B5:          	; CALCULATE WHAT BLOCK # THAT WE JUST ALLOCATED
F0/B5: 8020     	LOAD	A,[AB_CBLK]
F0/B6: 7001     	SUBI	A,1
F0/B7: 4000     	SHIFTL	A
F0/B8: 4000     	SHIFTL	A
F0/B9: 4000     	SHIFTL	A
F0/BA: 4000     	SHIFTL	A
F0/BB: 74F9     	SUBI	B,ABM_B
F0/BC: 4A00     	SHIFTL	C
F0/BD: 4500     	SHIFTL	B
F0/BE: 4A00     	SHIFTL	C
F0/BF: F101     	BRNC	0F
F0/C0: 5401     	ADDI	B,1
F0/C1: 4500     0:	SHIFTL	B
F0/C2: 4A00     	SHIFTL	C
F0/C3: F101     	BRNC	1F
F0/C4: 5401     	ADDI	B,1
F0/C5: 4400     1:	ADD	B,A
F0/C6: 8000     	LOAD	A,[M0]
F0/C7: 4800     	ADD	C,A
F0/C9:          	
F0/C8:          	; SAVE IN [BLK]
F0/C8: 3000     	LOADI	A,0
F0/C9: A405     	STORE	[BLK],B
F0/CA: A806     	STORE	[BLK+1],C
F0/CC:          	
F0/CB:          	; RESTORE THE STACK
F0/CB: 8C01     	LOAD	D,[M1]
F0/CC: 5C02     9:	ADDI	D,2
F0/CE:          
F0/CD: 34FF     AL2DONE:LOADI	B,WORK_B
F0/CE: A480     	STORE	[DBANK],B
F0/CF: FF33     	JUMP	IRET
F0/D1:          
F0/D0:          	; BANK IS DONE, MOVE ON TO THE NEXT
F0/D0:          BI	= BI-1
F0/D0:          .BANK BI
EF/80:          AL3_B	= BI
EF/80:          .TEXT
EF/80:          
EF/80:          	; SHADOW OF FREE
EF/80: 7C02     FREEA:	SUBI	D,2
EF/82:          
EF/81:          	; START BY MAKING SURE AB_CBLK IS CORRECT
EF/81: 8025     0:	LOAD	A,[AB_FREE]
EF/82: 8420     	LOAD	B,[AB_CBLK]
EF/83: C100     	SHIFTR	A
EF/84: C100     	SHIFTR	A
EF/85: C100     	SHIFTR	A
EF/86: C100     	SHIFTR	A
EF/87: 5001     	ADDI	A,1
EF/88: D100     	CMP	A,B
EF/89: F613     	BRZ	1F
EF/8B:          	
EF/8A:          	; NOPE, LET'S FIX THAT
EF/8A:          	; START BY FLUSHING
EF/8A: A001     	STORE	[M1],A
EF/8B: 38EF     	LOADI	C,BI
EF/8C: BB01     	STOREF	[D+1],C
EF/8D: 3892     	LOADI	C,@+5
EF/8E: BB00     	STOREF	[D],C
EF/8F: 34F2     	LOADI	B,AL0_B
EF/90: 3880     	LOADI	C,FLUSH
EF/91: FF70     	JUMP	INDIR
EF/93:          	
EF/92:          	; READ THE CORRECT AB_CBLK
EF/92: 8001     	LOAD	A,[M1]
EF/93: A006     	STORE	[BLK+1],A
EF/94: A020     	STORE	[AB_CBLK],A
EF/95: 3000     	LOADI	A,0
EF/96: A005     	STORE	[BLK],A
EF/97: 30F9     	LOADI	A,ABM_B
EF/98: 3881     	LOADI	C,0B
EF/99: BB00     	STOREF	[D],C
EF/9A: 34FB     	LOADI	B,BLK0_B
EF/9B: 388B     	LOADI	C,BLKREAD
EF/9C: FF65     	JUMP	INDIR
EF/9E:          	
EF/9D:          	; ALL GOOD, NOW LETS GET THE BANK / POINTER / BIT
EF/9D: AC01     1:	STORE	[M1],D
EF/9E: 8025     	LOAD	A,[AB_FREE]
EF/9F: 8426     	LOAD	B,[AB_FREE+1]
EF/A1:          	
EF/A0:          	; FIRST GET THE BIT
EF/A0: 3800     	LOADI	C,0
EF/A1: 3C03     	LOADI	D,3
EF/A2: C900     0:	SHIFTR	C
EF/A3: C500     	SHIFTR	B
EF/A4: F101     	BRNC	1F
EF/A5: 5804     	ADDI	C,0X04
EF/A6: C100     1:	SHIFTR	A
EF/A7: F101     	BRNC	2F
EF/A8: 5480     	ADDI	B,0X80
EF/A9: 7C01     2:	SUBI	D,1
EF/AA: F7F7     	BRNZ	0B
EF/AB: A824     	STORE	[AB_BIT],C
EF/AD:          	
EF/AC:          	; THEN GET THE POINTER
EF/AC: 3800     	LOADI	C,0
EF/AD: 3C07     	LOADI	D,7
EF/AE: C900     0:	SHIFTR	C
EF/AF: C500     	SHIFTR	B
EF/B0: F101     	BRNC	1F
EF/B1: 5840     	ADDI	C,0X40
EF/B2: C100     1:	SHIFTR	A
EF/B3: F101     	BRNC	2F
EF/B4: 5480     	ADDI	B,0X80
EF/B5: 7C01     2:	SUBI	D,1
EF/B6: F7F7     	BRNZ	0B
EF/B7: A823     	STORE	[AB_CPNT],C
EF/B9:          	
EF/B8:          	; WE SHOULD BE LEFT WITH THE CORRECT BANK TOO
EF/B8: 54F9     	ADDI	B,ABM_B
EF/B9: A422     	STORE	[AB_BANK],B
EF/BB:          	
EF/BA:          	; LETS GO MAKE SURE THAT WE CAN ACTUALLY FREE THIS BLOCK
EF/BA: 8024     	LOAD	A,[AB_BIT]
EF/BB: A480     	STORE	[DBANK],B
EF/BC: 9E00     	LOADF	D,[C]
EF/BD: 7001     0:	SUBI	A,1
EF/BE: F102     	BRNC	1F
EF/BF: CD00     	SHIFTR	D
EF/C0: FFFC     	JUMP	0B
EF/C1: CD00     1:	SHIFTR	D
EF/C2: 3CFF     	LOADI	D,WORK_B
EF/C3: AC80     	STORE	[DBANK],D
EF/C5:          
EF/C4:          	; IF IT'S ZERO, WE CAN EXIT RIGHT NOW
EF/C4: F10E     	BRNC	9F
EF/C6:          	
EF/C5:          	; SET ABM DIRTY FLAG
EF/C5: 30FF     	LOADI	A,0XFF
EF/C6: A021     	STORE	[AB_DRTY],A
EF/C8:          	
EF/C7:          	; ALRIGHT, LETS GO DEALLOCATE IT
EF/C7: 8024     	LOAD	A,[AB_BIT]
EF/C8: 3C01     	LOADI	D,1
EF/C9: 7001     0:	SUBI	A,1
EF/CA: F102     	BRNC	1F
EF/CB: 4F00     	SHIFTL	D
EF/CC: FFFC     	JUMP	0B
EF/CD: A480     1:	STORE	[DBANK],B
EF/CE: 9200     	LOADF	A,[C]
EF/CF: 6300     	SUB	A,D
EF/D0: B200     	STOREF	[C],A
EF/D1: 30FF     	LOADI	A,WORK_B
EF/D2: A080     	STORE	[DBANK],A
EF/D4:          
EF/D3:          	; RESTORE THE STACK
EF/D3: 8C01     9:	LOAD	D,[M1]
EF/D4: 5C02     	ADDI	D,2
EF/D6:          
EF/D5: 34FF     AL3DONE:LOADI	B,WORK_B
EF/D6: A480     	STORE	[DBANK],B
EF/D7: FF2B     	JUMP	IRET
EF/D9:          	
EF/D8:          	; BANK IS DONE, MOVE ON TO THE NEXT
EF/D8:          BI	= BI-1
EF/D8:          .BANK BI
EE/80:          AL4_B	= BI
EE/80:          .TEXT
EE/80:          
EE/80:          	; SHADOW OF FFREE
EE/80: 7C02     FFREEA:	SUBI	D,2
EE/82:          
EE/81:          	; SET RETURN BANK
EE/81: 38EE     	LOADI	C,BI
EE/82: BB01     	STOREF	[D+1],C
EE/84:          
EE/83:          	; START BY FREEING ALL FILE CONTENT BLOCKS IN BTAB
EE/83: 8019     0:	LOAD	A,[OF_SIZE+1]
EE/84: 7001     	SUBI	A,1
EE/85: A019     	STORE	[OF_SIZE+1],A
EE/86: F004     	BRC	1F
EE/87: 8018     	LOAD	A,[OF_SIZE]
EE/88: 7001     	SUBI	A,1
EE/89: A018     	STORE	[OF_SIZE],A
EE/8A: F117     	BRNC	4F
EE/8C:          
EE/8B:          	; FREE BLOCK POINTED TO BY [OF_SIZE]
EE/8B: 8019     1:	LOAD	A,[OF_SIZE+1]
EE/8C: 34F5     	LOADI	B,FBT_B
EE/8D: 4000     	SHIFTL	A
EE/8E: F101     	BRNC	2F
EE/8F: 5402     	ADDI	B,2
EE/90: 4000     2:	SHIFTL	A
EE/91: F101     	BRNC	3F
EE/92: 5401     	ADDI	B,1
EE/93: C100     3:	SHIFTR	A
EE/95:          	
EE/94:          	; GET THE BLOCK
EE/94: AC00     	STORE	[M0],D
EE/95: A480     	STORE	[DBANK],B
EE/96: 9800     	LOADF	C,[A+0]
EE/97: 9C01     	LOADF	D,[A+1]
EE/98: 34FF     	LOADI	B,WORK_B
EE/99: A480     	STORE	[DBANK],B
EE/9A: A825     	STORE	[AB_FREE],C
EE/9B: AC26     	STORE	[AB_FREE+1],D	
EE/9C: 8C00     	LOAD	D,[M0]
EE/9E:          	
EE/9D:          	; CALL FREE
EE/9D: 3883     	LOADI	C,0B
EE/9E: BB00     	STOREF	[D],C
EE/9F: 34F2     	LOADI	B,AL0_B
EE/A0: 38BB     	LOADI	C,FREE
EE/A1: FF60     	JUMP	INDIR
EE/A3:          
EE/A2:          	; NEXT, WE FREE THE BLOCK TABLE ITSELF
EE/A2: 8016     4:	LOAD	A,[OF_BTAB]
EE/A3: 8417     	LOAD	B,[OF_BTAB+1]
EE/A4: A025     	STORE	[AB_FREE],A
EE/A5: A426     	STORE	[AB_FREE+1],B	
EE/A7:          	
EE/A6:          	; CALL FREE
EE/A6: 38AB     	LOADI	C,@+5
EE/A7: BB00     	STOREF	[D],C
EE/A8: 34F2     	LOADI	B,AL0_B
EE/A9: 38BB     	LOADI	C,FREE
EE/AA: FF57     	JUMP	INDIR
EE/AC:          	
EE/AB:          	; FINALLY, WE STRIKE OUT THE FILE RECORD
EE/AB: 8013     	LOAD	A,[SRCH_RP]
EE/AC: 8412     	LOAD	B,[SRCH_BK]
EE/AD: 3800     	LOADI	C,0
EE/AE: A480     	STORE	[DBANK],B
EE/AF: B800     	STOREF	[A],C
EE/B0: 34FF     	LOADI	B,WORK_B
EE/B1: A480     	STORE	[DBANK],B
EE/B3:          	
EE/B2:          	; RESET OPEN FILE FLAG
EE/B2: 3000     	LOADI	A,0
EE/B3: A015     	STORE	[OF_OPEN],A
EE/B5:          
EE/B4:          	; SET THE FILE DIRTY FLAG
EE/B4: 30FF     	LOADI	A,0XFF
EE/B5: A01A     	STORE	[OF_DRTY],A
EE/B7:          
EE/B6:          	; RESTORE THE STACK
EE/B6: 5C02     	ADDI	D,2
EE/B8:          	
EE/B7:          	; DO ONE FINAL FLUSH
EE/B7: 34F2     	LOADI	B,AL0_B
EE/B8: 3880     	LOADI	C,FLUSH
EE/B9: FF48     	JUMP	INDIR
EE/BB:          	
EE/BA:          	; BANK IS DONE, MOVE ON TO THE NEXT
EE/BA:          BI	= BI-1
EE/BA:          .BANK BI
ED/80:          AL5_B	= BI
ED/80:          .TEXT
ED/80:          
ED/80:          	; SHADOW OF FALLOC
ED/80: 7C02     FALLOCA:SUBI	D,2
ED/82:          	
ED/81:          	; LOOK FOR AN EMPTY FILE RECORD
ED/81: 3000     	LOADI	A,0
ED/82: 38ED     	LOADI	C,BI
ED/83: BB01     	STOREF	[D+1],C
ED/84: 3889     	LOADI	C,@+5
ED/85: BB00     	STOREF	[D],C
ED/86: 34F8     	LOADI	B,FS0_B
ED/87: 38D7     	LOADI	C,FEMPTY
ED/88: FF79     	JUMP	INDIR
ED/89: 5000     	ADDI	A,0
ED/8A: F72B     	BRNZ	9F
ED/8C:          	
ED/8B:          	; LETS ALLOCATE A BLOCK FOR THE FBT NOW
ED/8B: 3890     	LOADI	C,@+5
ED/8C: BB00     	STOREF	[D],C
ED/8D: 34F2     	LOADI	B,AL0_B
ED/8E: 38B8     	LOADI	C,ALLOC
ED/8F: FF72     	JUMP	INDIR
ED/90: 5000     	ADDI	A,0
ED/91: F724     	BRNZ	9F
ED/93:          	
ED/92:          	; COPY FBT ADDRESS INTO RECORD
ED/92: AC00     	STORE	[M0],D
ED/93: 8005     	LOAD	A,[BLK]
ED/94: 8406     	LOAD	B,[BLK+1]
ED/95: 8813     	LOAD	C,[SRCH_RP]
ED/96: 8C12     	LOAD	D,[SRCH_BK]
ED/97: AC80     	STORE	[DBANK],D
ED/98: B20D     	STOREF	[C+13],A
ED/99: B60E     	STOREF	[C+14],B
ED/9A: 3000     	LOADI	A,0
ED/9B: B20A     	STOREF	[C+10],A	; RESET FILE SIZE WHILE WE ARE HERE
ED/9C: B20B     	STOREF	[C+11],A
ED/9D: 30FF     	LOADI	A,WORK_B
ED/9E: A080     	STORE	[DBANK],A
ED/A0:          	
ED/9F:          	; COPY PATTERN INTO FILE RECORD
ED/9F: 3C09     	LOADI	D,9
ED/A0: 3807     0:	LOADI	C,MATCH
ED/A1: 8413     	LOAD	B,[SRCH_RP]
ED/A2: 8012     	LOAD	A,[SRCH_BK]
ED/A3: 4B00     	ADD	C,D
ED/A4: 9A00     	LOADF	C,[C]
ED/A5: A080     	STORE	[DBANK],A
ED/A6: 4700     	ADD	B,D
ED/A7: B900     	STOREF	[B],C
ED/A8: 30FF     	LOADI	A,WORK_B
ED/A9: A080     	STORE	[DBANK],A
ED/AA: 7C01     	SUBI	D,1
ED/AB: F101     	BRNC	1F
ED/AC: FFF3     	JUMP	0B
ED/AE:          	
ED/AD:          	; ATTEMPT TO OPEN FILE
ED/AD: 8C00     1:	LOAD	D,[M0]
ED/AE: 38B3     	LOADI	C,@+5
ED/AF: BB00     	STOREF	[D],C
ED/B0: 34F8     	LOADI	B,FS0_B
ED/B1: 38E3     	LOADI	C,FOPEN
ED/B2: FF4F     	JUMP	INDIR
ED/B4:          	
ED/B3:          	; SET FILE AS DIRTY
ED/B3: 30FF     	LOADI	A,0XFF
ED/B4: A01A     	STORE	[OF_DRTY],A
ED/B5: 3000     	LOADI	A,0
ED/B7:          
ED/B6:          	; RESTORE STACK AND EXIT
ED/B6: 5C02     9:	ADDI	D,2
ED/B7: 34FF     	LOADI	B,WORK_B
ED/B8: A480     	STORE	[DBANK],B
ED/B9: FF49     	JUMP	IRET
ED/BB:          
ED/BA:          	; BANK IS DONE, MOVE ON TO THE NEXT
ED/BA:          BI	= BI-1
ED/BA:          
ED/BA:          ; END.S
ED/BA:          ; DEFINES SYMBOLS BASED ON ASSEMBLY STATE
ED/BA:          ; GAVIN TERSTEEG, 2024
ED/BA:          ; SDMAY24-14
ED/BA:          
ED/BA:          MAX_IB	= BI
ED/BA:          MAX_DB	= BD
