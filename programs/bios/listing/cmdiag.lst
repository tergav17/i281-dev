00/00:          ; CMDIAG.S
01/00:          ; CODE MEMORY DIAGNOSTIC
01/00:          ; GAVIN TERSTEEG, 2024
01/00:          ; SDMAY24-14
01/00:          
01/00:          ; THIS TEST WILL PARTIALLY EXERCISE CODE MEMORY 
01/00:          ; FOR ALL CMEM LOCATIONS, A SHORT STUB PROGRAM WILL
01/00:          ; BE GENERATED, AND THEN CALLED. THE PROGRAM IS AS
01/00:          ; FOLLOWS:
01/00:          ;
01/00:          ;	LOADI	A,?
01/00:          ;	JUMP	PASS
01/00:          ;
01/00:          ; FOR ALL PERMUTATIONS '?'
01/00:          ;
01/00:          ; SHOULD THE PROGRAM COUNTER OVERFLOW OR REGISTER FAIL
01/00:          ; TO RETURN THE EXPECTED VALUE, AND ERROR WILL BE RECORDED 
01/00:          ;
01/00:          ; SENSE SWITCH FUNCTIONS:
01/00:          ;
01/00:          ; SW0: 0 = RESET AND WAIT ON FAIL, 1 = PRESERVE CONTEXT ON FAIL
01/00:          ; SW1: 0 = HALT ON FAIL, 1 = CONTINUE EXECUTION
01/00:          ; SW2: 0 = INCREMENT CONTEXT AFTER TEST, 1 = RETRY TEST
01/00:          
01/00:          .BANK 0
00/00:          .TEXT
00/00:          
00/00:          	; JUMP TABLE 
00/00: FF01     	JUMP	FAIL
00/01: FF0F     	JUMP	PASS
00/03:          
00/02:          	; EITHER THE TEST HAS JUST STARTED OR A PASS HAS FAILED
00/02: 1208     FAIL:	INPUTD	[TEMP]
00/03: 8808     	LOAD	C,[TEMP]
00/05:          
00/04:          	; CHECK FOR INIT
00/04: C900     	SHIFTR	C
00/05: F005     	BRC	INIT
00/07:          	
00/06:          	; CHECK FOR HALT
00/06: C900     	SHIFTR	C
00/07: F1FA     	BRNC	FAIL
00/09:          	
00/08:          	; DO WE INCREMENT COUNTER OR TRY AGAIN?
00/08: C900     	SHIFTR	C
00/09: F01B     	BRC	ATTEMPT
00/0A: FF0F     	JUMP	NEXT
00/0C:          	
00/0B:          	; INITALIZE TEST
00/0B: 3000     INIT:	LOADI	A,0
00/0C: A000     	STORE	[TESTVAL],A
00/0D: A002     	STORE	[ADDRESS],A
00/0E: A004     	STORE	[BANK],A
00/0F: A006     	STORE	[DELTA],A
00/10: FF14     	JUMP	NEWBANK
00/12:          	
00/11:          	; FIRST, CHECK AND MAKE SURE THAT 'A' MATCHES THE
00/11:          	; EXPECTED TEST VALUE
00/11: 8400     PASS:	LOAD	B,[TESTVAL]
00/12: D100     	CMP	A,B
00/13: F7EE     	BRNZ	FAIL
00/15:          	
00/14:          	; GET THE SWITCH VALUE
00/14: 1208     	INPUTD	[TEMP]
00/15: 8808     	LOAD	C,[TEMP]
00/16: C900     	SHIFTR	C
00/17: C900     	SHIFTR	C
00/18: C900     	SHIFTR	C
00/19: F00B     	BRC	ATTEMPT
00/1B:          	
00/1A:          	; INCREMENT CONTEXT
00/1A: 8000     NEXT:	LOAD	A,[TESTVAL]
00/1B: 5001     	ADDI	A,1
00/1C: A000     	STORE	[TESTVAL],A
00/1D: F107     	BRNC	ATTEMPT
00/1E: 8002     	LOAD	A,[ADDRESS]
00/1F: 5001     	ADDI	A,1
00/20: A002     	STORE	[ADDRESS],A
00/21: F103     	BRNC	ATTEMPT
00/23:          	
00/22:          	; NEXT BANK
00/22: 8004     	LOAD	A,[BANK]
00/23: 5001     	ADDI	A,1
00/24: A004     	STORE	[BANK],A
00/26:          	
00/25:          	; FILL BANK WITH NOOP INSTRUCTIONS
00/25:          NEWBANK:
00/25:          
00/25:          
00/25:          ATTEMPT:
00/25:          
00/25:          
00/25:          
00/25:          
00/25:          	; MEMORY AREAS
00/25:          .BSS
00/25:          
00/00:          	; STATE DATA
00/00: 0000     .DEFL BYTE TESTVAL	0,0
00/02: 0000     .DEFL BYTE ADDRESS	0,0
00/04: 0000     .DEFL BYTE BANK		0,0
00/06: 0000     .DEFL BYTE DELTA	0,0
00/08:          
00/08:          
00/08:          	; TEMP VALUE
00/08: 00       .DEFL BYTE TEMP 	0
