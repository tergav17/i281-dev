00/00:          ; DMDIAG.S
01/00:          ; DATA MEMORY DIAGNOSTIC
01/00:          ; GAVIN TERSTEEG, 2024
01/00:          ; SDMAY24-14
01/00:          
01/00:          ; THIS TEST WILL EXERCISE DATA MEMORY FOR ALL DATA MEMORY LOCATIONS
01/00:          ; THE GOAL IS TO MAKE SURE THAT ALL WRITES AND READBACKS ARE SANE
01/00:          ; VALUES, NO ATTEMPT AT TESTING DOUBLE WRITES IS MADE
01/00:          ;
01/00:          ; SW0: 0 = RESET AND WAIT ON FAIL, 1 = PRESERVE CONTEXT ON FAIL
01/00:          ; SW1: 0 = HALT ON FAIL, 1 = CONTINUE EXECUTION
01/00:          ; SW2: 0 = INCREMENT CONTEXT AFTER TEST, 1 = RETRY TEST
01/00:          
01/00:          DBANK	= 0X80
01/00:          
01/00:          .BANK 0
00/00:          .TEXT
00/00:          
00/00:          
00/00:          
00/00:          	; EITHER THE TEST HAS JUST STARTED OR A PASS HAS FAILED
00/00:          FAIL:	
00/00: 3000     	LOADI	A,0
00/01: A080     	STORE	[DBANK],A
00/03:          
00/02:          	; GET THE SENSE SWITCHE 
00/02: 1208     0:	INPUTD	[TEMP]
00/03: 8808     	LOAD	C,[TEMP]
00/05:          
00/04:          	; CHECK FOR INIT
00/04: C900     	SHIFTR	C
00/05: F105     	BRNC	INIT
00/07:          	
00/06:          	; CHECK FOR HALT
00/06: C900     	SHIFTR	C
00/07: F1FA     	BRNC	0B
00/09:          	
00/08:          	; DO WE INCREMENT COUNTER OR TRY AGAIN?
00/08: C900     	SHIFTR	C
00/09: F021     	BRC	ATTEMPT
00/0A: FF0D     	JUMP	NEXT
00/0C:          	
00/0B:          	; INITALIZE TEST
00/0B: 3000     INIT:	LOADI	A,0
00/0C: A001     	STORE	[DELTA],A
00/0D: A005     	STORE	[ADDRESS],A
00/0E: A003     	STORE	[TESTVAL],A
00/0F: 3001     	LOADI	A,1
00/10: A080     	STORE	[DBANK],A
00/12:          	
00/11:          	; WAIT FOR TEST TO START
00/11: 1208     0:	INPUTD	[TEMP]
00/12: 8808     	LOAD	C,[TEMP]
00/13: C900     	SHIFTR	C
00/14: F1FC     	BRNC	0B
00/16:          	
00/15: FF15     	JUMP	ATTEMPT
00/17:          
00/16:          	; THE TEST PASSED 
00/16:          	; MOVE ON TO THE NEXT
00/16: 3000     PASS:	LOADI	A,0
00/17: A080     	STORE	[DBANK],A
00/19:          	
00/18:          	; INCREMENT DELTA
00/18: 8401     NEXT:	LOAD	B,[DELTA]
00/19: 5401     	ADDI	B,1
00/1A: A401     	STORE	[DELTA],B
00/1C:          	
00/1B:          	; INCREMENT TEST VALUE
00/1B: 8003     	LOAD	A,[TESTVAL]
00/1C: 5001     	ADDI	A,1
00/1D: A003     	STORE	[TESTVAL],A
00/1E: F70C     	BRNZ	ATTEMPT
00/20:          	
00/1F:          	; INCREMENT ADDRESS
00/1F: 8005     	LOAD	A,[ADDRESS]
00/20: 5001     	ADDI	A,1
00/21: A005     	STORE	[ADDRESS],A
00/22: F508     	BRNN	ATTEMPT
00/23: 3000     	LOADI	A,0
00/24: A005     	STORE	[ADDRESS],A
00/26:          	
00/25:          	; INCREMENT BANK
00/25: 8007     	LOAD	A,[BANK]
00/26: 5001     	ADDI	A,1
00/27: A007     	STORE	[BANK],A
00/28: F702     	BRNZ	ATTEMPT
00/29: 3001     	LOADI	A,1
00/2A: A007     	STORE	[BANK],A
00/2C:          
00/2B:          	; DO ATTEMPT
00/2B: 8803     ATTEMPT:LOAD	C,[TESTVAL]
00/2C: 8007     	LOAD	A,[BANK]
00/2D: 8405     	LOAD	B,[ADDRESS]
00/2F:          	
00/2E:          	; WRITE BYTE
00/2E: A080     	STORE	[DBANK],A
00/2F: B900     	STOREF	[B],C
00/30: 3C00     	LOADI	D,0
00/31: AC80     	STORE	[DBANK],D
00/32: AC7F     	STORE	[0X7F],D
00/34:          	
00/33:          	; READ IT BACK AND COMPARE
00/33: A080     	STORE	[DBANK],A
00/34: 9D00     	LOADF	D,[B]
00/35: DB00     	CMP	C,D
00/36: F6DA     	BRZ	0B
00/38:          
00/37:          	; SEND OFF AN ACCESS TO DEVICE 0XF0
00/37:          	; THIS CAN BE CAUGHT BY AN SCOPE
00/37: 80F0     	LOAD	A,[0XF0]
00/39:          
00/38:          	; SET DISPLAY VALUES
00/38: 3407     0:	LOADI	B,BANK
00/39: 9100     1:	LOADF	A,[B]
00/3A: C100     	SHIFTR	A
00/3B: C100     	SHIFTR	A
00/3C: C100     	SHIFTR	A
00/3D: C100     	SHIFTR	A
00/3E: B1FF     	STOREF	[B+0-1],A
00/3F: 7802     	SUBI	C,2
00/40: F5F8     	BRNN	1B
00/42:          	
00/41:          	; DID WE SUCCEED OR FAIL?
00/41: DB00     	CMP	C,D
00/42: F6D3     	BRZ	PASS
00/43: FFBC     	JUMP	FAIL
00/45:          	
00/44:          
00/44:          .BSS
00/44:          
00/00:          	; STATE DATA
00/00: 00       .DEF BYTE		0
00/01: 00       .DEFL BYTE DELTA	0
00/02: 00       .DEF BYTE		0
00/03: 00       .DEFL BYTE TESTVAL	0
00/04: 00       .DEF BYTE		0
00/05: 00       .DEFL BYTE ADDRESS	0
00/06: 00       .DEF BYTE		0
00/07: 00       .DEFL BYTE BANK		0
00/08:          
00/08:          	; TEMP VALUE
00/08: 00       .DEFL BYTE TEMP 	0
