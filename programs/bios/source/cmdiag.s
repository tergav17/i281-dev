; CMDIAG.S
; CODE MEMORY DIAGNOSTIC
; GAVIN TERSTEEG, 2024
; SDMAY24-14

; THIS TEST WILL PARTIALLY EXERCISE CODE MEMORY 
; FOR ALL CMEM LOCATIONS, A SHORT STUB PROGRAM WILL
; BE GENERATED, AND THEN CALLED. THE PROGRAM IS AS
; FOLLOWS:
;
;	LOADI	A,?
;	JUMP	PASS
;
; FOR ALL PERMUTATIONS '?'
;
; SHOULD THE PROGRAM COUNTER OVERFLOW OR REGISTER FAIL
; TO RETURN THE EXPECTED VALUE, AND ERROR WILL BE RECORDED 
;
; SENSE SWITCH FUNCTIONS:
;
; SW0: 0 = RESET AND WAIT ON FAIL, 1 = PRESERVE CONTEXT ON FAIL
; SW1: 0 = HALT ON FAIL, 1 = CONTINUE EXECUTION
; SW2: 0 = INCREMENT CONTEXT AFTER TEST, 1 = RETRY TEST

.BANK 0
.TEXT

	; JUMP TABLE 
	JUMP	FAIL
	JUMP	PASS

	; EITHER THE TEST HAS JUST STARTED OR A PASS HAS FAILED
FAIL:	INPUTD	[TEMP]
	LOAD	C,[TEMP]

	; CHECK FOR INIT
	SHIFTR	C
	BRC	INIT
	
	; CHECK FOR HALT
	SHIFTR	C
	BRNC	FAIL
	
	; DO WE INCREMENT COUNTER OR TRY AGAIN?
	SHIFTR	C
	BRC	ATTEMPT
	JUMP	NEXT
	
	; INITALIZE TEST
INIT:	LOADI	A,0
	STORE	[TESTVAL],A
	STORE	[ADDRESS],A
	STORE	[BANK],A
	STORE	[DELTA],A
	JUMP	NEWBANK
	
	; FIRST, CHECK AND MAKE SURE THAT 'A' MATCHES THE
	; EXPECTED TEST VALUE
PASS:	LOAD	B,[TESTVAL]
	CMP	A,B
	BRNZ	FAIL
	
	; GET THE SWITCH VALUE
	INPUTD	[TEMP]
	LOAD	C,[TEMP]
	SHIFTR	C
	SHIFTR	C
	SHIFTR	C
	BRC	ATTEMPT
	
	; INCREMENT CONTEXT
NEXT:	LOAD	A,[TESTVAL]
	ADDI	A,1
	STORE	[TESTVAL],A
	BRNC	ATTEMPT
	LOAD	A,[ADDRESS]
	ADDI	A,1
	STORE	[ADDRESS],A
	BRNC	ATTEMPT
	
	; NEXT BANK
	LOAD	A,[BANK]
	ADDI	A,1
	STORE	[BANK],A
	
	; FILL BANK WITH NOOP INSTRUCTIONS
NEWBANK:


ATTEMPT:




	; MEMORY AREAS
.BSS

	; STATE DATA
.DEFL BYTE TESTVAL	0,0
.DEFL BYTE ADDRESS	0,0
.DEFL BYTE BANK		0,0
.DEFL BYTE DELTA	0,0


	; TEMP VALUE
.DEFL BYTE TEMP 	0