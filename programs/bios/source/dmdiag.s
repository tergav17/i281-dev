; DMDIAG.S
; DATA MEMORY DIAGNOSTIC
; GAVIN TERSTEEG, 2024
; SDMAY24-14

; THIS TEST WILL EXERCISE DATA MEMORY FOR ALL DATA MEMORY LOCATIONS
; THE GOAL IS TO MAKE SURE THAT ALL WRITES AND READBACKS ARE SANE
; VALUES, NO ATTEMPT AT TESTING DOUBLE WRITES IS MADE
;
; SW0: 0 = RESET AND WAIT ON FAIL, 1 = PRESERVE CONTEXT ON FAIL
; SW1: 0 = HALT ON FAIL, 1 = CONTINUE EXECUTION
; SW2: 0 = INCREMENT CONTEXT AFTER TEST, 1 = RETRY TEST

DBANK	= 0X80

.BANK 0
.TEXT



	; EITHER THE TEST HAS JUST STARTED OR A PASS HAS FAILED
FAIL:	
	LOADI	A,0
	STORE	[DBANK],A

	; GET THE SENSE SWITCHE 
0:	INPUTD	[TEMP]
	LOAD	C,[TEMP]

	; CHECK FOR INIT
	SHIFTR	C
	BRNC	INIT
	
	; CHECK FOR HALT
	SHIFTR	C
	BRNC	0B
	
	; DO WE INCREMENT COUNTER OR TRY AGAIN?
	SHIFTR	C
	BRC	ATTEMPT
	JUMP	NEXT
	
	; INITALIZE TEST
INIT:	LOADI	A,0
	STORE	[DELTA],A
	STORE	[ADDRESS],A
	STORE	[TESTVAL],A
	LOADI	A,1
	STORE	[DBANK],A
	
	; WAIT FOR TEST TO START
0:	INPUTD	[TEMP]
	LOAD	C,[TEMP]
	SHIFTR	C
	BRNC	0B
	
	JUMP	ATTEMPT

	; THE TEST PASSED 
	; MOVE ON TO THE NEXT
PASS:	LOADI	A,0
	STORE	[DBANK],A
	
	; INCREMENT DELTA
	LOAD	B,[DELTA]
	ADDI	B,1
	STORE	[DELTA],B
	
	; INCREMENT TEST VALUE
	LOAD	A,[TESTVAL]
	ADDI	A,1
	STORE	[TESTVAL],A
	BRNZ	ATTEMPT
	
	; INCREMENT ADDRESS
	LOAD	A,[ADDRESS]
	ADDI	A,1
	STORE	[ADDRESS],A
	BRNN	ATTEMPT
	LOADI	A,0
	STORE	[ADDRESS],A
	
	; INCREMENT BANK
	LOAD	A,[BANK]
	ADDI	A,1
	STORE	[BANK],A
	BRNZ	ATTEMPT
	LOADI	A,1
	STORE	[BANK],A

	; DO ATTEMPT
ATTEMPT:LOAD	C,[TESTVAL]
	LOAD	A,[BANK]
	LOAD	B,[ADDRESS]
	
	; WRITE BYTE
	STORE	[DBANK],A
	STOREF	[B],C
	LOADI	D,0
	STORE	[DBANK],D
	STORE	[0X7F],D
	
	; READ IT BACK AND COMPARE
	STORE	[DBANK],A
	LOADF	D,[B]
	CMP	C,D
	BRZ	0B

	; SEND OFF AN ACCESS TO DEVICE 0XF0
	; THIS CAN BE CAUGHT BY AN SCOPE
	LOAD	A,[0XF0]

	; SET DISPLAY VALUES
0:	LOADI	B,CBANK
1:	LOADF	A,[B]
	SHIFTR	A
	SHIFTR	A
	SHIFTR	A
	SHIFTR	A
	STOREF	[B+0-1],A
	SUBI	C,2
	BRNN	1B
	
	; DID WE SUCCEED OR FAIL?
	CMP	C,D
	BRZ	PASS
	JUMP	FAIL
	

.BSS

	; STATE DATA
.DEF BYTE		0
.DEFL BYTE DELTA	0
.DEF BYTE		0
.DEFL BYTE TESTVAL	0
.DEF BYTE		0
.DEFL BYTE ADDRESS	0
.DEF BYTE		0
.DEFL BYTE BANK		0

	; TEMP VALUE
.DEFL BYTE TEMP 	0