; DMDIAG.S
; DATA MEMORY DIAGNOSTIC
; GAVIN TERSTEEG, 2024
; SDMAY24-14

; THIS TEST WILL EXERCISE DATA MEMORY FOR ALL DATA MEMORY LOCATIONS
; THE GOAL IS TO MAKE SURE THAT ALL WRITES AND READBACKS ARE SANE
; VALUES, NO ATTEMPT AT TESTING DOUBLE WRITES IS MADE
;
; SW0: 0 = RESET AND WAIT ON FAIL, 1 = PRESERVE CONTEXT ON FAIL
; SW1: 0 = HALT ON FAIL, 1 = CONTINUE EXECUTION
; SW2: 0 = INCREMENT CONTEXT AFTER TEST, 1 = RETRY TEST

DBANK	= 0X80

.BANK 0
.TEXT

	; JUMP TABLE 
	JUMP	FAIL
	JUMP	PASS

	; EITHER THE TEST HAS JUST STARTED OR A PASS HAS FAILED
	; SEND OFF AN ACCESS TO DEVICE 0XF0
	; THIS CAN BE CAUGHT BY AN SCOPE
FAIL:	LOAD	D,[0XF0]

	; GET THE SENSE SWITCHE 
0:	INPUTD	[TEMP]
	LOAD	C,[TEMP]

	; CHECK FOR INIT
	SHIFTR	C
	BRNC	INIT
	
	; CHECK FOR HALT
	SHIFTR	C
	BRNC	0B
	
	; DO WE INCREMENT COUNTER OR TRY AGAIN?
	SHIFTR	C
	BRC	ATTEMPT
	JUMP	NEXT
	
	; INITALIZE TEST
INIT:	LOADI	A,0
	STORE	[DBANK],A
	STORE	[DELTA],A
	STORE	[ADDRESS],A
	STORE	[TESTVAL],A
	LOADI	A,1
	STORE	[DBANK],A
	
	; WAIT FOR TEST TO START
0:	INPUTD	[TEMP]
	LOAD	C,[TEMP]
	SHIFTR	C
	BRNC	0B
	
	JUMP	NEWBANK

	; START OF TEST
PASS:


	; DO ATTEMPT
	; INCREMENT DELTA
ATTEMPT:LOAD	C,[DELTA]
	ADDI	C,1
	STORE	[DELTA],C

	; SET DISPLAY VALUES
	LOADI	C,CBANK
0:	LOADF	A,[C]
	SHIFTR	A
	SHIFTR	A
	SHIFTR	A
	SHIFTR	A
	STOREF	[C+0-1],A
	SUBI	C,2
	BRNN	0B
	

.BSS

	; STATE DATA
.DEF BYTE		0
.DEFL BYTE DELTA	0
.DEF BYTE		0
.DEFL BYTE TESTVAL	0
.DEF BYTE		0
.DEFL BYTE ADDRESS	0
.DEF BYTE		0
.DEFL BYTE BANK	0

	; TEMP VALUE
.DEFL BYTE TEMP 	0