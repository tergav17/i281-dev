; DMDIAG.S
; DATA MEMORY DIAGNOSTIC
; GAVIN TERSTEEG, 2024
; SDMAY24-14

; THIS TEST WILL EXERCISE DATA MEMORY FOR ALL DATA MEMORY LOCATIONS
; THE GOAL IS TO MAKE SURE THAT ALL WRITES AND READBACKS ARE SANE
; VALUES, NO ATTEMPT AT TESTING DOUBLE WRITES IS MADE
;
; SW0: 0 = RESET AND WAIT ON FAIL, 1 = PRESERVE CONTEXT ON FAIL
; SW1: 0 = HALT ON FAIL, 1 = CONTINUE EXECUTION
; SW2: 0 = INCREMENT CONTEXT AFTER TEST, 1 = RETRY TEST

.BANK 0
.TEXT

	; JUMP TABLE 
	JUMP	FAIL
	JUMP	PASS


	; DO ATTEMPT
	; INCREMENT DELTA
ATTEMPT:LOAD	C,[DELTA]
	ADDI	C,1
	STORE	[DELTA],C

	; SET DISPLAY VALUES
	LOADI	C,CBANK
0:	LOADF	A,[C]
	SHIFTR	A
	SHIFTR	A
	SHIFTR	A
	SHIFTR	A
	STOREF	[C+0-1],A
	SUBI	C,2
	BRNN	0B
	

.BSS

	; STATE DATA
.DEF BYTE		0
.DEFL BYTE DELTA	0
.DEF BYTE		0
.DEFL BYTE TESTVAL	0
.DEF BYTE		0
.DEFL BYTE ADDRESS	0
.DEF BYTE		0
.DEFL BYTE DBANK	0

	; TEMP VALUE
.DEFL BYTE TEMP 	0