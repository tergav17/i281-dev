00/00:          ; CFBURN.S
01/80:          ; COMPACT FLASH BURN-IN PROGRAM
01/80:          ; GAVIN TERSTEEG, 2024
01/80:          ; SDMAY24-14
01/80:          
01/80:          ; COMPACT FLASH CARD REQUIRES 32MB TEST PATTERN IMAGE
01/80:          ; IMAGE IS CREATED WITH 256 * 256 BLOCKS OF INCREMENTING
01/80:          ; NUMBERS
01/80:          ; THE OFFSET FOR EACH BLOCK IS THE LOW BYTE OF THE ADDRESS
01/80:          ; THE INCREMENT PER ADDRESS IS THE HIGH BYTE OF THE ADDRESS
01/80:          
01/80:          ; REQUIRES USE OF BIOS CALLS
01/80:          
01/80:          ; DEFINES
01/80:          DBANK	= 0X80		; DATA BANK ADDRESS 
01/80:          
01/80:          UART	= 0X90		; UART BASE ADDRESS
01/80:          UART_RH	= UART+0X00	; UART READ HOLDING
01/80:          UART_TH	= UART+0X00	; UART TRANSMIT HOLDING
01/80:          UART_DL = UART+0X00	; UART DIVISOR LOW
01/80:          UART_DH = UART+0X01	; UART DIVISOR HIGH
01/80:          UART_LC = UART+0X03	; UART LINE CONTROL
01/80:          UART_LS	= UART+0X05	; UART LINE STATUS
01/80:          SCRATCH	= UART+0X07	; SCRATCH BYTE ADDRESS
01/80:          
01/80:          CF	= 0XA0		; COMPACT FLASH BASE ADDRESS
01/80:          CF_DATA	= CF+0X00	; CF DATA
01/80:          CF_ERR	= CF+0X01	; CF ERROR
01/80:          CF_FEAT	= CF+0x01	; CF FEATURES
01/80:          CF_CNT	= CF+0X02	; CF SECTOR COUNT
01/80:          CF_LBA0	= CF+0X03	; CF LBA BITS 0-7
01/80:          CF_LBA1	= CF+0X04	; CF LBA BITS 8-15
01/80:          CF_LBA2	= CF+0X05	; CF LBA BITS 16-23
01/80:          CF_LBA3	= CF+0X06	; CF LBA BITS 24-27
01/80:          CF_STAT	= CF+0X07	; CF STATUS
01/80:          CF_CMD	= CF+0X07	; CF COMMAND
01/80:          
01/80:          CF_8BIT	= 0X01		; 8 BIT MODE
01/80:          CF_DCAC	= 0X82		; DISABLE CACHE
01/80:          
01/80:          CF_READ	= 0X20		; READ COMMAND
01/80:          CF_SETF	= 0XEF		; SET FEATURE COMMAND
01/80:          .TEXT
01/80:          	; START HERE
01/80:          	; PRINT "HELLO" SPLASH
01/80: 3400     START:	LOADI	B,STRING
01/81: 3883     	LOADI	C,@+2
01/82: FF07     	JUMP	PRINT
01/84:          	
01/83:          	; RESET TEST STATE
01/83: 3000     	LOADI	A,0
01/84: A019     	STORE	[ADDR_LO],A
01/85: A01A     	STORE	[ADDR_HI],A
01/87:          	
01/86:          	; TESTS A BLOCK
01/86: 8019     DOBLK:	LOAD	A,[ADDR_LO]
01/87: A0A3     	STORE	[CF_LBA0],A
01/88: 801A     	LOAD	A,[ADDR_HI]
01/89: A0A4     	STORE	[CF_LBA1],A
01/8B:          
01/8A:          
01/8A:          
01/8A:          
01/8A:          	; PRINT A STRING TO THE CONSOLE
01/8A:          	; B = STRING TO PRINT
01/8A:          	; C = RETURN ADDRESS
01/8A:          	; USES: A, B, C
01/8A: 9100     PRINT:	LOADF	A,[B]
01/8C:          
01/8B:          	; MAKE SURE IT ISNT ZERO
01/8B: 5000     	ADDI	A,0
01/8C: F608     	BRZ	1F
01/8E:          	
01/8D:          	; GET LINE STATUS REGISTER
01/8D: 8895     0:	LOAD	C,[UART_LS]
01/8F:          	
01/8E:          	; READ 5TH BIT TO SEE IF WE CAN TRANSMIT YET
01/8E: 4A00     	SHIFTL	C
01/8F: 4A00     	SHIFTL	C
01/90: 4A00     	SHIFTL	C
01/91: F1FB     	BRNC	0B
01/93:          	
01/92:          	; TRANSMIT BYTE
01/92: A090     	STORE	[UART_TH],A
01/94:          	
01/93:          	; INCREMENT POINTER
01/93: 5401     	ADDI	B,1
01/95:          	
01/94:          	; RETURN TO PRINT LOOP
01/94: FFF5     	JUMP	PRINT
01/96:          	
01/95:          	; AND RETURN
01/95: FE6A     1:	JUMPR	C
01/97:          
01/96:          	; WAIT FOR THE CF CARD TO BECOME READY
01/96:          	; FOR THIS TO HAPPEN, THE BUSY FLAG MUST BE 0
01/96:          	; AND THE READY FLAG MUST BE 1
01/96:          	; IF A CF CARD ISN'T PRESENT, THIS ROUTINE HANGS
01/96:          	; BUT WE DON'T CARE
01/96:          	; C = RETURN ADDRESS
01/96:          	; USES: A
01/96: 80A7     CFWAIT:	LOAD	A,[CF_STAT]
01/98:          
01/97:          	; CHECK BIT 7 (BUSY FLAG)
01/97: 4000     	SHIFTL	A
01/99:          	
01/98:          	; GO BACK TO START BUSY
01/98: F0FD     	BRC	CFWAIT
01/9A:          	
01/99:          	; CHECK BIT 6 (READY FLAG)
01/99: 4000     	SHIFTL	A
01/9B:          	
01/9A:          	; GO BACK TO START IF NOT READY
01/9A: F1FB     	BRNC	CFWAIT
01/9C:          	
01/9B:          	; RETURN FROM FUNCTION CALL
01/9B: FE64     	JUMPR	C
01/9D:          	
01/9C:          
01/9C:          
01/9C:          .DATA
01/9C:          
01/00:          	; HELLO SPLASH
01/00: 0A0D4932
       38312043
       46204255
       524E2D49
       4E205445
       53540A0D
       00       .DEFL BYTE STRING	0x0A,0X0D,"I281 CF BURN-IN TEST",0X0A,0x0D,0
01/19:          	
01/19:          	; TEST STATE
01/19: 00       .DEFL BYTE ADDR_LO	0
01/1A: 00       .DEFL BYTE ADDR_HI	0
01/1B: 00       .DEFL BYTE COUNT	0
