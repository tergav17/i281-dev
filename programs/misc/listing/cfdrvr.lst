00/00:          ; CFDRVR.S
01/80:          ; COMPACT FLASH DRIVER PROGRAM FOR MONITOR
01/80:          ; GAVIN TERSTEEG, 2024
01/80:          ; SDMAY24-14
01/80:          
01/80:          ; DEFINES
01/80:          DBANK	= 0X80		; DATA BANK ADDRESS 
01/80:          
01/80:          UART	= 0X90		; UART BASE ADDRESS
01/80:          UART_RH	= UART+0X00	; UART READ HOLDING
01/80:          UART_TH	= UART+0X00	; UART TRANSMIT HOLDING
01/80:          UART_DL = UART+0X00	; UART DIVISOR LOW
01/80:          UART_DH = UART+0X01	; UART DIVISOR HIGH
01/80:          UART_LC = UART+0X03	; UART LINE CONTROL
01/80:          UART_LS	= UART+0X05	; UART LINE STATUS
01/80:          SCRATCH	= UART+0X07	; SCRATCH BYTE ADDRESS
01/80:          
01/80:          CF	= 0XA0		; COMPACT FLASH BASE ADDRESS
01/80:          CF_DATA	= CF+0X00	; CF DATA
01/80:          CF_ERR	= CF+0X01	; CF ERROR
01/80:          CF_FEAT	= CF+0x01	; CF FEATURES
01/80:          CF_CNT	= CF+0X02	; CF SECTOR COUNT
01/80:          CF_LBA0	= CF+0X03	; CF LBA BITS 0-7
01/80:          CF_LBA1	= CF+0X04	; CF LBA BITS 8-15
01/80:          CF_LBA2	= CF+0X05	; CF LBA BITS 16-23
01/80:          CF_LBA3	= CF+0X06	; CF LBA BITS 24-27
01/80:          CF_STAT	= CF+0X07	; CF STATUS
01/80:          CF_CMD	= CF+0X07	; CF COMMAND
01/80:          
01/80:          CF_8BIT	= 0X01		; 8 BIT MODE
01/80:          CF_DCAC	= 0X82		; DISABLE CACHE
01/80:          
01/80:          CF_READ	= 0X20		; READ COMMAND
01/80:          CF_SETF	= 0XEF		; SET FEATURE COMMAND
01/80:          
01/80:          RETURN	= 0X00		; MONITOR RETURN VECTOR
01/80:          
01/80:          	; JUMP TABLE
01/80: FF00     	JUMP	CFINIT
01/82:          	
01/81:          	
01/81:          	
01/81:          	; WE MUST WAIT FOR THE CF TO BE READY BEFORE SENDING A COMMAND
01/81: 3883     CFINIT:	LOADI	C,@+2
01/82: FF11     	JUMP	CFWAIT
01/84:          
01/83:          	; THE TOP 3 BITS OF LBA3 MUST BE '1' TO INDICATE LBA MODE
01/83: 30E0     	LOADI	A,0XE0
01/84: A0A6     	STORE	[CF_LBA3],A
01/86:          
01/85:          	; START BY SETTING THE CARD TO 8-BIT MODE
01/85: 3887     	LOADI	C,@+2
01/86: FF0D     	JUMP	CFWAIT
01/87: 3001     	LOADI	A,CF_8BIT
01/88: A0A1     	STORE	[CF_FEAT],A
01/89: 30EF     	LOADI	A,CF_SETF
01/8A: A0A7     	STORE	[CF_CMD],A
01/8B: 388D     	LOADI	C,@+2
01/8C: FF07     	JUMP	CFWAIT
01/8E:          	
01/8D:          	; PUNCH IN THE ADDRESS OF THE MBR
01/8D:          	; (MASTER BOOT RECORD)
01/8D: 3400     	LOADI	B,0
01/8E: A4A3     	STORE	[CF_LBA0],B
01/8F: A4A4     	STORE	[CF_LBA1],B
01/90: A4A5     	STORE	[CF_LBA2],B
01/92:          	
01/91:          	; PUT A '1' IN THE SECTOR COUNT REGISTER
01/91: 3001     	LOADI	A,0X01
01/92: A0A2     	STORE	[CF_CNT],A
01/94:          	
01/93:          	; DONE
01/93: FF6C     	JUMP	RETURN
01/95:          	
01/94:          	
01/94:          	
01/94:          	; WAIT FOR THE CF CARD TO BECOME READY
01/94:          	; FOR THIS TO HAPPEN, THE BUSY FLAG MUST BE 0
01/94:          	; AND THE READY FLAG MUST BE 1
01/94:          	; IF A CF CARD ISN'T PRESENT, THIS ROUTINE HANGS
01/94:          	; BUT WE DON'T CARE
01/94:          	; USES: A
01/94: 80A7     CFWAIT:	LOAD	A,[CF_STAT]
01/96:          
01/95:          	; CHECK BIT 7 (BUSY FLAG)
01/95: 4000     	SHIFTL	A
01/97:          	
01/96:          	; GO BACK TO START BUSY
01/96: F0FD     	BRC	CFWAIT
01/98:          	
01/97:          	; CHECK BIT 6 (READY FLAG)
01/97: 4000     	SHIFTL	A
01/99:          	
01/98:          	; GO BACK TO START IF NOT READY
01/98: F1FB     	BRNC	CFWAIT
01/9A:          	
01/99:          	; RETURN FROM FUNCTION CALL
01/99: FE66     	JUMPR	C
